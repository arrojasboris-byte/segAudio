<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Center Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- XLSX para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      --kpi-blue: #60a5fa;
      --kpi-purple: #a855f7;
      --kpi-teal: #22c55e;
      --kpi-yellow: #eab308;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
    }

    body.light {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
    }

    /* SIDEBAR */
    .sidebar {
      width: 250px;
      background: #020617;
      border-right: 1px solid #020617;
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      color: #e5e7eb;
    }
    body.light .sidebar {
      background: #020617; /* fald√≥n siempre oscuro */
      color: #e5e7eb;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red));
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: #9ca3af;
    }

    .section-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .12em;
      margin-bottom: 8px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .88rem;
      color: #9ca3af;
      cursor: pointer;
      transition: all .18s ease;
    }

    .nav-item span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }

    .nav-item.active {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
    }

    .nav-item.active span.icon {
      background: rgba(15,23,42,.2);
    }

    .nav-item:hover:not(.active) {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: #9ca3af;
    }

    /* MAIN */
    .main {
      flex: 1;
      padding: 10px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 100vh;
      overflow: hidden;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .topbar-actions {
      display: flex;
      gap: 10px;
    }

    .search-global {
      flex: 1;
      position: relative;
    }

    .search-global input {
      width: 100%;
      background: #020617;
      border-radius: 999px;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      font-size: .86rem;
      outline: none;
    }

    body.light .search-global input {
      background: #ffffff;
    }

    .search-global .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .8rem;
      color: var(--text-muted);
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #020617;
      color: #e5e7eb;
      white-space: nowrap;
      box-shadow: none;
    }
    body.light .btn {
      background: #ffffff;
      color: #111827;
    }

    .btn-cta {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
      border-color: transparent;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    #themeToggle {
      min-width: 110px;
      justify-content: center;
    }

    /* SECTIONS */
    .section {
      flex: 1;
      border-radius: 14px;
      background: transparent;
      overflow: hidden;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .section.active {
      display: flex;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .card h3 {
      font-size: .95rem;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: .72rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    /* DASHBOARD */
    #dashboardSection {
      overflow-y: auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .dashboard-header h1 {
      font-size: 1.1rem;
    }

    .dashboard-filters {
      display: grid;
      grid-template-columns: 1.5fr 1.5fr;
      gap: 10px;
      margin-bottom: 8px;
    }

    .filter-card {
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-card label {
      font-size: .8rem;
      color: var(--text-muted);
    }

    .filter-card select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--text-main);
      font-size: .8rem;
      outline: none;
    }
    body.light .filter-card select {
      background: #ffffff;
      color: #111827;
    }

    .dashboard-kpis {
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .kpi-card {
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: .78rem;
    }

    .kpi-label {
      color: var(--text-muted);
    }
    .kpi-value {
      font-size: 1rem;
      font-weight: 700;
    }
    .kpi-extra {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .dashboard-main {
      display: grid;
      grid-template-columns: 2.2fr 1fr;
      gap: 10px;
      min-height: 0;
      flex: 1;
    }

    .dashboard-charts {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-auto-rows: 190px;
      gap: 8px;
    }

    .dashboard-charts .card {
      padding: 8px;
    }

    .dashboard-charts canvas {
      width: 100%;
      height: 100%;
    }

    .ranking-card {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ranking-list {
      margin-top: 4px;
      overflow-y: auto;
      max-height: 420px;
      padding-right: 2px;
    }

    .ranking-item {
      font-size: .78rem;
      margin-bottom: 6px;
    }

    .ranking-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .ranking-bar-bg {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid var(--border-soft);
    }

    .ranking-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
    }

    /* CENTROS */
    #centrosSection {
      overflow-y: hidden;
    }

    .centros-top {
      display: grid;
      grid-template-columns: 1.2fr 1.5fr 1.3fr;
      gap: 10px;
      min-height: 250px;
    }

    .delegados-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .delegados-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .delegados-list-outer {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .delegado-item {
      padding: 6px 6px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      margin-bottom: 4px;
      cursor: pointer;
    }

    .delegado-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: .8rem;
    }

    .delegado-pill-color {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .delegado-bar-bg {
      margin-top: 4px;
      height: 4px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid var(--border-soft);
      overflow: hidden;
    }

    .delegado-bar-fill {
      height: 100%;
      width: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #4ade80, #22c55e);
    }

    .delegados-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .calendar-card {
      position: relative;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .calendar-nav {
      display: flex;
      gap: 4px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: .78rem;
    }

    .calendar-day-name {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .calendar-cell {
      min-height: 55px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #020617;
      padding: 3px 4px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    body.light .calendar-cell {
      background: #ffffff;
    }

    .calendar-cell.disabled {
      opacity: 0.25;
      cursor: default;
    }

    .calendar-date {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .calendar-badge {
      font-size: .7rem;
      align-self: flex-end;
      padding: 2px 4px;
      border-radius: 999px;
      background: rgba(234,179,8,.15);
      color: #eab308;
    }

    .visitas-card {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .visitas-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: .78rem;
    }

    .visita-item {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 4px 6px;
      margin-bottom: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .visita-main-line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .visita-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: .72rem;
      color: var(--text-muted);
    }

    .pill-estado {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: .7rem;
      border: 1px solid var(--border-soft);
    }
    .estado-pendiente {
      background: rgba(234,179,8,.14);
      color: #eab308;
    }
    .estado-proceso {
      background: rgba(34,197,94,.14);
      color: #4ade80;
    }
    .estado-finalizada {
      background: rgba(22,163,74,.3);
      color: #bbf7d0;
    }
    .estado-anulada {
      background: rgba(248,113,113,.15);
      color: #f97373;
    }

    .centros-table-wrapper {
      flex: 1;
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-height: 0;
      margin-top: 8px;
    }

    .centros-table-header {
      padding: 6px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .8rem;
    }

    .centros-table-scroll {
      flex: 1;
      overflow: auto;
      border-top: 1px solid var(--border-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 2;
    }
    body.light thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #0b1120;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: .75rem;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }
    body.light tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.9);
    }
    body.light tbody tr:hover {
      background: #e5e7eb;
    }

    .tag {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: .7rem;
      border: 1px solid var(--border-soft);
      background: #0b1120;
    }

    .tag.exclusivo {
      background: rgba(22,163,74,0.15);
      color: var(--accent-green);
      border-color: rgba(22,163,74,0.7);
    }

    .tag.corner {
      background: rgba(37,99,235,0.15);
      color: var(--accent-blue);
      border-color: rgba(37,99,235,0.7);
    }

    .btn-link {
      border: none;
      background: transparent;
      color: var(--accent-blue);
      cursor: pointer;
      font-size: .74rem;
      text-decoration: underline;
    }

    /* MODAL GENERAL */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #020617;
      border-radius: 14px;
      padding: 14px;
      width: 420px;
      max-width: 95%;
      border: 1px solid var(--border-soft);
    }

    body.light .modal {
      background: #ffffff;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      font-size: .95rem;
    }

    .modal-close {
      cursor: pointer;
      font-size: 1rem;
      color: var(--text-muted);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: .78rem;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-field label {
      font-size: .74rem;
      color: var(--text-muted);
    }

    .modal-field input,
    .modal-field select {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #0b1120;
      color: var(--text-main);
      font-size: .78rem;
      outline: none;
    }
    body.light .modal-field input,
    body.light .modal-field select {
      background: #f9fafb;
      color: #111827;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    /* INFORME VISITA */
    #informeSection {
      overflow-y: auto;
    }

    #informePrintWrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .informe-header-row {
      display: grid;
      grid-template-columns: 2fr 1.7fr;
      gap: 10px;
    }

    .informe-datos-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      font-size: .8rem;
    }

    .dato-line {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .dato-label {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .dato-value input {
      width: 100%;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #0b1120;
      color: var(--text-main);
      font-size: .78rem;
      outline: none;
    }
    body.light .dato-value input {
      background: #f9fafb;
      color: #111827;
    }

    .checklist-info {
      font-size: .75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .informe-kpi-row {
      display: grid;
      grid-template-columns: 1.6fr 1.2fr;
      gap: 10px;
    }

    .informe-kpi-row canvas {
      width: 100%;
      height: 200px;
    }

    .informe-mid-row {
      display: grid;
      grid-template-columns: 1.4fr 1.6fr;
      gap: 10px;
    }

    .formaciones-list {
      font-size: .78rem;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .formaciones-list label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .imagenes-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .imagen-slot {
      border-radius: 12px;
      border: 1px dashed #4b5563;
      background: #020617;
      min-height: 130px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      font-size: .8rem;
      text-align: center;
    }
    body.light .imagen-slot {
      background: #ffffff;
    }

    .imagen-slot span {
      color: var(--text-muted);
    }

    .imagen-slot input {
      display: none;
    }

    .imagen-preview {
      max-width: 100%;
      max-height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }

    .informe-resumen-row {
      display: grid;
      grid-template-columns: 1.5fr 1.5fr;
      gap: 10px;
    }

    .resumen-charts {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 8px;
      align-items: center;
    }

    .resumen-charts canvas {
      width: 100%;
      height: 180px;
    }

    .resumen-textos {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      grid-template-rows: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    .resumen-textos textarea {
      width: 100%;
      height: 90px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--text-main);
      font-size: .78rem;
      padding: 6px;
      outline: none;
    }
    body.light .resumen-textos textarea {
      background: #ffffff;
      color: #111827;
    }

    .textarea-label {
      font-size: .78rem;
      margin-bottom: 2px;
    }

    .informe-footer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    /* CHECKLIST PRINT WRAPPER */
    #checklistPrintWrapper {
      margin-top: 12px;
    }

    /* PRINT */
    @media print {
      body {
        background: #ffffff;
        color: #111827;
        overflow: visible;
      }

      .sidebar,
      .topbar {
        display: none !important;
      }

      .section {
        display: none !important;
      }

      #informeSection {
        display: block !important;
        overflow: visible;
      }

      @page {
        size: A4;
        margin: 10mm;
      }

      #informePrintWrapper {
        page-break-after: always;
      }

      .card {
        background: #ffffff;
        border-color: #d1d5db;
      }

      .btn,
      .btn-cta {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>

    <div>
      <div class="section-title">Secciones</div>
      <nav class="nav-list">
        <div class="nav-item active" data-section="dashboardSection">
          <span class="icon">üìä</span> Dashboard
        </div>
        <div class="nav-item" data-section="centrosSection">
          <span class="icon">üè¢</span> Centros
        </div>
        <div class="nav-item" data-section="informeSection">
          <span class="icon">üìù</span> Informe de la visita
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      Versi√≥n demo ¬∑ Datos ficticios
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <div class="search-global">
        <span class="search-icon">üîç</span>
        <input placeholder="Buscar por centro, propietario o delegado..." />
      </div>
      <div class="topbar-actions">
        <button class="btn" id="themeToggle">
          <span class="icon">üåì</span> Oscuro / Claro
        </button>
        <button class="btn" id="btnGuardarVista">
          <span class="icon">üíæ</span> Guardar vista
        </button>
        <button class="btn btn-cta" id="btnExportarHTML">
          <span class="icon">‚¨áÔ∏è</span> Exportar HTML
        </button>
        <button class="btn btn-cta" id="btnImprimir">
          <span class="icon">üñ®</span> Imprimir
        </button>
        <button class="btn btn-cta">
          <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
        </button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboardSection" class="section active">
      <div class="dashboard-header">
        <h1>Dashboard</h1>
      </div>

      <div class="dashboard-filters">
        <div class="filter-card">
          <label for="filtroDelegado">Filtro por delegado</label>
          <select id="filtroDelegado">
            <option value="todos">Todos los delegados</option>
            <option>Blanca Fdez. de la Pradilla</option>
            <option>Sergio Per√°n</option>
            <option>Daniel Chazo</option>
            <option>Sonia Godino</option>
            <option>Eneritz ARANGUREN</option>
            <option>Marisa Carmona</option>
          </select>
        </div>
        <div class="filter-card">
          <label for="filtroCentro">Filtro por centro</label>
          <select id="filtroCentro">
            <option value="todos">Todos los centros</option>
            <option>PAMPLONA C. Exclusivo</option>
            <option>REINA DE MERCEDES</option>
            <option>SANTANDER CC PE√ëACASTILLO</option>
          </select>
        </div>
      </div>

      <!-- KPIs -->
      <div class="dashboard-kpis">
        <div class="kpi-card">
          <div class="kpi-label">% Procesos</div>
          <div class="kpi-value" id="kpiProcesos">82%</div>
          <div class="kpi-extra">Objetivo 85‚Äì100%</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Conv. a prueba</div>
          <div class="kpi-value" id="kpiPrueba">78%</div>
          <div class="kpi-extra">Objetivo 80%</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Conv. a venta</div>
          <div class="kpi-value" id="kpiVenta">72%</div>
          <div class="kpi-extra">Objetivo 80%</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">% Formaciones</div>
          <div class="kpi-value" id="kpiFormaciones">65%</div>
          <div class="kpi-extra">Media de m√≥dulos</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Ayuda / Telecare</div>
          <div class="kpi-value" id="kpiAyuda">70%</div>
          <div class="kpi-extra">Telecare / PIA / Telehear</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">% AAR</div>
          <div class="kpi-value" id="kpiAAR">55%</div>
          <div class="kpi-extra">Centros con AAR</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">% Primeros auxilios</div>
          <div class="kpi-value" id="kpi1osAux">68%</div>
          <div class="kpi-extra">Equipos formados</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Visitas registradas</div>
          <div class="kpi-value" id="kpiVisitas">0</div>
          <div class="kpi-extra">En el periodo</div>
        </div>
      </div>

      <div class="dashboard-main">
        <div class="dashboard-charts">
          <div class="card">
            <h3>Radar general</h3>
            <canvas id="radarGeneral"></canvas>
          </div>
          <div class="card">
            <h3>Procesos y √°reas de mejora por mes</h3>
            <canvas id="chartProcesosAreasMes"></canvas>
          </div>
          <div class="card">
            <h3>√Åreas de mejora por mes</h3>
            <canvas id="chartAreasMes"></canvas>
          </div>
          <div class="card">
            <h3>Primeros auxilios por mes</h3>
            <canvas id="chartAuxilios"></canvas>
          </div>
          <div class="card">
            <h3>Top 10 √°reas de mejora</h3>
            <canvas id="chartTopAreas"></canvas>
          </div>
          <div class="card">
            <h3>Aplicaci√≥n AAR / HIT</h3>
            <canvas id="chartAARHIT"></canvas>
          </div>
        </div>

        <div class="card ranking-card">
          <h3>Ranking de delegados</h3>
          <div class="card-sub">Barras por KPI global (demo).</div>
          <div class="ranking-list" id="rankingDelegados"></div>
        </div>
      </div>
    </section>

    <!-- CENTROS -->
    <section id="centrosSection" class="section">
      <div class="centros-top">
        <!-- Delegados -->
        <article class="card delegados-container">
          <div class="delegados-header-line">
            <h3>Centros y delegados</h3>
            <span id="contadorDelegados" class="badge-small"></span>
          </div>
          <div class="delegados-list-outer" id="delegadosList"></div>
          <div class="delegados-actions">
            <button class="btn btn-cta" id="btnAddCentro">
              <span class="icon">‚ûï</span> A√±adir centro
            </button>
            <button class="btn" id="btnAdjuntarExcelCentros">
              <span class="icon">üì§</span> Adjuntar centros (Excel)
            </button>
            <input type="file" id="inputExcelCentros" accept=".xlsx,.xls" style="display:none" />
          </div>
        </article>

        <!-- Calendario -->
        <article class="card calendar-card">
          <div class="calendar-header">
            <h3 id="calendarTitle">Diciembre 2025</h3>
            <div class="calendar-nav">
              <button class="btn" id="calPrev"><span class="icon">‚óÄ</span></button>
              <button class="btn" id="calNext"><span class="icon">‚ñ∂</span></button>
            </div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </article>

        <!-- Visitas -->
        <article class="card visitas-card">
          <h3>Visitas agendadas</h3>
          <div class="visitas-list" id="visitasList"></div>
        </article>
      </div>

      <!-- Tabla de centros -->
      <section class="centros-table-wrapper">
        <div class="centros-table-header">
          <div>
            <strong>Listado de centros</strong>
          </div>
          <span id="labelCentrosMostrados" class="badge-small"></span>
        </div>
        <div class="centros-table-scroll">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Propietario</th>
                <th>Centro</th>
                <th>Provincia</th>
                <th>Delegado</th>
                <th>Tipo</th>
                <th>Informe</th>
              </tr>
            </thead>
            <tbody id="tablaCentrosBody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- INFORME DE LA VISITA -->
    <section id="informeSection" class="section">
      <div id="informePrintWrapper">
        <!-- Cabecera datos + checklist -->
        <div class="informe-header-row">
          <article class="card">
            <h3>Datos del centro</h3>
            <div class="informe-datos-grid">
              <div class="dato-line">
                <span class="dato-label">Centro</span>
                <div class="dato-value"><input id="infCentro" /></div>
              </div>
              <div class="dato-line">
                <span class="dato-label">Provincia</span>
                <div class="dato-value"><input id="infProvincia" /></div>
              </div>
              <div class="dato-line">
                <span class="dato-label">Delegado</span>
                <div class="dato-value"><input id="infDelegado" /></div>
              </div>
              <div class="dato-line">
                <span class="dato-label">Tipo</span>
                <div class="dato-value"><input id="infTipo" /></div>
              </div>
              <div class="dato-line">
                <span class="dato-label">Responsable audio</span>
                <div class="dato-value"><input id="infRespAudio" /></div>
              </div>
              <div class="dato-line">
                <span class="dato-label">Fecha visita</span>
                <div class="dato-value"><input id="infFecha" /></div>
              </div>
              <div class="dato-line">
                <span class="dato-label">Audi√≥logo</span>
                <div class="dato-value"><input id="infAudiologo" /></div>
              </div>
              <div class="dato-line">
                <span class="dato-label">Horas de servicio</span>
                <div class="dato-value"><input id="infHoras" /></div>
              </div>
            </div>
          </article>

          <article class="card">
            <h3>Checklist de visita</h3>
            <p class="card-sub">
              Adjunta el checklist del centro (Corner o Exclusivo). El informe usar√° sus datos para calcular KPIs y √°reas de mejora.
            </p>
            <input type="file" id="inputChecklist" accept=".xlsx,.xls" />
            <div class="checklist-info" id="checklistInfo">
              Ning√∫n checklist adjunto.
            </div>
          </article>
        </div>

        <!-- KPIs + radar -->
        <div class="informe-kpi-row">
          <article class="card">
            <h3>KPIs del centro</h3>
            <canvas id="chartKpisCentro"></canvas>
          </article>
          <article class="card">
            <h3>Radar del centro</h3>
            <canvas id="chartRadarCentro"></canvas>
          </article>
        </div>

        <!-- Formaciones + im√°genes -->
        <div class="informe-mid-row">
          <article class="card">
            <h3>Formaciones y habilidades</h3>
            <div class="formaciones-list" id="formacionesList">
              <!-- checkboxes -->
            </div>
          </article>
          <article class="card">
            <h3>Im√°genes del centro</h3>
            <div class="imagenes-grid">
              <div class="imagen-slot" data-target="ext">
                <strong>Centro exterior</strong>
                <span>Adjuntar imagen</span>
                <img class="imagen-preview" id="previewExt" style="display:none" />
                <input type="file" accept="image/*" />
              </div>
              <div class="imagen-slot" data-target="int">
                <strong>Centro interior</strong>
                <span>Adjuntar imagen</span>
                <img class="imagen-preview" id="previewInt" style="display:none" />
                <input type="file" accept="image/*" />
              </div>
              <div class="imagen-slot" data-target="gab">
                <strong>Gabinete</strong>
                <span>Adjuntar imagen</span>
                <img class="imagen-preview" id="previewGab" style="display:none" />
                <input type="file" accept="image/*" />
              </div>
            </div>
          </article>
        </div>

        <!-- Resumen visita -->
        <div class="informe-resumen-row">
          <article class="card">
            <h3>Resumen de la visita</h3>
            <div class="resumen-charts">
              <canvas id="chartResumenProcesos"></canvas>
              <canvas id="chartResumenAreas"></canvas>
              <canvas id="chartResumenConv"></canvas>
            </div>
          </article>
          <article class="card">
            <h3>Observaciones, recomendaciones y compromisos</h3>
            <div class="resumen-textos">
              <div>
                <div class="textarea-label">Observaciones</div>
                <textarea id="txtObservaciones"></textarea>
              </div>
              <div>
                <div class="textarea-label">Recomendaciones</div>
                <textarea id="txtRecomendaciones"></textarea>
              </div>
              <div>
                <div class="textarea-label">Compromisos</div>
                <textarea id="txtCompromisos"></textarea>
              </div>
            </div>
          </article>
        </div>

        <div class="informe-footer-actions">
          <button class="btn btn-cta" id="btnGuardarInforme">
            <span class="icon">üíæ</span> Guardar informe
          </button>
        </div>
      </div>

      <!-- Segunda p√°gina: checklist -->
      <div id="checklistPrintWrapper">
        <h3>Checklist adjunto</h3>
        <div id="checklistTablaCont">
          <p style="font-size:.8rem;color:var(--text-muted);">
            No se ha adjuntado checklist en esta visita.
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL VISITA -->
  <div class="modal-backdrop" id="modalVisita">
    <div class="modal">
      <div class="modal-header">
        <h3>Agendar visita</h3>
        <span class="modal-close" data-close="modalVisita">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>Fecha seleccionada</label>
          <input id="visitaFecha" readonly />
        </div>
        <div class="modal-field">
          <label>Responsable de Audio</label>
          <select id="visitaRespAudio">
            <option value="Ariannys Rojas">Ariannys Rojas</option>
            <option value="Sonia Guasque">Sonia Guasque</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Centro</label>
          <input id="visitaCentro" list="centrosDatalist" />
          <datalist id="centrosDatalist"></datalist>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalVisita">Cancelar</button>
        <button class="btn btn-cta" id="btnGuardarVisita">Guardar visita</button>
      </div>
    </div>
  </div>

  <script>
    /***** UTILIDADES *****/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function toggleSection(id) {
      $$('.section').forEach(s => s.classList.remove('active'));
      $('#' + id).classList.add('active');
      $$('.nav-item').forEach(n => {
        n.classList.toggle('active', n.dataset.section === id);
      });
    }

    /***** TEMA *****/
    $('#themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('light');
    });

    /***** NAVEGACI√ìN *****/
    $$('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        toggleSection(item.dataset.section);
      });
    });

    /***** EXPORTAR HTML (descarga el archivo actual) *****/
    $('#btnExportarHTML').addEventListener('click', () => {
      const blob = new Blob([document.documentElement.outerHTML], {type: "text/html;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "control-center-audio.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    /***** IMPRIMIR: siempre imprime Informe de visita + checklist *****/
    $('#btnImprimir').addEventListener('click', () => {
      toggleSection('informeSection');
      window.print();
    });

    /***** DATOS DEMO CENTROS *****/
    const centrosData = [
      {codigo:"4ABB", propietario:"MAZA Oriol", centro:"PAMPLONA C. Exclusivo", provincia:"NAVARRA", delegado:"Sonia Godino", tipo:"Exclusivo"},
      {codigo:"4AFH", propietario:"MAZA Oriol", centro:"PAMPLONA Calle Sancho el Mayor", provincia:"NAVARRA", delegado:"Sonia Godino", tipo:"Corner"},
      {codigo:"4AWQ", propietario:"MAZA Oriol", centro:"PAMPLONA Carlos III", provincia:"NAVARRA", delegado:"Sonia Godino", tipo:"Corner"},
      {codigo:"4MRM", propietario:"AAO", centro:"REINA DE MERCEDES", provincia:"Madrid", delegado:"Sergio Per√°n", tipo:"Exclusivo"},
      {codigo:"4PEC", propietario:"AAO", centro:"SANTANDER CC PE√ëACASTILLO", provincia:"Santander", delegado:"Sergio Per√°n", tipo:"Exclusivo"},
      {codigo:"4AXF", propietario:"URRUTIA Esteban", centro:"SANTIAGO DE COMPOSTELA RUA DA ROSA", provincia:"A Coru√±a", delegado:"Daniel Chazo", tipo:"Exclusivo"},
      {codigo:"4TOL", propietario:"AAO", centro:"TORRELAVEGA CARREFOUR CC", provincia:"Santander", delegado:"Sergio Per√°n", tipo:"Corner"},
      {codigo:"4ZDE", propietario:"AAO", centro:"ZARAGOZA CALLE DELICIAS", provincia:"ZARAGOZA", delegado:"ENERITZ ARANGUREN", tipo:"Exclusivo"},
      {codigo:"4AKI", propietario:"PIEDRAFITA Rocio", centro:"CC LOS VALLES", provincia:"MADRID", delegado:"Blanca Fdez. de la Pradilla", tipo:"Exclusivo"},
      {codigo:"4MLG", propietario:"AAO", centro:"FUENLABRADA Calle Leganes", provincia:"MADRID", delegado:"Marisa Carmona", tipo:"Exclusivo"}
    ];

    const delegadosColores = {
      "Blanca Fdez. de la Pradilla": "#ec4899",
      "Marisa Carmona": "#eab308",
      "Sonia Godino": "#22d3ee",
      "Sergio Per√°n": "#fb7185",
      "Daniel Chazo": "#a855f7",
      "ENERITZ ARANGUREN": "#22c55e"
    };

    const visitas = []; // {id, fechaISO, centro, delegado, respAudio, estado, tieneInforme}

    /***** RENDER CENTROS *****/
    const tablaCentrosBody = $('#tablaCentrosBody');
    const labelCentrosMostrados = $('#labelCentrosMostrados');

    function renderTablaCentros() {
      tablaCentrosBody.innerHTML = "";
      centrosData.forEach(c => {
        const tr = document.createElement('tr');
        const tipoTag = `<span class="tag ${c.tipo === 'Exclusivo' ? 'exclusivo':'corner'}">${c.tipo}</span>`;
        tr.innerHTML = `
          <td>${c.codigo}</td>
          <td>${c.propietario}</td>
          <td>${c.centro}</td>
          <td>${c.provincia}</td>
          <td>${c.delegado}</td>
          <td>${tipoTag}</td>
          <td><button class="btn-link" data-crear-informe="${c.centro}">Crear informe</button></td>
        `;
        tablaCentrosBody.appendChild(tr);
      });
      labelCentrosMostrados.textContent = `Centros mostrados: ${centrosData.length} / ${centrosData.length}`;
      actualizarDatalistCentros();
      actualizarDelegados();
    }

    renderTablaCentros();

    /***** DELEGADOS *****/
    const delegadosList = $('#delegadosList');
    const contadorDelegados = $('#contadorDelegados');

    function actualizarDelegados() {
      const mapa = new Map();
      centrosData.forEach(c => {
        mapa.set(c.delegado, (mapa.get(c.delegado) || 0) + 1);
      });
      delegadosList.innerHTML = "";
      const entries = Array.from(mapa.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
      entries.forEach(([nombre, count]) => {
        const div = document.createElement('div');
        div.className = 'delegado-item';
        const color = delegadosColores[nombre] || '#60a5fa';
        div.innerHTML = `
          <div class="delegado-item-header">
            <div><span class="delegado-pill-color" style="background:${color}"></span>${nombre}</div>
            <div>${count} centros</div>
          </div>
          <div class="delegado-bar-bg">
            <div class="delegado-bar-fill" style="background:${color}"></div>
          </div>
        `;
        div.addEventListener('click', () => filtrarPorDelegado(nombre));
        delegadosList.appendChild(div);
      });
      contadorDelegados.textContent = `${entries.length} delegados`;
    }

    function filtrarPorDelegado(nombre) {
      // Solo resalta visualmente; la l√≥gica avanzada se puede a√±adir despu√©s.
      alert(`Filtro por delegado: ${nombre} (en demo solo resalta, no filtra tabla a√∫n).`);
    }

    /***** CALENDARIO *****/
    const calendarGrid = $('#calendarGrid');
    const calendarTitle = $('#calendarTitle');
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    const dayNames = ['L','M','X','J','V','S','D'];

    function renderCalendar() {
      calendarGrid.innerHTML = "";
      const firstDay = new Date(currentYear, currentMonth, 1);
      const startDay = (firstDay.getDay() + 6) % 7; // lunes=0
      const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
      const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      calendarTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;

      // nombres
      dayNames.forEach(d => {
        const span = document.createElement('div');
        span.className = 'calendar-day-name';
        span.textContent = d;
        calendarGrid.appendChild(span);
      });

      const totalCells = 42;
      for (let i=0;i<totalCells;i++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        const dateNum = i - startDay + 1;
        if (dateNum < 1 || dateNum > daysInMonth) {
          cell.classList.add('disabled');
        } else {
          const dateStr = String(dateNum).padStart(2,'0');
          const fechaISO = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${dateStr}`;
          const divDate = document.createElement('div');
          divDate.className = 'calendar-date';
          divDate.textContent = dateNum;
          cell.appendChild(divDate);

          // visitas en ese d√≠a
          const visitasDia = visitas.filter(v => v.fechaISO === fechaISO);
          if (visitasDia.length) {
            const span = document.createElement('div');
            span.className = 'calendar-badge';
            // A o S seg√∫n responsable de la √∫ltima
            const last = visitasDia[visitasDia.length-1];
            const inicial = last.respAudio.startsWith('A') ? 'A' : 'S';
            span.textContent = `${inicial} ‚Ä¢ ${visitasDia.length}`;
            cell.appendChild(span);
          }

          cell.addEventListener('click', () => abrirModalVisita(fechaISO));
        }
        calendarGrid.appendChild(cell);
      }
    }

    $('#calPrev').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    });
    $('#calNext').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    });

    renderCalendar();

    /***** MODAL VISITA *****/
    function abrirModalVisita(fechaISO) {
      $('#visitaFecha').value = fechaISO;
      $('#modalVisita').style.display = 'flex';
    }
    function cerrarModalVisita() {
      $('#modalVisita').style.display = 'none';
    }
    $$('#modalVisita [data-close="modalVisita"]').forEach(el=>{
      el.addEventListener('click', cerrarModalVisita);
    });

    function actualizarDatalistCentros() {
      const dl = $('#centrosDatalist');
      dl.innerHTML = "";
      centrosData.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.centro;
        dl.appendChild(opt);
      });
    }
    actualizarDatalistCentros();

    $('#btnGuardarVisita').addEventListener('click', () => {
      const fechaISO = $('#visitaFecha').value;
      const resp = $('#visitaRespAudio').value;
      const centroNombre = $('#visitaCentro').value.trim();
      if (!centroNombre) {
        alert("Indica un centro para la visita.");
        return;
      }
      const centro = centrosData.find(c => c.centro === centroNombre);
      const delegado = centro ? centro.delegado : "N/D";
      const id = Date.now().toString();
      visitas.push({
        id,
        fechaISO,
        centro: centroNombre,
        delegado,
        respAudio: resp,
        estado: "Pendiente",
        tieneInforme: false
      });
      cerrarModalVisita();
      renderCalendar();
      renderVisitas();
      actualizarKpiVisitas();
    });

    /***** VISITAS LIST *****/
    const visitasList = $('#visitasList');

    function renderVisitas() {
      visitasList.innerHTML = "";
      if (!visitas.length) {
        visitasList.innerHTML = `<p style="font-size:.78rem;color:var(--text-muted)">No hay visitas agendadas para este periodo.</p>`;
        return;
      }
      visitas.sort((a,b)=>a.fechaISO.localeCompare(b.fechaISO));
      visitas.forEach(v => {
        const div = document.createElement('div');
        div.className = 'visita-item';
        const estadoClass = v.estado === 'Pendiente' ? 'estado-pendiente'
                          : v.estado === 'En proceso' ? 'estado-proceso'
                          : v.estado === 'Finalizada' ? 'estado-finalizada'
                          : 'estado-anulada';
        div.innerHTML = `
          <div class="visita-main-line">
            <div>${v.fechaISO} ¬∑ ${v.centro}</div>
            <div class="pill-estado ${estadoClass}">${v.estado}</div>
          </div>
          <div class="visita-meta">
            <span>Del.: ${v.delegado}</span>
            <span>Resp. audio: ${v.respAudio}</span>
          </div>
          <div class="visita-meta">
            <button class="btn-link" data-crear-inf="${v.id}">${v.tieneInforme ? 'Revisar informe':'Crear informe'}</button>
            <button class="btn-link" data-cambiar-estado="${v.id}">Cambiar estado</button>
          </div>
        `;
        visitasList.appendChild(div);
      });
    }

    function actualizarKpiVisitas() {
      $('#kpiVisitas').textContent = visitas.length.toString();
    }

    renderVisitas();
    actualizarKpiVisitas();

    // cambiar estado (ciclo)
    document.addEventListener('click', e => {
      if (e.target.matches('[data-cambiar-estado]')) {
        const id = e.target.dataset.cambiarEstado;
        const v = visitas.find(x => x.id === id);
        if (!v) return;
        const orden = ["Pendiente","En proceso","Finalizada","Anulada"];
        const idx = orden.indexOf(v.estado);
        v.estado = orden[(idx+1) % orden.length];
        renderVisitas();
        renderCalendar();
      }
    });

    // crear informe desde visita
    document.addEventListener('click', e => {
      if (e.target.matches('[data-crear-inf]')) {
        const id = e.target.dataset.crearInf;
        const v = visitas.find(x => x.id === id);
        if (!v) return;
        rellenarInformeDesdeVisita(v);
        v.estado = "En proceso";
        v.tieneInforme = true;
        renderVisitas();
        renderCalendar();
      }
    });

    // crear informe desde tabla centros
    document.addEventListener('click', e => {
      if (e.target.matches('[data-crear-informe]')) {
        const centroNombre = e.target.dataset.crearInforme;
        const centro = centrosData.find(c => c.centro === centroNombre);
        const hoy = new Date();
        const fechaISO = hoy.toISOString().slice(0,10);
        const id = Date.now().toString();
        const visita = {
          id,
          fechaISO,
          centro: centroNombre,
          delegado: centro ? centro.delegado : "N/D",
          respAudio: "Ariannys Rojas",
          estado: "En proceso",
          tieneInforme: true
        };
        visitas.push(visita);
        renderVisitas();
        renderCalendar();
        actualizarKpiVisitas();
        rellenarInformeDesdeVisita(visita);
      }
    });

    function rellenarInformeDesdeVisita(v) {
      const centro = centrosData.find(c => c.centro === v.centro);
      $('#infCentro').value = v.centro;
      $('#infProvincia').value = centro ? centro.provincia : "";
      $('#infDelegado').value = v.delegado;
      $('#infTipo').value = centro ? centro.tipo : "";
      $('#infRespAudio').value = v.respAudio;
      $('#infFecha').value = v.fechaISO;
      $('#infAudiologo').value = "";
      $('#infHoras').value = "";
      toggleSection('informeSection');
    }

    /***** ADJUNTAR CENTROS DESDE EXCEL *****/
    $('#btnAdjuntarExcelCentros').addEventListener('click', () => {
      $('#inputExcelCentros').click();
    });

    $('#inputExcelCentros').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, {type:'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
        // se asume: CODIGO | PROPIETARIO | CENTRO | PROVINCIA | DELEGADO | TIPO
        rows.slice(1).forEach(r => {
          if (!r || !r[2]) return;
          centrosData.push({
            codigo: String(r[0] || '').trim(),
            propietario: String(r[1] || '').trim(),
            centro: String(r[2] || '').trim(),
            provincia: String(r[3] || '').trim(),
            delegado: String(r[4] || '').trim(),
            tipo: String(r[5] || 'Corner').trim()
          });
        });
        renderTablaCentros();
      };
      reader.readAsArrayBuffer(file);
    });

    /***** DASHBOARD CHARTS (DEMO) *****/
    let radarGeneralChart, chartProcesosAreasMes, chartAreasMes, chartAuxilios, chartTopAreas, chartAARHIT;

    function initDashboardCharts() {
      const ctxRadar = $('#radarGeneral');
      radarGeneralChart = new Chart(ctxRadar, {
        type: 'radar',
        data: {
          labels: ['Procesos','Conv. prueba','Conv. venta','Formaci√≥n','Producto'],
          datasets: [{
            label: 'Global',
            data: [82,78,72,65,70],
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56,189,248,0.2)'
          }]
        },
        options: {plugins:{legend:{display:false}}, scales:{r:{grid:{color:'#1f2937'},angleLines:{color:'#1f2937'},pointLabels:{color: '#9ca3af'}}}}
      });

      chartProcesosAreasMes = new Chart($('#chartProcesosAreasMes'), {
        type:'bar',
        data:{
          labels:['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov'],
          datasets:[
            {label:'Procesos %', data:[70,72,74,76,78,80,81,82,83,84,85], backgroundColor:'#60a5fa'},
            {label:'√Åreas de mejora', data:[5,5,4,4,4,3,3,2,2,2,1], type:'line', borderColor:'#f97316', yAxisID:'y1'}
          ]
        },
        options:{responsive:true,plugins:{legend:{labels:{color:'#e5e7eb'}}},
        scales:{y:{ticks:{color:'#e5e7eb'}}, y1:{position:'right',ticks:{color:'#f97316'}}}}
      });

      chartAreasMes = new Chart($('#chartAreasMes'), {
        type:'bar',
        data:{
          labels:['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'],
          datasets:[{label:'√Åreas de mejora', data:[6,5,5,4,4,3,3,3,2,2], backgroundColor:'#f97373'}]
        },
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{color:'#e5e7eb'}}}}
      });

      chartAuxilios = new Chart($('#chartAuxilios'), {
        type:'bar',
        data:{
          labels:['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
          datasets:[{label:'Equipos formados', data:[10,20,25,30,40,50,55,60,65,70,75,80], backgroundColor:'#22c55e'}]
        },
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{color:'#e5e7eb'}}}}
      });

      chartTopAreas = new Chart($('#chartTopAreas'), {
        type:'bar',
        data:{
          labels:['Seguimiento','Escaparate','Formaci√≥n','Postventa','Citas'],
          datasets:[{label:'N¬∫ incidencias', data:[10,9,8,7,5], backgroundColor:'#38bdf8'}]
        },
        options:{indexAxis:'y',plugins:{legend:{display:false}}}
      });

      chartAARHIT = new Chart($('#chartAARHIT'), {
        type:'doughnut',
        data:{
          labels:['Centros con AAR','Sin AAR'],
          datasets:[{data:[60,40], backgroundColor:['#22c55e','#ef4444']}]
        },
        options:{plugins:{legend:{labels:{color:'#e5e7eb'}}}}
      });

      // Ranking demo
      const ranking = [
        {nombre:'Blanca Fdez. de la Pradilla', score:90},
        {nombre:'Sergio Per√°n', score:87},
        {nombre:'Daniel Chazo', score:84},
        {nombre:'Sonia Godino', score:83},
        {nombre:'ENERITZ ARANGUREN', score:83},
        {nombre:'Marisa Carmona', score:80},
      ];
      const container = $('#rankingDelegados');
      container.innerHTML = "";
      ranking.forEach((r,i)=>{
        const div = document.createElement('div');
        div.className = 'ranking-item';
        div.innerHTML = `
          <div>${i+1}. ${r.nombre}</div>
          <div class="ranking-row">
            <div class="ranking-bar-bg">
              <div class="ranking-bar-fill" style="width:${r.score}%"></div>
            </div>
            <span style="font-size:.75rem">${r.score}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    initDashboardCharts();

    /***** INFORME: FORMACIONES LIST *****/
    const formacionesItems = [
      "WSA","Starkey","Habilidades comerciales / Neuroventas","HIT","Telecare","PIA","Telehear",
      "Financiaci√≥n Infinity","Venta de seguro","Primeros auxilios (equipo)","Audiometr√≠a RT","Test de lectura audio",
      "Screening audio","Manteleta audio","Escaparate visible audio","Salud auditiva en PDV","Elementos Renove",
      "Elementos MGM","Stock","Tchin Tchin"
    ];
    const formList = $('#formacionesList');
    formacionesItems.forEach(txt=>{
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" /> ${txt}`;
      formList.appendChild(label);
    });

    /***** INFORME: IM√ÅGENES *****/
    $$('.imagen-slot').forEach(slot => {
      const input = slot.querySelector('input[type="file"]');
      slot.addEventListener('click', () => input.click());
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const img = slot.querySelector('.imagen-preview');
          img.src = ev.target.result;
          img.style.display = 'block';
          slot.querySelector('span').textContent = file.name;
        };
        reader.readAsDataURL(file);
      });
    });

    /***** INFORME CHARTS *****/
    let chartKpisCentro, chartRadarCentro, chartResumenProcesos, chartResumenAreas, chartResumenConv;

    function initInformeCharts() {
      chartKpisCentro = new Chart($('#chartKpisCentro'), {
        type:'bar',
        data:{
          labels:['Procesos','Conv. prueba','Conv. venta','HIT','Formaciones','AAR','1os auxilios'],
          datasets:[{label:'% centro', data:[90,82,78,70,65,55,68], backgroundColor:['#60a5fa','#a855f7','#22c55e','#f97316','#eab308','#38bdf8','#f97373']}]
        },
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{color:'#e5e7eb'}}}}
      });

      chartRadarCentro = new Chart($('#chartRadarCentro'), {
        type:'radar',
        data:{
          labels:['Procesos','Conv. prueba','Conv. venta','Formaci√≥n','Producto','Comunicaci√≥n'],
          datasets:[{data:[90,82,78,70,65,68], borderColor:'#38bdf8', backgroundColor:'rgba(56,189,248,0.25)'}]
        },
        options:{plugins:{legend:{display:false}}, scales:{r:{grid:{color:'#1f2937'},angleLines:{color:'#1f2937'},pointLabels:{color:'#9ca3af'}}}}
      });

      chartResumenProcesos = new Chart($('#chartResumenProcesos'), {
        type:'doughnut',
        data:{
          labels:['Aplicados','Pendientes'],
          datasets:[{data:[75,25], backgroundColor:['#22c55e','#ef4444']}]
        },
        options:{plugins:{legend:{labels:{color:'#e5e7eb'}}}}
      });

      chartResumenAreas = new Chart($('#chartResumenAreas'), {
        type:'bar',
        data:{
          labels:['Procesos','Formaci√≥n','HIT','Producto','Comunicaci√≥n'],
          datasets:[{label:'√Åreas de mejora', data:[3,2,1,2,1], backgroundColor:'#f97373'}]
        },
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{color:'#e5e7eb'}}}}
      });

      chartResumenConv = new Chart($('#chartResumenConv'), {
        type:'bar',
        data:{
          labels:['Conv. prueba','Conv. venta'],
          datasets:[{label:'%', data:[82,78], backgroundColor:['#60a5fa','#22c55e']}]
        },
        options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{color:'#e5e7eb'}}}}
      });
    }

    initInformeCharts();

    /***** CHECKLIST EXCEL -> KPIs + TABLA *****/
    let checklistWorkbook = null;

    $('#inputChecklist').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        checklistWorkbook = XLSX.read(data, {type:'array'});
        $('#checklistInfo').textContent = `Checklist cargado: ${file.name}`;
        renderChecklistTabla();
        recalcularKpisDesdeChecklist(file.name);
      };
      reader.readAsArrayBuffer(file);
    });

    function renderChecklistTabla() {
      const cont = $('#checklistTablaCont');
      if (!checklistWorkbook) {
        cont.innerHTML = `<p style="font-size:.8rem;color:var(--text-muted);">No se ha adjuntado checklist en esta visita.</p>`;
        return;
      }
      const sheet = checklistWorkbook.Sheets[checklistWorkbook.SheetNames[0]];
      const range = XLSX.utils.decode_range(sheet['!ref']);
      const table = document.createElement('table');
      table.style.fontSize = ".7rem";
      table.style.borderCollapse = "collapse";
      for (let R = range.s.r; R <= range.e.r; ++R) {
        const tr = document.createElement('tr');
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({r:R,c:C});
          const cell = sheet[cellAddress];
          const td = document.createElement(R===range.s.r ? 'th' : 'td');
          td.textContent = cell ? XLSX.utils.format_cell(cell) : "";
          td.style.border = "1px solid #d1d5db";
          td.style.padding = "2px 4px";
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      cont.innerHTML = "";
      cont.appendChild(table);
    }

    function getCellNumber(sheet, addr) {
      const cell = sheet[addr];
      if (!cell) return 0;
      const v = parseFloat(XLSX.utils.format_cell(cell).toString().replace(',','.'));
      return isNaN(v) ? 0 : v;
    }

    function recalcularKpisDesdeChecklist(filename) {
      if (!checklistWorkbook) return;
      const sheet = checklistWorkbook.Sheets[checklistWorkbook.SheetNames[0]];
      const nameUpper = filename.toUpperCase();
      let procesos = 0, convPrueba = 0, convVenta = 0, hit = 0;

      if (nameUpper.includes("CORNER")) {
        procesos = getCellNumber(sheet,'F90');
        convPrueba = getCellNumber(sheet,'B92');
        convVenta = getCellNumber(sheet,'B93');
        hit = getCellNumber(sheet,'F63') * 100; // si es 0/1
      } else if (nameUpper.includes("EXCLUS")) {
        procesos = getCellNumber(sheet,'F104');
        convPrueba = getCellNumber(sheet,'I126');
        convVenta = getCellNumber(sheet,'I127');
        hit = getCellNumber(sheet,'F65') * 100;
      } else {
        // formato desconocido: dejamos demo
      }

      // Actualizar gr√°fico de KPIs del centro (solo algunos valores; resto demo)
      chartKpisCentro.data.datasets[0].data[0] = procesos || 90;
      chartKpisCentro.data.datasets[0].data[1] = convPrueba || 82;
      chartKpisCentro.data.datasets[0].data[2] = convVenta || 78;
      chartKpisCentro.data.datasets[0].data[3] = hit || 70;
      chartKpisCentro.update();

      chartRadarCentro.data.datasets[0].data[0] = procesos || 90;
      chartRadarCentro.data.datasets[0].data[1] = convPrueba || 82;
      chartRadarCentro.data.datasets[0].data[2] = convVenta || 78;
      chartRadarCentro.update();

      // resumen conversi√≥n
      chartResumenConv.data.datasets[0].data = [convPrueba || 82, convVenta || 78];
      chartResumenConv.update();
    }

    /***** GUARDAR INFORME *****/
    $('#btnGuardarInforme').addEventListener('click', () => {
      alert("Informe guardado (demo). La visita asociada pasa a Finalizada.");
      // Marcar la √∫ltima visita en proceso como finalizada
      const v = visitas.slice().reverse().find(x => x.estado === 'En proceso' && x.tieneInforme);
      if (v) {
        v.estado = 'Finalizada';
        renderVisitas();
        renderCalendar();
      }
    });

    /***** INICIALIZACI√ìN FINAL *****/
    console.log("Control Center Audio cargado (demo).");
  </script>
</body>
</html>
