<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Center Audio - Centros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      --estado-ambar: #facc15;
      --estado-rojo: #ef4444;
      --estado-verde: #22c55e;
      --estado-verde-soft: #4ade80;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
      overflow: hidden; /* sin scroll general: app a pantalla completa */
    }

    /* SIDEBAR */
    .sidebar {
      width: 250px;
      background: #020617;
      border-right: 1px solid #020617;
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      color: #e5e7eb;
      height: 100vh;
      overflow-y: auto; /* si la ventana es m√°s baja, solo hace scroll la barra lateral */
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red));
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: #9ca3af;
    }

    .section-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .12em;
      margin-bottom: 8px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .88rem;
      color: #9ca3af;
      cursor: pointer;
      transition: all .18s ease;
    }

    .nav-item span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }

    .nav-item.active {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
    }

    .nav-item.active span.icon {
      background: rgba(15,23,42,.2);
    }

    .nav-item:hover:not(.active) {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: #9ca3af;
    }

    /* MAIN LAYOUT: ocupa toda la altura y controla los scrolls internos */
    .main {
      flex: 1;
      padding: 10px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100vh;
      max-width: calc(100vw - 250px);
      overflow: hidden; /* nada se sale lateralmente */
    }

    .topbar {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 4px;
      flex-shrink: 0;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #020617;
      color: #e5e7eb;
      white-space: nowrap;
      box-shadow: none;
    }

    .btn-cta {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
      border-color: transparent;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    #themeToggle {
      min-width: 110px;
      justify-content: center;
    }

    /* BUSCADOR SUPERIOR */
    .centros-search-row {
      flex-shrink: 0;
    }

    .centros-search-wrapper {
      position: relative;
    }

    .centros-search-input {
      width: 100%;
      background: #020617;
      border-radius: 999px;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      font-size: .86rem;
      outline: none;
    }

    .centros-search-input::placeholder {
      color: var(--text-muted);
    }

    .centros-search-wrapper .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .8rem;
      color: var(--text-muted);
    }

    /* BLOQUE SUPERIOR: DELEGADOS + CALENDARIO + VISITAS */
    .top-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.5fr) minmax(0, 1.2fr);
      gap: 12px;
      margin-top: 8px;
      flex: 0 0 290px;     /* altura base del bloque superior */
      max-height: 310px;   /* nunca crece m√°s de esto */
      min-height: 260px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
    }

    .card h3 {
      font-size: .9rem;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: .72rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .badge-small {
      font-size: .7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: var(--text-muted);
      border: 1px solid var(--border-soft);
    }

    /* PANEL IZQUIERDO: DELEGADOS */
    .delegados-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-shrink: 0;
    }

    .delegados-scroll {
      margin-top: 6px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .delegados-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .delegado-item {
      background: #020617;
      border-radius: 999px;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border: 1px solid #1f2937;
      font-size: .78rem;
    }

    .delegado-item-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .delegado-item-bar-fill {
      height: 100%;
      border-radius: 999px;
    }

    .delegado-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .delegado-resumen {
      font-size: .7rem;
      color: var(--text-muted);
      margin-top: 4px;
      flex-shrink: 0;
    }

    .actions-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    /* CALENDARIO (CENTRO) */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .86rem;
      margin-bottom: 6px;
    }

    .calendar-nav-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--text-muted);
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: .9rem;
    }

    .calendar-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      grid-auto-rows: minmax(60px, 1fr);
      gap: 6px;
      min-height: 0;
    }

    .calendar-weekday {
      font-size: .7rem;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 4px;
    }

    .calendar-cell {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 4px 6px;
      cursor: pointer;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: .7rem;
    }

    .calendar-cell:hover {
      border-color: #38bdf8;
    }

    .calendar-day-number {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .calendar-dots {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
    }

    .calendar-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }

    .calendar-footnote {
      font-size: .72rem;
      color: var(--text-muted);
      margin-top: 4px;
      flex-shrink: 0;
    }

    /* VISITAS AGENDADAS (DERECHA) */
    .visitas-header {
      flex-shrink: 0;
    }

    .visitas-list {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      margin-top: 4px;
      font-size: .78rem;
    }

    .visita-item {
      border-radius: 10px;
      border: 1px solid #111827;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .visita-top-line {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: .78rem;
    }

    .visita-bottom-line {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: .72rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: .7rem;
      border: 1px solid var(--border-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .pill-estado-pendiente {
      background: rgba(250, 204, 21, 0.12);
      border-color: rgba(250, 204, 21, 0.6);
      color: var(--estado-ambar);
    }

    .pill-estado-anulada {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.6);
      color: var(--estado-rojo);
    }

    .pill-estado-realizada {
      background: rgba(34, 197, 94, 0.12);
      border-color: rgba(34, 197, 94, 0.6);
      color: var(--estado-verde);
    }

    .pill-informe-proceso {
      background: rgba(74, 222, 128, 0.12);
      border-color: rgba(74, 222, 128, 0.6);
      color: var(--estado-verde-soft);
    }

    .pill-informe-finalizado {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.9);
      color: var(--estado-verde);
    }

    .pill-aviso {
      background: rgba(248, 113, 113, 0.1);
      border-color: rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }

    .btn-mini {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--accent-blue);
      font-size: .7rem;
      cursor: pointer;
    }

    /* TABLA CENTROS: ocupa el resto de la pantalla, con scroll interno */
    .table-wrapper {
      margin-top: 10px;
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      flex: 1;        /* ocupa todo el espacio vertical restante */
      min-height: 0;  /* clave para que el scroll interno funcione */
    }

    .table-header {
      padding: 8px 10px 6px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      flex-shrink: 0;
    }

    .table-header h3 {
      font-size: .9rem;
    }

    .table-header span {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .table-scroll {
      flex: 1;
      min-height: 0;
      overflow: auto;        /* SOLO aqu√≠ hay scroll grande de centros */
      border-top: 1px solid var(--border-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .78rem;
      min-width: 700px; /* evita roturas de layout, con scroll horizontal interno si hace falta */
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 2;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #0b1120;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: .75rem;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.9);
    }

    .tag {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: .7rem;
      border: 1px solid var(--border-soft);
      background: #0b1120;
    }

    .tag.exclusivo {
      background: rgba(22,163,74,0.15);
      color: var(--accent-green);
      border-color: rgba(22,163,74,0.7);
    }

    .tag.corner {
      background: rgba(37,99,235,0.15);
      color: var(--accent-blue);
      border-color: rgba(37,99,235,0.7);
    }

    .tag-aar {
      background: rgba(148,163,184,0.15);
      border-color: rgba(148,163,184,0.7);
      color: var(--text-muted);
    }

    .tag-aar.si {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.7);
      color: var(--accent-green);
    }

    .tag-aar.formacion {
      background: rgba(234,179,8,0.15);
      border-color: rgba(234,179,8,0.7);
      color: #eab308;
    }

    .btn-link {
      border: none;
      background: transparent;
      color: var(--accent-blue);
      cursor: pointer;
      font-size: .74rem;
      text-decoration: underline;
      padding: 0;
    }

    /* MODALES */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #020617;
      border-radius: 14px;
      padding: 14px;
      width: 440px;
      max-width: 95%;
      border: 1px solid var(--border-soft);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      font-size: .95rem;
    }

    .modal-close {
      cursor: pointer;
      font-size: 1rem;
      color: var(--text-muted);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: .78rem;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-field label {
      font-size: .74rem;
      color: var(--text-muted);
    }

    .modal-field input,
    .modal-field select {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #0b1120;
      color: var(--text-main);
      font-size: .78rem;
      outline: none;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    @media (max-width: 1200px) {
      .top-layout {
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.2fr);
        grid-template-rows: auto auto;
        grid-auto-flow: row;
      }
    }
  </style>

  <!-- Librer√≠a para leer Excel en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>

    <div>
      <div class="section-title">Secciones</div>
      <nav class="nav-list">
        <div class="nav-item">
          <span class="icon">üè†</span> Dashboard
        </div>
        <div class="nav-item active">
          <span class="icon">üè¢</span> Centros
        </div>
        <div class="nav-item">
          <span class="icon">üë£</span> Visitas
        </div>
        <div class="nav-item">
          <span class="icon">üõ†</span> Servicios
        </div>
        <div class="nav-item">
          <span class="icon">üí≥</span> Ventas
        </div>
        <div class="nav-item">
          <span class="icon">üìä</span> Proyectos
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      Versi√≥n demo ¬∑ Datos ficticios
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <button class="btn" id="themeToggle">
        <span class="icon">üåì</span> Oscuro / Claro
      </button>
      <button class="btn">
        <span class="icon">üíæ</span> Guardar vista
      </button>
      <button class="btn">
        <span class="icon">‚¨áÔ∏è</span> Exportar HTML
      </button>
      <button class="btn btn-cta">
        <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
      </button>
    </div>

    <!-- Buscador -->
    <div class="centros-search-row">
      <div class="centros-search-wrapper">
        <span class="search-icon">üîç</span>
        <input id="buscadorCentros" class="centros-search-input"
               placeholder="Buscar por centro, propietario o delegado..." />
      </div>
    </div>

    <!-- BLOQUE SUPERIOR -->
    <section class="top-layout">
      <!-- IZQUIERDA: CENTROS Y DELEGADOS -->
      <article class="card">
        <div class="delegados-header">
          <div>
            <h3>Centros y delegados</h3>
            <p class="card-sub">
              Cada barra muestra un delegado, su color y el n√∫mero de centros. Haz clic para filtrar la tabla inferior.
            </p>
          </div>
          <span class="badge-small" id="delegadosResumenBadge">0 delegados</span>
        </div>

        <div class="delegados-scroll">
          <div class="delegados-list" id="delegadosLegend"></div>
        </div>

        <div class="actions-row">
          <button class="btn btn-cta" id="btnAddCentro">
            <span class="icon">‚ûï</span> A√±adir centro
          </button>
          <button class="btn" id="btnAdjuntarExcel">
            <span class="icon">üì§</span> Adjuntar centros (Excel)
          </button>
          <input type="file" id="inputExcel" accept=".xlsx,.xls" style="display:none" />
        </div>

        <p class="delegado-resumen" id="summaryCentros">
          Centros mostrados: 0 ¬∑ Total cargados: 0
        </p>
      </article>

      <!-- CENTRO: CALENDARIO -->
      <article class="card">
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prevMonthBtn">‚Äπ</button>
          <div>
            <h3 id="calendarMonthLabel">Diciembre 2025</h3>
          </div>
          <button class="calendar-nav-btn" id="nextMonthBtn">‚Ä∫</button>
        </div>
        <div class="calendar-weekdays">
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        <div class="calendar-footnote">
          Clic en un d√≠a para agendar una visita con Responsable de Audio y centro.
        </div>
      </article>

      <!-- DERECHA: VISITAS AGENDADAS -->
      <article class="card">
        <div class="visitas-header">
          <h3>Visitas agendadas</h3>
          <p class="card-sub">
            Listado por fecha, centro, delegado y Responsable de Audio. Gestiona el estado e informes de cada visita.
          </p>
        </div>
        <div class="visitas-list" id="visitasList">
          <p style="font-size:.78rem; color:var(--text-muted);">
            No hay visitas agendadas para este periodo.
          </p>
        </div>
      </article>
    </section>

    <!-- TABLA CENTROS -->
    <section class="table-wrapper">
      <div class="table-header">
        <div>
          <h3>Listado de centros</h3>
          <span>Vista consolidada de centros Corner y Exclusivos ¬∑ fuente: Excel maestro.</span>
        </div>
        <span class="badge-small" id="totalCentrosLabel">Centros mostrados: 0 / 0</span>
      </div>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Propietario</th>
              <th>Centro</th>
              <th>Provincia</th>
              <th>Delegado</th>
              <th>Tipo</th>
              <th>Informes</th>
              <th>Centro AAR</th>
            </tr>
          </thead>
          <tbody id="tablaCentrosBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL NUEVO CENTRO -->
  <div class="modal-backdrop" id="modalCentro">
    <div class="modal">
      <div class="modal-header">
        <h3>Nuevo centro</h3>
        <span class="modal-close" data-close="modalCentro">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>C√≥digo</label>
          <input id="nuevoCodigo" />
        </div>
        <div class="modal-field">
          <label>Propietario</label>
          <input id="nuevoPropietario" />
        </div>
        <div class="modal-field">
          <label>Centro</label>
          <input id="nuevoCentro" />
        </div>
        <div class="modal-field">
          <label>Provincia</label>
          <input id="nuevoProvincia" />
        </div>
        <div class="modal-field">
          <label>Delegado</label>
          <select id="nuevoDelegado"></select>
        </div>
        <div class="modal-field">
          <label>Tipo</label>
          <select id="nuevoTipo">
            <option value="Corner">Corner</option>
            <option value="Exclusivo">Exclusivo</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalCentro">Cancelar</button>
        <button class="btn btn-cta" id="guardarCentro">Guardar centro</button>
      </div>
    </div>
  </div>

  <!-- MODAL VISITA NUEVA -->
  <div class="modal-backdrop" id="modalVisita">
    <div class="modal">
      <div class="modal-header">
        <h3>Nueva visita agendada</h3>
        <span class="modal-close" data-close="modalVisita">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>Fecha de visita</label>
          <input id="visitaFecha" type="date" />
        </div>
        <div class="modal-field">
          <label>Responsable de Audio</label>
          <select id="visitaResponsable">
            <option value="Ariannys Rojas">Ariannys Rojas</option>
            <option value="Sonia Guasque">Sonia Guasque</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Centro (buscador)</label>
          <input id="visitaCentro" list="listaCentros" placeholder="Escribe para buscar el centro..." />
          <datalist id="listaCentros"></datalist>
        </div>
        <div class="modal-field">
          <label>Delegado (se rellena autom√°tico si el centro existe)</label>
          <input id="visitaDelegado" disabled />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalVisita">Cancelar</button>
        <button class="btn btn-cta" id="guardarVisita">Guardar visita</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFORMES (CENTROS) -->
  <div class="modal-backdrop" id="modalInformes">
    <div class="modal">
      <div class="modal-header">
        <h3>Informes del centro</h3>
        <span class="modal-close" data-close="modalInformes">‚úï</span>
      </div>
      <div class="modal-body" id="informesBody"></div>
      <div class="modal-footer">
        <button class="btn" data-close="modalInformes">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // --- Tema oscuro/claro simple ---
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('light');
    });

    // --- Colores delegados (incluyendo Laura Ramos / Laura Plazas diferenciadas) ---
    const delegadosColores = {
      "ENERITZ ARANGUREN": "#22c55e",
      "LAURA PLAZAS": "#2563eb",
      "LAURA RAMOS": "#14b8a6",
      "Daniel Chazo": "#a855f7",
      "Manuel C√°novas": "#f97316",
      "Cecilia P√©rez": "#0ea5e9",
      "Martin SEBASTI√ÅN": "#ef4444",
      "Marisa Carmona": "#eab308",
      "Blanca Fdez. de la Pradilla": "#ec4899",
      "Maribel Amezcua": "#facc15",
      "Sonia Godino": "#22d3ee",
      "Ver√≥nica Alfons√≠n": "#4ade80",
      "Sergio Per√°n": "#fb7185"
    };

    // --- Datos base ---
    const centros = [];          // se rellenar√° desde Excel o demo
    const informesPorCentro = {};
    const aarPorCentro = {};

    // 8 centros exclusivos definitivos
    const exclusivosNombres = new Set([
      "CC LOS VALLES",
      "FUENLABRADA Calle Leganes",
      "PAMPLONA C. Exclusivo",
      "REINA DE MERCEDES",
      "SANTANDER CC PE√ëACASTILLO",
      "SANTIAGO DE COMPOSTELA RUA DA ROSA",
      "TORRELAVEGA CARREFOUR CC",
      "ZARAGOZA CALLE DELICIAS"
    ]);

    // --- Utilidades ---
    function normaliza(txt) {
      return (txt || "").toString().trim().toUpperCase();
    }

    // --- TABLA CENTROS ---
    const tablaBody = document.getElementById('tablaCentrosBody');
    const totalCentrosLabel = document.getElementById('totalCentrosLabel');
    const summaryCentros = document.getElementById('summaryCentros');

    let filtroDelegadoActual = null;
    let filtroTextoActual = "";

    function tipoCentro(nombreCentro) {
      return exclusivosNombres.has(nombreCentro) ? "Exclusivo" : "Corner";
    }

    function getInformes(nombreCentro) {
      return informesPorCentro[nombreCentro] || [];
    }

    function getAarEstado(nombreCentro) {
      return aarPorCentro[nombreCentro] || "No";
    }

    function renderTabla() {
      const texto = (filtroTextoActual || "").toLowerCase();
      tablaBody.innerHTML = "";

      const filtrados = centros.filter(c => {
        const cad = (c.centro + " " + c.propietario + " " + c.delegado).toLowerCase();
        const pasaTexto = cad.includes(texto);
        const pasaDelegado = !filtroDelegadoActual ||
          c.delegado.toLowerCase().includes(filtroDelegadoActual.toLowerCase());
        return pasaTexto && pasaDelegado;
      });

      filtrados.forEach(c => {
        const tr = document.createElement('tr');
        const t = tipoCentro(c.centro);
        const informes = getInformes(c.centro);
        const aarEstado = getAarEstado(c.centro);

        tr.innerHTML = `
          <td>${c.codigo}</td>
          <td>${c.propietario}</td>
          <td>${c.centro}</td>
          <td>${c.provincia}</td>
          <td>${c.delegado}</td>
          <td><span class="tag ${t === 'Exclusivo' ? 'exclusivo' : 'corner'}">${t}</span></td>
          <td>
            <button class="btn-link" data-centro="${c.centro}">
              ${informes.length ? `Ver (${informes.length})` : "A√±adir informe"}
            </button>
          </td>
          <td>
            <span class="tag tag-aar ${
              aarEstado === 'S√≠' ? 'si' :
              aarEstado === 'En formaci√≥n' ? 'formacion' : ''
            }">${aarEstado}</span>
          </td>
        `;
        tablaBody.appendChild(tr);
      });

      totalCentrosLabel.textContent =
        `Centros mostrados: ${filtrados.length} / ${centros.length}`;
      summaryCentros.textContent =
        `Centros mostrados: ${filtrados.length} ¬∑ Total cargados desde Excel o altas manuales: ${centros.length}`;

      actualizarDelegados();
      actualizarDatalistCentros();
    }

    // --- LEYENDA DELEGADOS (barras) ---
    const delegadosLegend = document.getElementById('delegadosLegend');
    const delegadosResumenBadge = document.getElementById('delegadosResumenBadge');

    function actualizarDelegados() {
      const mapa = new Map();
      centros.forEach(c => {
        mapa.set(c.delegado, (mapa.get(c.delegado) || 0) + 1);
      });

      delegadosLegend.innerHTML = "";
      const delegados = Array.from(mapa.entries()).sort((a, b) =>
        a[0].localeCompare(b[0])
      );

      delegadosResumenBadge.textContent = `${delegados.length} delegados`;

      delegados.forEach(([nombre, cuenta]) => {
        const color = delegadosColores[nombre] || "#e5e7eb";
        const max = delegados.reduce((m, [, n]) => Math.max(m, n), 1);
        const ancho = (cuenta / max) * 100;

        const item = document.createElement('div');
        item.className = 'delegado-item';
        item.innerHTML = `
          <span class="delegado-dot" style="background:${color}"></span>
          <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${nombre}
          </span>
          <span style="font-size:.7rem;">${cuenta} centro${cuenta !== 1 ? 's' : ''}</span>
        `;

        const barra = document.createElement('div');
        barra.className = 'delegado-item-bar';
        barra.innerHTML =
          `<div class="delegado-item-bar-fill" style="background:${color}; width:${ancho}%;"></div>`;

        item.appendChild(barra);

        item.addEventListener('click', () => {
          if (filtroDelegadoActual === nombre) {
            filtroDelegadoActual = null;
          } else {
            filtroDelegadoActual = nombre;
          }
          renderTabla();
        });

        delegadosLegend.appendChild(item);
      });
    }

    // --- BUSCADOR ---
    document.getElementById('buscadorCentros').addEventListener('input', e => {
      filtroTextoActual = e.target.value || "";
      renderTabla();
    });

    // --- MODALES COMUNES ---
    function abrirModal(id) {
      document.getElementById(id).style.display = 'flex';
    }

    function cerrarModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    document.querySelectorAll('[data-close]').forEach(el => {
      el.addEventListener('click', () => cerrarModal(el.dataset.close));
    });

    // --- MODAL NUEVO CENTRO ---
    document.getElementById('btnAddCentro').addEventListener('click', () => {
      const sel = document.getElementById('nuevoDelegado');
      sel.innerHTML = "";
      const nombres = new Set([...Object.keys(delegadosColores), ...centros.map(c => c.delegado)]);
      nombres.forEach(nombre => {
        const opt = document.createElement('option');
        opt.value = nombre;
        opt.textContent = nombre;
        sel.appendChild(opt);
      });
      abrirModal('modalCentro');
    });

    document.getElementById('guardarCentro').addEventListener('click', () => {
      const nuevo = {
        codigo: document.getElementById('nuevoCodigo').value || "NEW",
        propietario: document.getElementById('nuevoPropietario').value || "N/D",
        centro: document.getElementById('nuevoCentro').value || "Centro sin nombre",
        provincia: document.getElementById('nuevoProvincia').value || "N/D",
        delegado: document.getElementById('nuevoDelegado').value || "N/D"
      };
      const tipo = document.getElementById('nuevoTipo').value;
      if (tipo === "Exclusivo") exclusivosNombres.add(nuevo.centro);
      centros.push(nuevo);
      cerrarModal('modalCentro');
      renderTabla();
    });

    // --- INFORMES DE CENTRO (placeholder) ---
    document.addEventListener('click', e => {
      if (e.target.matches('.btn-link[data-centro]')) {
        const nombreCentro = e.target.dataset.centro;
        const informes = getInformes(nombreCentro);
        const cont = document.getElementById('informesBody');
        cont.innerHTML = "";

        if (!informes.length) {
          cont.innerHTML =
            "<p style='font-size:.8rem;'>Este centro a√∫n no tiene informes guardados. Desde el m√≥dulo de informes podr√°s adjuntar documentos (visitas, auditor√≠as, etc.).</p>";
        } else {
          informes.forEach((inf, idx) => {
            const div = document.createElement('div');
            div.className = 'modal-field';
            div.innerHTML = `<label>Informe ${idx + 1}</label><div>${inf}</div>`;
            cont.appendChild(div);
          });
        }
        abrirModal('modalInformes');
      }
    });

    // --- ADJUNTAR CENTROS (EXCEL) ---
    const inputExcel = document.getElementById('inputExcel');
    document.getElementById('btnAdjuntarExcel').addEventListener('click', () => {
      inputExcel.click();
    });

    inputExcel.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        centros.length = 0; // limpiamos
        rows.slice(1).forEach(row => {
          if (!row || row.length < 5) return;
          const [codigo, propietario, centro, provincia, delegado] = row;
          if (!centro) return;
          centros.push({
            codigo: (codigo || "").toString().trim(),
            propietario: (propietario || "").toString().trim(),
            centro: (centro || "").toString().trim(),
            provincia: (provincia || "").toString().trim(),
            delegado: (delegado || "").toString().trim()
          });
        });

        filtroDelegadoActual = null;
        filtroTextoActual = "";
        document.getElementById('buscadorCentros').value = "";

        renderTabla();
      };
      reader.readAsArrayBuffer(file);
    });

    // --- DATOS DEMO INICIALES (los 10 que ten√≠amos) ---
    (function cargaDemoInicial() {
      const demo = [
        { codigo:"4ABB", propietario:"MAZA Oriol", centro:"PAMPLONA C. Exclusivo", provincia:"NAVARRA", delegado:"Sonia Godino" },
        { codigo:"4AFH", propietario:"MAZA Oriol", centro:"PAMPLONA Calle Sancho el Mayor", provincia:"NAVARRA", delegado:"Sonia Godino" },
        { codigo:"4AWQ", propietario:"MAZA Oriol", centro:"PAMPLONA Carlos III", provincia:"NAVARRA", delegado:"Sonia Godino" },
        { codigo:"4MRM", propietario:"AAO", centro:"REINA DE MERCEDES", provincia:"Madrid", delegado:"Sergio Per√°n" },
        { codigo:"4PEC", propietario:"AAO", centro:"SANTANDER CC PE√ëACASTILLO", provincia:"Santander", delegado:"Sergio Per√°n" },
        { codigo:"4AXF", propietario:"URRUTIA Esteban", centro:"SANTIAGO DE COMPOSTELA RUA DA ROSA", provincia:"A Coru√±a", delegado:"Daniel Chazo" },
        { codigo:"4TOL", propietario:"AAO", centro:"TORRELAVEGA CARREFOUR CC", provincia:"Santander", delegado:"Sergio Per√°n" },
        { codigo:"4ZDE", propietario:"AAO", centro:"ZARAGOZA CALLE DELICIAS", provincia:"ZARAGOZA", delegado:"ENERITZ ARANGUREN" },
        { codigo:"4AKI", propietario:"PIEDRAFITA Rocio", centro:"CC LOS VALLES", provincia:"MADRID", delegado:"Blanca Fdez. de la Pradilla" },
        { codigo:"4MLG", propietario:"AAO", centro:"FUENLABRADA Calle Leganes", provincia:"MADRID", delegado:"Marisa Carmona" }
      ];
      demo.forEach(c => centros.push(c));
      renderTabla();
    })();

    // --- DATALIST CENTROS PARA EL CALENDARIO ---
    function actualizarDatalistCentros() {
      const datalist = document.getElementById('listaCentros');
      datalist.innerHTML = "";
      centros.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.centro;
        opt.label = `${c.centro} ¬∑ ${c.delegado}`;
        datalist.appendChild(opt);
      });
    }

    document.getElementById('visitaCentro').addEventListener('change', e => {
      const nombre = e.target.value;
      const centro = centros.find(c => c.centro === nombre);
      document.getElementById('visitaDelegado').value = centro ? centro.delegado : "";
    });

    // --- CALENDARIO Y VISITAS ---
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarMonthLabel = document.getElementById('calendarMonthLabel');

    const visitas = []; // {id, fecha (YYYY-MM-DD), centro, delegado, responsable, estado, informeEstado}

    let currentYear, currentMonth;
    const hoy = new Date();

    function setCurrentMonth(date) {
      currentYear = date.getFullYear();
      currentMonth = date.getMonth();
      renderCalendar();
      renderVisitas();
    }

    function renderCalendar() {
      calendarGrid.innerHTML = "";

      const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
      calendarMonthLabel.textContent = `${meses[currentMonth]} ${currentYear}`;

      // cabecera d√≠as
      const dias = ["L","M","X","J","V","S","D"];
      dias.forEach(d => {
        const span = document.createElement('div');
        span.className = 'calendar-weekday';
        span.textContent = d;
        calendarGrid.appendChild(span);
      });

      const firstDay = new Date(currentYear, currentMonth, 1);
      const startWeekday = (firstDay.getDay() + 6) % 7; // lunes=0
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      // celdas vac√≠as antes del 1
      for (let i = 0; i < startWeekday; i++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        cell.style.visibility = 'hidden';
        calendarGrid.appendChild(cell);
      }

      // d√≠as del mes
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';

        const span = document.createElement('div');
        span.className = 'calendar-day-number';
        span.textContent = day;

        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'calendar-dots';

        const fechaISO = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const visitasDia = visitas.filter(v => v.fecha === fechaISO);

        visitasDia.forEach(v => {
          const dot = document.createElement('div');
          dot.className = 'calendar-dot';
          let color = getEstadoColor(v.estado);
          dot.style.background = color;
          dotsContainer.appendChild(dot);
        });

        cell.appendChild(span);
        cell.appendChild(dotsContainer);

        cell.addEventListener('click', () => abrirModalVisitaParaFecha(fechaISO));

        calendarGrid.appendChild(cell);
      }
    }

    function getEstadoColor(estado) {
      switch (estado) {
        case "pendiente": return "#facc15";
        case "anulada": return "#ef4444";
        case "realizada": return "#22c55e";
        default: return "#9ca3af";
      }
    }

    function abrirModalVisitaParaFecha(fechaISO) {
      document.getElementById('visitaFecha').value = fechaISO;
      document.getElementById('visitaResponsable').value = "Ariannys Rojas";
      document.getElementById('visitaCentro').value = "";
      document.getElementById('visitaDelegado').value = "";
      abrirModal('modalVisita');
    }

    document.getElementById('guardarVisita').addEventListener('click', () => {
      const fecha = document.getElementById('visitaFecha').value;
      const responsable = document.getElementById('visitaResponsable').value;
      const centroNombre = document.getElementById('visitaCentro').value;
      const delegado = document.getElementById('visitaDelegado').value || "N/D";

      if (!fecha || !centroNombre) {
        alert("Debes indicar fecha y centro para agendar la visita.");
        return;
      }

      visitas.push({
        id: Date.now(),
        fecha,
        centro: centroNombre,
        delegado,
        responsable,
        estado: "pendiente",      // √°mbar
        informeEstado: "ninguno"  // sin informe
      });

      cerrarModal('modalVisita');
      renderCalendar();
      renderVisitas();
    });

    function renderVisitas() {
      const cont = document.getElementById('visitasList');
      cont.innerHTML = "";

      const inicioMes = new Date(currentYear, currentMonth, 1);
      const finMes = new Date(currentYear, currentMonth + 1, 0);

      const lista = visitas.filter(v => {
        const d = new Date(v.fecha);
        return d >= inicioMes && d <= finMes;
      }).sort((a, b) => a.fecha.localeCompare(b.fecha));

      if (!lista.length) {
        cont.innerHTML =
          "<p style='font-size:.78rem; color:var(--text-muted);'>No hay visitas agendadas para este periodo.</p>";
        return;
      }

      const hoyISO = hoy.toISOString().slice(0,10);

      lista.forEach(v => {
        const item = document.createElement('div');
        item.className = 'visita-item';

        const topLine = document.createElement('div');
        topLine.className = 'visita-top-line';
        topLine.innerHTML = `
          <span>${v.fecha}</span>
          <span style="color:var(--text-muted);">${v.centro}</span>
        `;

        const bottomLine = document.createElement('div');
        bottomLine.className = 'visita-bottom-line';

        const izquierda = document.createElement('div');
        izquierda.innerHTML =
          `<span style="color:var(--text-muted);">Delegado:</span> ${v.delegado || 'N/D'} ¬∑ 
           <span style="color:var(--text-muted);">Resp. Audio:</span> ${v.responsable}`;

        const derecha = document.createElement('div');
        derecha.style.display = 'flex';
        derecha.style.gap = '4px';
        derecha.style.alignItems = 'center';

        const pillEstado = document.createElement('span');
        pillEstado.className = 'pill ' + (
          v.estado === 'pendiente' ? 'pill-estado-pendiente' :
          v.estado === 'anulada'   ? 'pill-estado-anulada' :
          'pill-estado-realizada'
        );
        pillEstado.textContent =
          v.estado === 'pendiente' ? 'Pendiente' :
          v.estado === 'anulada'   ? 'Anulada'   : 'Realizada';

        const pillInforme = document.createElement('span');
        pillInforme.className = 'pill ' + (
          v.informeEstado === 'en-proceso' ? 'pill-informe-proceso' :
          v.informeEstado === 'finalizado' ? 'pill-informe-finalizado' :
          ''
        );
        pillInforme.textContent =
          v.informeEstado === 'en-proceso' ? 'Informe en proceso' :
          v.informeEstado === 'finalizado' ? 'Informe finalizado' :
          'Sin informe';

        const btnInforme = document.createElement('button');
        btnInforme.className = 'btn-mini';
        btnInforme.textContent = 'Informe';
        btnInforme.addEventListener('click', () => {
          if (v.informeEstado === 'ninguno') {
            v.informeEstado = 'en-proceso';      // verde claro
          } else if (v.informeEstado === 'en-proceso') {
            v.informeEstado = 'finalizado';      // verde m√°s oscuro
          } else {
            v.informeEstado = 'en-proceso';      // reabrir
          }
          renderVisitas();
        });

        const btnEstado = document.createElement('button');
        btnEstado.className = 'btn-mini';
        btnEstado.textContent = 'Cambiar estado';
        btnEstado.addEventListener('click', () => {
          if (v.estado === 'pendiente') {
            v.estado = 'realizada';
          } else if (v.estado === 'realizada') {
            v.estado = 'anulada';
          } else {
            v.estado = 'pendiente';
          }
          renderCalendar();
          renderVisitas();
        });

        derecha.appendChild(pillEstado);
        derecha.appendChild(pillInforme);
        derecha.appendChild(btnInforme);
        derecha.appendChild(btnEstado);

        // aviso si ya pas√≥ la fecha y sigue pendiente y sin informe
        if (v.fecha < hoyISO && v.estado === 'pendiente' && v.informeEstado === 'ninguno') {
          const aviso = document.createElement('span');
          aviso.className = 'pill pill-aviso';
          aviso.textContent = 'Actualizar estado';
          derecha.appendChild(aviso);
        }

        bottomLine.appendChild(izquierda);
        bottomLine.appendChild(derecha);

        item.appendChild(topLine);
        item.appendChild(bottomLine);
        cont.appendChild(item);
      });
    }

    document.getElementById('prevMonthBtn').addEventListener('click', () => {
      setCurrentMonth(new Date(currentYear, currentMonth - 1, 1));
    });

    document.getElementById('nextMonthBtn').addEventListener('click', () => {
      setCurrentMonth(new Date(currentYear, currentMonth + 1, 1));
    });

    // Inicializar calendario con el mes actual
    setCurrentMonth(new Date());
  </script>
</body>
</html>
