<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Seguimiento de procesos de Audio</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSX para leer Excels -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>

  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect } = React;

      // =====================================
      // 1. CONFIGURACI칍N CHECKLIST PROCESOS
      // =====================================

      const CHECKLIST_ETAPAS = [
        {
          etapa: "HOLA",
          items: [
            "Espacio audio limpio, ordenado",
            "Esp칠culos, olivas y cascos desinfectados",
            "Acogida al cliente con una sonrisa, amable y cercana",
            "Llamar al paciente por su nombre",
            "Acompa침ar al paciente al gabinete para la revisi칩n auditiva",
            "Confirmar motivo de visita",
          ],
        },
        {
          etapa: "SOY 칔NICO",
          items: [
            "Abrir ficha y rellenar RGPD completa (incluidos checks comerciales)",
            "Realizar anamnesis HACE (H치bitos, Antecedentes, Cl칤nica, Expectativas)",
            "Anotar al menos 2 expectativas/necesidades concretas",
            "Recoger entorno sonoro y situaciones clave para el paciente",
          ],
        },
        {
          etapa: "MI AUDICI칍N",
          items: [
            "Explicar brevemente cada prueba y confirmar comprensi칩n",
            "Evaluar ambos o칤dos con videotoscopia y explicar procedimiento",
            "Realizar timpanometr칤a y explicar procedimiento",
            "Realizar v칤a a칠rea y v칤a 칩sea explicando cada paso",
            "Mantener TV encendida para comunicar audio y mostrar resultados",
          ],
        },
        {
          etapa: "MI SOLUCI칍N",
          items: [
            "Resumir claramente los resultados y su impacto",
            "Usar gr치ficas para apoyar la explicaci칩n (severidad, 치rea audible, fonemas)",
            "Vincular resultados con s칤ntomas y quejas de la anamnesis",
            "Hacer visible la p칠rdida auditiva con preguntas de implicaci칩n",
            "Simular sonidos para mostrar la diferencia con / sin ayuda",
          ],
        },
        {
          etapa: "PRUEBO",
          items: [
            "Explicar la prueba de capacidad de adaptaci칩n como prueba de salud",
            "Escoger aud칤fono seg칰n perfil en gama adecuada (Diamante)",
            "Realizar programaci칩n inicial y ajustes seg칰n perfil",
            "Explicar funcionamiento y mantenimiento para llevarse aud칤fonos a casa",
            "Entregar documentaci칩n (contrato, presupuesto, pasaporte)",
          ],
        },
        {
          etapa: "ME COMPROMETO",
          items: [
            "Trabajar resoluci칩n de objeciones con lenguaje positivo",
            "Explicar facilidades de pago (Infinity / NextYear)",
            "Detallar pack Serenidad y Serenidad + (compromisos)",
            "Explicar en detalle pruebas HIT y su utilidad",
            "Recomendar accesorios de conectividad y productos de higiene",
          ],
        },
        {
          etapa: "ME CONVIERTO EN FAN",
          items: [
            "Explicar llamadas de seguimiento y agenda futura",
            "Reforzar logros y mejoras conseguidas en cada visita",
            "Aplicar t칠cnicas de Neuroventas en el seguimiento",
          ],
        },
        {
          etapa: "SEGUIMIENTO Y AGENDA",
          items: [
            "Registrar prueba en el sistema (Gio)",
            "Llamar al d칤a siguiente de la prueba para seguimiento",
            "Agendar visita en 4 d칤as para revisi칩n",
          ],
        },
        {
          etapa: "COMUNICACI칍N DEL CENTRO",
          items: [
            "Comunicaci칩n del centro adecuada a su perfil",
            "Revisi칩n de comunicaci칩n en RRSS",
            "Uniformidad adecuada",
            "Contacto con locales vecinos y colaboraciones",
            "Escaparate atractivo con novedad de producto",
          ],
        },
        {
          etapa: "AYUDAS Y ACUERDOS",
          items: [
            "Conocer y activar acuerdos con FIAPAS y ONCE",
            "Revisar convenios locales (anotar detalle en observaciones)",
            "Conocer ayudas de comunidad aut칩noma",
            "Conocer ayudas generales +65 a침os y hasta 26 a침os",
          ],
        },
        {
          etapa: "INCENTIVOS",
          items: ["Incentivos por derivaci칩n", "Incentivos por AAR"],
        },
        {
          etapa: "FORMACI칍N",
          items: [
            "Onboarding Academy realizado",
            "Formaciones obligatorias de centros exclusivos cumplimentadas",
            "Formaciones obligatorias de centros audio realizadas",
          ],
        },
      ];

      // =====================================
      // 2. UTILIDADES GENERALES
      // =====================================

      function createEmptyVisits() {
        return [1, 2, 3, 4].map((id) => ({
          id,
          fecha: "",
          responsable: "",
          excelName: "",
          excelUrl: null,
          hit: "",
          checklist: null, // % global F90 / F104
          centroAAR: "",
          processPoints: [],
        }));
      }

      function normalizarCentro(nombre) {
        return (nombre || "").trim().toUpperCase();
      }

      function normalizarDelegado(nombre) {
        const trimmed = (nombre || "").trim();
        if (!trimmed) return "";
        return trimmed
          .toLowerCase()
          .split(/\s+/)
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");
      }

      function normalizeBasic(str) {
        return (str || "")
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toUpperCase()
          .trim();
      }

      function normalizeCriterionKey(text) {
        return (text || "")
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toUpperCase()
          .replace(/\s+/g, " ")
          .trim();
      }

      const CENTER_TO_PROVINCE = {};
      const CITY_TO_PROVINCE = {
        NARON: "A CORU칌A (GALICIA)",
        "NAR칍N": "A CORU칌A (GALICIA)",
        ONDARA: "ALICANTE (COMUNITAT VALENCIANA)",
      };

      function inferProvincia(centro, provinciaExcel) {
        if (provinciaExcel && provinciaExcel.trim() !== "") {
          return provinciaExcel.trim().toUpperCase();
        }
        const centroNorm = normalizarCentro(centro);
        if (CENTER_TO_PROVINCE[centroNorm]) {
          return CENTER_TO_PROVINCE[centroNorm];
        }
        const tokens = centroNorm
          .split(/[,\-()]/)
          .map((t) => t.trim())
          .filter(Boolean);
        for (let i = tokens.length - 1; i >= 0; i--) {
          const token = tokens[i];
          if (CITY_TO_PROVINCE[token]) {
            return CITY_TO_PROVINCE[token];
          }
        }
        return "";
      }

      function parseFecha(fecha) {
        const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        const match = (fecha || "").match(regex);
        if (!match) return null;
        const day = Number(match[1]);
        const month = Number(match[2]);
        const year = Number(match[3]);
        const d = new Date(year, month - 1, day);
        if (
          d.getFullYear() !== year ||
          d.getMonth() !== month - 1 ||
          d.getDate() !== day
        ) {
          return null;
        }
        return d;
      }

      function isValidFecha(fecha) {
        if (!fecha) return true;
        return parseFecha(fecha) !== null;
      }

      function media(valores) {
        const nums = (valores || []).filter(
          (v) => typeof v === "number" && !isNaN(v)
        );
        if (nums.length === 0) return null;
        const total = nums.reduce((sum, v) => sum + v, 0);
        return total / nums.length;
      }

      function porcentajeSi(valores) {
        const valid = (valores || []).filter((v) => v === "S칤" || v === "No");
        if (valid.length === 0) return null;
        const countSi = valid.filter((v) => v === "S칤").length;
        return (countSi / valid.length) * 100;
      }

      function donutStyle(percent) {
        const value = percent && percent > 0 ? Math.min(percent, 100) : 0;
        const color = percent !== null && percent >= 85 ? "#16a34a" : "#dc2626";
        return {
          background: `conic-gradient(${color} ${value * 3.6}deg, #e5e7eb 0deg)`,
        };
      }

      function donutStyleNeutral(percent) {
        const value = percent && percent > 0 ? Math.min(percent, 100) : 0;
        const color = "#0f766e";
        return {
          background: `conic-gradient(${color} ${value * 3.6}deg, #e5e7eb 0deg)`,
        };
      }

      function kpiBadgeClass(percent) {
        if (percent === null) return "bg-gray-200 text-gray-700";
        if (percent >= 85) return "bg-green-100 text-green-800";
        return "bg-red-100 text-red-700";
      }

      function delegadoColor(delegado) {
        if (!delegado) return {};
        let hash = 0;
        const texto = delegado.trim().toUpperCase();
        for (let i = 0; i < texto.length; i++) {
          hash = (hash * 31 + texto.charCodeAt(i)) | 0;
        }
        const hue = (Math.abs(hash) % 360 + 180) % 360;
        return {
          backgroundColor: `hsl(${hue}, 75%, 90%)`,
          color: `hsl(${hue}, 35%, 28%)`,
        };
      }

      function getUniqueSorted(values) {
        const set = new Set(
          values
            .map((v) => (v || "").trim())
            .filter((v) => v.length > 0)
        );
        return Array.from(set).sort((a, b) =>
          a.localeCompare(b, "es", { sensitivity: "base" })
        );
      }

      function aplicaHitTexto(visitas) {
        const hits = (visitas || []).filter((v) => v.hit === "S칤" || v.hit === "No");
        if (hits.length === 0) return null;
        const anyYes = hits.some((v) => v.hit === "S칤");
        return anyYes ? "S칤" : "No";
      }

      function formatFechaHora(iso) {
        if (!iso) return "Sin guardado";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "Sin guardado";
        return d.toLocaleString("es-ES");
      }

      function deriveRespAudio(store) {
        if (store.responsableAudio && store.responsableAudio.trim()) {
          return store.responsableAudio;
        }
        const visitas = store.visitas || [];
        const copia = [...visitas].reverse();
        const visitaConResp = copia.find((v) => v.responsable);
        return visitaConResp ? visitaConResp.responsable : "";
      }

      function deriveCentroAAR(store) {
        if (store.centroAAR === "S칤" || store.centroAAR === "No") {
          return store.centroAAR;
        }
        const visitas = store.visitas || [];
        const valores = visitas
          .map((v) => v.centroAAR)
          .filter((v) => v === "S칤" || v === "No");
        if (valores.length === 0) return "";
        if (valores.includes("S칤")) return "S칤";
        return "No";
      }

      // =====================================
      // 3. CENTROS EXCLUSIVOS
      // =====================================

      const EXCLUSIVE_CENTER_NAMES = [
        "PAMPLONA C. EXCLUSIVO",
        "CC LOS VALLES",
        "SANTIAGO DE COMPOSTELA RUA DA ROSA",
        "CC PLAZA DE LA ESTACI칍N",
        "REINA DE MERCEDES",
        "SANTANDER CC PE칌ACASTILLO",
        "TORRELAVEGA CARREFOUR CC",
        "ZARAGOZA CALLE DELICIAS",
      ].map(normalizarCentro);

      const EXCLUSIVE_CENTER_SET = new Set(
        EXCLUSIVE_CENTER_NAMES.map(normalizeBasic)
      );

      const EXCLUSIVE_MONTHS = [
        { key: "2025-08", label: "Ago 2025" },
        { key: "2025-09", label: "Sep 2025" },
        { key: "2025-10", label: "Oct 2025" },
        { key: "2025-11", label: "Nov 2025" },
        { key: "2025-12", label: "Dic 2025" },
        { key: "2026-01", label: "Ene 2026" },
        { key: "2026-02", label: "Feb 2026" },
        { key: "2026-03", label: "Mar 2026" },
        { key: "2026-04", label: "Abr 2026" },
        { key: "2026-05", label: "May 2026" },
        { key: "2026-06", label: "Jun 2026" },
        { key: "2026-07", label: "Jul 2026" },
      ];

      function defaultExclusiveData() {
        return {
          ventas: {},
          objetivos: {},
          acciones: [],
        };
      }

      // =====================================
      // 4. LECTURA PUNTO A PUNTO DESDE EXCEL
      // =====================================

      function extractProcessPointsFromWorkbook(workbook) {
        if (!workbook || !workbook.SheetNames) return [];
        const puntos = [];
        const seen = new Set();

        workbook.SheetNames.forEach((sheetName) => {
          const sheet = workbook.Sheets[sheetName];
          if (!sheet || !sheet["!ref"]) return;

          const range = XLSX.utils.decode_range(sheet["!ref"]);
          for (let r = range.s.r; r <= range.e.r; r++) {
            const cellB = sheet[XLSX.utils.encode_cell({ r, c: 1 })]; // B
            const cellF = sheet[XLSX.utils.encode_cell({ r, c: 5 })]; // F

            const labelRaw =
              cellB && cellB.v != null ? String(cellB.v).trim() : "";
            if (!labelRaw) continue;

            if (!cellF || cellF.v == null) continue;

            let valRaw = cellF.v;
            let numVal = null;

            if (typeof valRaw === "number") {
              numVal = valRaw;
            } else if (typeof valRaw === "string") {
              const m = valRaw.replace(",", ".").match(/-?\d+(\.\d+)?/);
              if (m) numVal = parseFloat(m[0]);
            }

            if (numVal === null || isNaN(numVal)) continue;

            const apply = numVal >= 1 ? 1 : 0;
            const key = normalizeCriterionKey(labelRaw);
            if (seen.has(key)) continue;
            seen.add(key);

            puntos.push({
              key,
              label: labelRaw,
              value: apply,
            });
          }
        });

        return puntos;
      }

      function computeProcessStats(stores, exclusiveGroup) {
        const stats = {};
        (stores || []).forEach((store) => {
          if (!!store.isExclusive !== !!exclusiveGroup) return;
          (store.visitas || []).forEach((visit) => {
            (visit.processPoints || []).forEach((p) => {
              if (p.value !== 0 && p.value !== 1) return;
              const key = p.key || normalizeCriterionKey(p.label);
              const label = p.label || "";
              if (!stats[key]) {
                stats[key] = { key, label, total: 0, count: 0 };
              }
              stats[key].total += p.value;
              stats[key].count += 1;
            });
          });
        });
        return stats;
      }

      function buildProcessChartData(statsAAO, statsExclusive) {
        const keysAAO = Object.keys(statsAAO || {});
        const keysExcl = Object.keys(statsExclusive || {});

        let globalOrder = [...keysExcl];
        keysAAO.forEach((k) => {
          if (!globalOrder.includes(k)) globalOrder.push(k);
        });

        const chartDataAAO = globalOrder
          .filter((k) => statsAAO[k])
          .map((k, idx) => {
            const s = statsAAO[k];
            const pct = s.count > 0 ? (s.total / s.count) * 100 : 0;
            return {
              index: idx + 1,
              key: k,
              label: s.label,
              pct,
              applied: s.total,
              total: s.count,
            };
          });

        const chartDataExclusive = globalOrder
          .filter((k) => statsExclusive[k])
          .map((k, idx) => {
            const s = statsExclusive[k];
            const pct = s.count > 0 ? (s.total / s.count) * 100 : 0;
            return {
              index: idx + 1,
              key: k,
              label: s.label,
              pct,
              applied: s.total,
              total: s.count,
            };
          });

        const avgAAO =
          chartDataAAO.length > 0
            ? chartDataAAO.reduce((sum, p) => sum + p.pct, 0) /
              chartDataAAO.length
            : null;
        const avgExclusive =
          chartDataExclusive.length > 0
            ? chartDataExclusive.reduce((sum, p) => sum + p.pct, 0) /
              chartDataExclusive.length
            : null;

        return { chartDataAAO, chartDataExclusive, avgAAO, avgExclusive };
      }

      function exportProcessCsv(data, fileName) {
        if (!data || data.length === 0) return;
        const rows = [
          ["N췈", "Proceso", "% aplicaci칩n", "Visitas aplica", "Total visitas"],
        ];
        data.forEach((p) => {
          rows.push([
            p.index,
            p.label,
            p.pct.toFixed(1).replace(".", ",") + "%",
            p.applied,
            p.total,
          ]);
        });
        const csv = rows
          .map((row) =>
            row
              .map((val) =>
                `"${String(val).replace(/"/g, '""').replace(/\r?\n/g, " ")}"`
              )
              .join(";")
          )
          .join("\r\n");
        const blob = new Blob([csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName || "procesos.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // =====================================
      // 5. COMPONENTES PEQUE칌OS
      // =====================================

      function ProcessBarChart({ data }) {
        if (!data || data.length === 0) {
          return (
            <p className="text-xs text-gray-500">
              A칰n no hay datos por proceso. Adjunta alg칰n checklist con 0/1 en
              la columna F para ver la aplicaci칩n por proceso.
            </p>
          );
        }

        const maxHeight = 120;

        return (
          <div className="mt-2 flex">
            <div className="flex flex-col-reverse justify-between mr-2 text-[9px] text-gray-400">
              <span>0%</span>
              <span>50%</span>
              <span>85%</span>
              <span>100%</span>
            </div>
            <div className="flex items-end gap-[6px] overflow-x-auto pb-2 h-[140px]">
              {data.map((p) => {
                const pctClamped = Math.max(0, Math.min(p.pct || 0, 100));
                const height = (pctClamped / 100) * maxHeight;

                let color = "#ef4444";
                if (pctClamped >= 85) {
                  color = "#16a34a";
                } else if (pctClamped >= 80) {
                  color = "#f59e0b";
                }

                return (
                  <div
                    key={p.key}
                    className="flex flex-col items-center min-w-[18px]"
                    title={`${p.index}. ${p.label} 췅 ${pctClamped.toFixed(
                      0
                    )}% (${p.applied}/${p.total} visitas)`}
                  >
                    <div
                      className="w-3 rounded-md bg-gray-200 flex items-end"
                      style={{ height: `${maxHeight}px` }}
                    >
                      <div
                        className="w-full rounded-md"
                        style={{
                          height: `${height}px`,
                          backgroundColor: color,
                        }}
                      ></div>
                    </div>
                    <span className="mt-1 text-[9px] text-gray-500">
                      {p.index}
                    </span>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      function ProcessCard({
        title,
        data,
        avg,
        showTable,
        onToggleTable,
        onExport,
      }) {
        return (
          <div className="bg-white rounded-2xl shadow px-4 py-3 flex flex-col">
            <div className="flex items-start justify-between gap-2">
              <div>
                <p className="font-semibold text-sm">{title}</p>
                {avg !== null && (
                  <p className="text-[11px] text-gray-500">
                    Media de aplicaci칩n de los procesos:{" "}
                    <strong>{avg.toFixed(0)}%</strong>
                  </p>
                )}
              </div>
              <div className="flex gap-2 items-center">
                <button
                  onClick={onExport}
                  className="text-[10px] px-2 py-1 rounded-full border border-sky-400 text-sky-700 hover:bg-sky-50"
                  title="Descargar tabla en CSV para abrir en Excel"
                >
                  游늵 Excel
                </button>
                <button
                  onClick={onToggleTable}
                  className="text-[10px] px-2 py-1 rounded-full border border-indigo-400 text-indigo-700 hover:bg-indigo-50"
                >
                  {showTable ? "Ocultar tabla" : "Ver tabla"}
                </button>
              </div>
            </div>

            <div className="mt-2">
              <ProcessBarChart data={data} />
            </div>

            {showTable && (
              <div className="mt-3 max-h-64 overflow-auto border rounded-xl p-2 bg-gray-50">
                <table className="w-full text-[11px] border-collapse">
                  <thead>
                    <tr className="bg-gray-100 border-b">
                      <th className="text-left px-2 py-1">N췈</th>
                      <th className="text-left px-2 py-1">Proceso</th>
                      <th className="text-right px-2 py-1">% aplicaci칩n</th>
                      <th className="text-right px-2 py-1">
                        Visitas aplica / total
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.map((p) => (
                      <tr key={p.key} className="border-b">
                        <td className="px-2 py-1">{p.index}</td>
                        <td className="px-2 py-1">{p.label}</td>
                        <td className="px-2 py-1 text-right">
                          {p.pct.toFixed(1)}%
                        </td>
                        <td className="px-2 py-1 text-right">
                          {p.applied}/{p.total}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        );
      }

      function DonutCard({ title, percent, footer, neutral = false }) {
        const style = neutral
          ? donutStyleNeutral(percent ?? 0)
          : donutStyle(percent);
        return (
          <div className="flex flex-col items-center justify-center bg-white rounded-2xl shadow px-4 py-4">
            <p className="text-sm font-semibold mb-3 text-center">{title}</p>
            <div
              className="w-28 h-28 rounded-full flex items-center justify-center text-xs font-bold text-slate-800 mb-2"
              style={style}
            >
              <div className="w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-inner">
                <span>{percent !== null ? `${percent.toFixed(0)}%` : "--"}</span>
              </div>
            </div>
            {footer && (
              <p className="text-[11px] text-gray-500 text-center">{footer}</p>
            )}
          </div>
        );
      }

      // =====================================
      // 5.1 MAPA CON BANDERAS ROJAS
      // =====================================

      const CAPITALES = [
        // Pen칤nsula
        {
          nombre: "Santiago de Compostela",
          comunidad: "Galicia",
          left: "15%",
          top: "23%",
        },
        { nombre: "Oviedo", comunidad: "Asturias", left: "30%", top: "19%" },
        { nombre: "Santander", comunidad: "Cantabria", left: "38%", top: "20%" },
        {
          nombre: "Vitoria-Gasteiz",
          comunidad: "Pa칤s Vasco",
          left: "45%",
          top: "22%",
        },
        { nombre: "Pamplona", comunidad: "Navarra", left: "53%", top: "23%" },
        { nombre: "Logro침o", comunidad: "La Rioja", left: "53%", top: "28%" },
        { nombre: "Zaragoza", comunidad: "Arag칩n", left: "60%", top: "33%" },
        { nombre: "Barcelona", comunidad: "Catalu침a", left: "80%", top: "34%" },

        {
          nombre: "Valladolid",
          comunidad: "Castilla y Le칩n",
          left: "35%",
          top: "35%",
        },
        {
          nombre: "Madrid",
          comunidad: "Comunidad de Madrid",
          left: "46%",
          top: "47%",
        },
        {
          nombre: "Toledo",
          comunidad: "Castilla-La Mancha",
          left: "46%",
          top: "55%",
        },

        { nombre: "M칠rida", comunidad: "Extremadura", left: "26%", top: "58%" },
        { nombre: "Sevilla", comunidad: "Andaluc칤a", left: "26%", top: "73%" },
        { nombre: "Murcia", comunidad: "Regi칩n de Murcia", left: "64%", top: "72%" },
        {
          nombre: "Valencia",
          comunidad: "Comunidad Valenciana",
          left: "76%",
          top: "60%",
        },

        // Baleares
        {
          nombre: "Palma de Mallorca",
          comunidad: "Illes Balears",
          left: "88%",
          top: "60%",
        },

        // Ciudades aut칩nomas
        {
          nombre: "Ceuta",
          comunidad: "Ciudad Aut칩noma de Ceuta",
          left: "55%",
          top: "84%",
        },
        {
          nombre: "Melilla",
          comunidad: "Ciudad Aut칩noma de Melilla",
          left: "62%",
          top: "86%",
        },

        // Canarias
        {
          nombre: "Santa Cruz de Tenerife",
          comunidad: "Canarias",
          left: "18%",
          top: "88%",
        },
        {
          nombre: "Las Palmas de Gran Canaria",
          comunidad: "Canarias",
          left: "25%",
          top: "86%",
        },
      ];

      function MapaConBanderas({ onClickMapa }) {
        return (
          <div className="relative mb-3 flex justify-center">
            <img
              src="mapa_regiones.png"
              alt="Mapa de Espa침a por provincias"
              className="w-full max-w-md rounded-xl border border-gray-300 select-none"
            />
            <button
              type="button"
              className="absolute inset-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500"
              onClick={onClickMapa}
            >
              <span className="sr-only">
                Abrir selector de provincia / regi칩n
              </span>
            </button>

            {CAPITALES.map((c, idx) => (
              <div
                key={idx}
                className="absolute pointer-events-none -translate-x-1/2 -translate-y-full"
                style={{ left: c.left, top: c.top }}
                title={`${c.nombre} 췅 ${c.comunidad}`}
              >
                <span className="text-xl drop-shadow-[0_0_2px_rgba(0,0,0,0.8)]">
                  游뛀
                </span>
              </div>
            ))}
          </div>
        );
      }

      // =====================================
      // 6. COMPONENTE PRINCIPAL
      // =====================================

      function App() {
        const [pin, setPin] = useState("");
        const [authorized, setAuthorized] = useState(false);

        // Filtros listado centros
        const [search, setSearch] = useState("");
        const [filterCodigo, setFilterCodigo] = useState("");
        const [filterPropietario, setFilterPropietario] = useState("");
        const [filterCentro, setFilterCentro] = useState("");
        const [filterProvincia, setFilterProvincia] = useState("");
        const [filterDelegado, setFilterDelegado] = useState("");
        const [filterResponsableAudio, setFilterResponsableAudio] =
          useState("");
        const [filterCentroAAR, setFilterCentroAAR] = useState("");
        const [filterCorreo, setFilterCorreo] = useState("");

        const [storesInput, setStoresInput] = useState("");
        const [stores, setStores] = useState([]);
        const [expandedStoreId, setExpandedStoreId] = useState(null);
        const [dashboardStoreId, setDashboardStoreId] = useState(null);
        const [showCarga, setShowCarga] = useState(false);
        const [lastSavedAt, setLastSavedAt] = useState(null);

        // Centros exclusivos (para ventas/objetivos)
        const [expandedExclusiveId, setExpandedExclusiveId] = useState(null);
        const [selectedSalesMonth, setSelectedSalesMonth] = useState(
          EXCLUSIVE_MONTHS[0].key
        );
        const [selectedTargetMonth, setSelectedTargetMonth] = useState(
          EXCLUSIVE_MONTHS[0].key
        );

        // Tablas de procesos
        const [showAAOTable, setShowAAOTable] = useState(false);
        const [showExclusiveTable, setShowExclusiveTable] = useState(false);
        const [headerExcels, setHeaderExcels] = useState([]);
        const [selectedRegionDelegado, setSelectedRegionDelegado] =
          useState("");
        const [delegadoSearch, setDelegadoSearch] = useState("");
        const [selectedProvinciaMapa, setSelectedProvinciaMapa] = useState("");
        const [showRegionSelector, setShowRegionSelector] = useState(false);

        // 6.1 Cargar de "nube" (localStorage)
        useEffect(() => {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const normalizedStores = parsed.stores.map((s, idx) => {
                const centroNorm = normalizarCentro(s.centro || "");
                const isExclusive = EXCLUSIVE_CENTER_SET.has(
                  normalizeBasic(centroNorm)
                );
                return {
                  ...s,
                  id: idx + 1,
                  centroRegional: normalizarDelegado(s.centroRegional || ""),
                  visitaAudio: s.visitaAudio || "",
                  visitas: (s.visitas || []).map((v, i) => ({
                    id: v.id || i + 1,
                    fecha: v.fecha || "",
                    responsable: v.responsable || "",
                    excelName: v.excelName || "",
                    excelUrl: null,
                    hit: v.hit || "",
                    checklist:
                      typeof v.checklist === "number" ? v.checklist : null,
                    centroAAR: v.centroAAR || "",
                    processPoints: v.processPoints || [],
                  })),
                  isExclusive,
                  exclusiveData: isExclusive
                    ? {
                        ventas:
                          (s.exclusiveData && s.exclusiveData.ventas) || {},
                        objetivos:
                          (s.exclusiveData && s.exclusiveData.objetivos) || {},
                        acciones:
                          (s.exclusiveData && s.exclusiveData.acciones) || [],
                      }
                    : undefined,
                };
              });
              setStores(normalizedStores);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
          } catch (e) {
            console.error("Error al cargar de la nube/localStorage", e);
          }
        }, []);

        function handlePin() {
          if (pin.trim().toUpperCase() === "AR4321") setAuthorized(true);
        }

        // 6.2 Carga listado de tiendas (pegar desde Excel)

        function handleApplyStores() {
          if (!storesInput.trim()) return;
          let lines = storesInput
            .split("\n")
            .map((line) => line.trim())
            .filter(Boolean);

          if (
            lines.length > 0 &&
            lines[0].toUpperCase().includes("CODIGO") &&
            lines[0].toUpperCase().includes("PROPIETARIO")
          ) {
            lines = lines.slice(1);
          }

          const newStores = lines.map((raw, index) => {
            const parts = raw.split("\t");
            const [
              codigo = "",
              propietario = "",
              centro = "",
              provincia = "",
              correo = "",
              centroRegional = "",
              visitaAudio = "",
            ] = parts;
            const provinciaInferida = inferProvincia(centro, provincia);
            const delegadoNormalizado = normalizarDelegado(centroRegional);
            const centroNorm = normalizarCentro(centro);
            const isExclusive = EXCLUSIVE_CENTER_SET.has(
              normalizeBasic(centroNorm)
            );
            const visitaAudioLimpia = normalizarDelegado(visitaAudio);
            return {
              id: index + 1,
              raw,
              codigo,
              propietario,
              centro,
              provincia: provinciaInferida,
              correo,
              centroRegional: delegadoNormalizado,
              visitaAudio: visitaAudioLimpia,
              region: "",
              responsableAudio: visitaAudioLimpia,
              centroAAR: "",
              visitas: createEmptyVisits(),
              isExclusive,
              exclusiveData: isExclusive ? defaultExclusiveData() : undefined,
            };
          });

          setStores(newStores);
          setExpandedStoreId(null);
          setDashboardStoreId(null);
        }

        function updateStoreField(id, field, value) {
          setStores((prev) =>
            prev.map((store) =>
              store.id === id ? { ...store, [field]: value } : store
            )
          );
        }

        function updateVisitField(storeId, visitId, field, value) {
          setStores((prev) =>
            prev.map((store) => {
              if (store.id !== storeId) return store;
              return {
                ...store,
                visitas: store.visitas.map((visit) =>
                  visit.id === visitId ? { ...visit, [field]: value } : visit
                ),
              };
            })
          );
        }

        function handleChecklistFileChange(storeId, visitId, event) {
          const file = event.target.files && event.target.files[0];
          if (!file) return;

          const objectUrl = URL.createObjectURL(file);

          updateVisitField(storeId, visitId, "excelName", file.name);
          updateVisitField(storeId, visitId, "excelUrl", objectUrl);

          const reader = new FileReader();
          const isExcel =
            file.name.toLowerCase().endsWith(".xlsx") ||
            file.name.toLowerCase().endsWith(".xls");

          reader.onload = (ev) => {
            try {
              const data = ev.target.result;
              let checklistFromF90Set = false;

              if (window.XLSX) {
                let wb;
                if (isExcel) {
                  wb = XLSX.read(data, { type: "array" });
                } else {
                  const textData =
                    typeof data === "string"
                      ? data
                      : new TextDecoder("utf-8").decode(data);
                  wb = XLSX.read(textData, { type: "string" });
                }

                const puntos = extractProcessPointsFromWorkbook(wb);
                updateVisitField(storeId, visitId, "processPoints", puntos);

                let sheetName = wb.SheetNames[0];

                const preferredSheets = [
                  "PROCESOS BASICOS",
                  "PROCESOS B츼SICOS",
                  "PROCESOS Y BASICOS",
                  "PROCESOS Y B츼SICOS",
                  "CHECKLIST CORNER",
                  "CHECKLIST C.EXCL",
                  "CHECKLIST C EXCL",
                  "CHECKLIST CEXCL",
                  "BASICOS",
                  "B츼SICOS",
                ];

                for (const pref of preferredSheets) {
                  const found = wb.SheetNames.find(
                    (name) =>
                      name.toUpperCase().replace(/\s+/g, "") ===
                      pref.toUpperCase().replace(/\s+/g, "")
                  );
                  if (found) {
                    sheetName = found;
                    break;
                  }
                }

                const sheet = wb.Sheets[sheetName];
                if (sheet) {
                  const cell = sheet["F90"] || sheet["F104"];
                  if (cell && cell.v != null) {
                    let rawVal = cell.v;
                    let v = null;
                    if (typeof rawVal === "number") {
                      v = rawVal;
                    } else if (typeof rawVal === "string") {
                      const m = rawVal
                        .replace(",", ".")
                        .match(/(\d{1,3}(?:\.\d+)?)/);
                      if (m) v = parseFloat(m[1]);
                    }
                    if (v !== null) {
                      if (v <= 1) v = v * 100;
                      updateVisitField(storeId, visitId, "checklist", v);
                      checklistFromF90Set = true;
                    }
                  }
                }
              } else {
                const text =
                  typeof data === "string"
                    ? data
                    : new TextDecoder("utf-8").decode(data);
                parseFromText(text, false);
                return;
              }
            } catch (e) {
              console.error("Error leyendo Excel de checklist", e);
            }
          };

          if (isExcel) {
            reader.readAsArrayBuffer(file);
          } else {
            reader.readAsText(file);
          }

          function parseFromText(text, checklistAlreadySet) {
            if (!text) return;

            const reHit = /hit[^a-zA-Z0-9]{0,15}(s[i칤]|no)/i;
            const mHit = text.match(reHit);
            if (mHit) {
              const val = mHit[1].toLowerCase().startsWith("s") ? "S칤" : "No";
              updateVisitField(storeId, visitId, "hit", val);
            }

            if (!checklistAlreadySet) {
              const reCap =
                /capacitaci[o칩]n[^0-9%]{0,80}(\d{1,3})\s*%/i;
              const mCap = text.match(reCap);
              if (mCap) {
                const n = Number(mCap[1]);
                if (!isNaN(n)) {
                  updateVisitField(storeId, visitId, "checklist", n);
                }
              }
            }
          }
        }

        // 6.4 Guardar / cargar / exportar

        function handleHeaderExcelChange(event) {
          const files = Array.from(event.target.files || []).slice(0, 2);
          if (files.length === 0) {
            setHeaderExcels([]);
            return;
          }
          setHeaderExcels(files.map((f) => f.name));
        }

        function handleDownloadHtml() {
          try {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], {
              type: "text/html;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "seguimiento_audio.html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (e) {
            console.error("Error al descargar el HTML", e);
          }
        }

        function saveToCloud() {
          try {
            const payload = {
              stores,
              lastSavedAt: new Date().toISOString(),
            };
            localStorage.setItem("seguimientoAudioV1", JSON.stringify(payload));
            setLastSavedAt(payload.lastSavedAt);
          } catch (e) {
            console.error("Error al guardar en nube/localStorage", e);
          }
        }

        function loadFromCloud() {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const normalizedStores = parsed.stores.map((s, idx) => {
                const centroNorm = normalizarCentro(s.centro || "");
                const isExclusive = EXCLUSIVE_CENTER_SET.has(
                  normalizeBasic(centroNorm)
                );
                return {
                  ...s,
                  id: idx + 1,
                  centroRegional: normalizarDelegado(s.centroRegional || ""),
                  visitaAudio: s.visitaAudio || "",
                  visitas: (s.visitas || []).map((v, i) => ({
                    id: v.id || i + 1,
                    fecha: v.fecha || "",
                    responsable: v.responsable || "",
                    excelName: v.excelName || "",
                    excelUrl: null,
                    hit: v.hit || "",
                    checklist:
                      typeof v.checklist === "number" ? v.checklist : null,
                    centroAAR: v.centroAAR || "",
                    processPoints: v.processPoints || [],
                  })),
                  isExclusive,
                  exclusiveData: isExclusive
                    ? {
                        ventas:
                          (s.exclusiveData && s.exclusiveData.ventas) || {},
                        objetivos:
                          (s.exclusiveData && s.exclusiveData.objetivos) || {},
                        acciones:
                          (s.exclusiveData && s.exclusiveData.acciones) || [],
                      }
                    : undefined,
                };
              });
              setStores(normalizedStores);
              setExpandedStoreId(null);
              setDashboardStoreId(null);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
          } catch (e) {
            console.error("Error al leer de nube/localStorage", e);
          }
        }

        function downloadLocalFile() {
          try {
            const payload = {
              stores,
              lastSavedAt: new Date().toISOString(),
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], {
              type: "application/json;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "seguimiento_audio_backup.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (e) {
            console.error("Error al descargar copia local", e);
          }
        }

        function handlePrintPage() {
          window.print();
        }

        // FILTRADO LISTADO

        const filteredStores = stores.filter((store) => {
          const respAudio = deriveRespAudio(store);
          const centroAARValor = deriveCentroAAR(store);
          const textoGlobal = (
            store.codigo +
            " " +
            store.propietario +
            " " +
            store.centro +
            " " +
            store.provincia +
            " " +
            store.centroRegional +
            " " +
            store.correo +
            " " +
            respAudio +
            " " +
            centroAARValor
          )
            .toLowerCase()
            .trim();

          if (search && !textoGlobal.includes(search.toLowerCase())) return false;

          if (
            filterCodigo &&
            store.codigo.toLowerCase() !== filterCodigo.toLowerCase()
          )
            return false;

          if (
            filterPropietario &&
            store.propietario.toLowerCase() !== filterPropietario.toLowerCase()
          )
            return false;

          if (
            filterCentro &&
            store.centro.toLowerCase() !== filterCentro.toLowerCase()
          )
            return false;

          if (
            filterCorreo &&
            store.correo.toLowerCase() !== filterCorreo.toLowerCase()
          )
            return false;

          if (
            filterProvincia &&
            store.provincia.toLowerCase() !== filterProvincia.toLowerCase()
          )
            return false;

          if (
            filterDelegado &&
            store.centroRegional.toLowerCase() !== filterDelegado.toLowerCase()
          )
            return false;

          if (
            filterResponsableAudio &&
            respAudio.toLowerCase() !== filterResponsableAudio.toLowerCase()
          )
            return false;

          if (
            filterCentroAAR &&
            centroAARValor.toLowerCase() !== filterCentroAAR.toLowerCase()
          )
            return false;

          return true;
        });

        const sortedFilteredStores = [...filteredStores].sort((a, b) => {
          const va = (a.visitaAudio || "").toLowerCase();
          const vb = (b.visitaAudio || "").toLowerCase();

          function visitaScore(v) {
            if (v.includes("ariannys")) return 0;
            if (v.includes("sonia")) return 1;
            return 2;
          }

          const sa = visitaScore(va);
          const sb = visitaScore(vb);
          if (sa !== sb) return sa - sb;

          const da = (a.centroRegional || "").toLowerCase();
          const db = (b.centroRegional || "").toLowerCase();
          const cmpD = da.localeCompare(db, "es", { sensitivity: "base" });
          if (cmpD !== 0) return cmpD;

          const ca = (a.centro || "").toLowerCase();
          const cb = (b.centro || "").toLowerCase();
          return ca.localeCompare(cb, "es", { sensitivity: "base" });
        });

        const opcionesCodigo = getUniqueSorted(stores.map((s) => s.codigo));
        const opcionesPropietario = getUniqueSorted(
          stores.map((s) => s.propietario)
        );
        const opcionesCentro = getUniqueSorted(stores.map((s) => s.centro));
        const opcionesProvincia = getUniqueSorted(
          stores.map((s) => s.provincia)
        );
        const opcionesCorreo = getUniqueSorted(stores.map((s) => s.correo));
        const opcionesDelegado = getUniqueSorted(
          stores.map((s) => s.centroRegional)
        );
        const opcionesRespAudio = getUniqueSorted(
          stores.map((s) => deriveRespAudio(s))
        );

        const delegadosUnicos = opcionesDelegado.filter(
          (d) => d && d.trim().length > 0
        );

        function filterStoresByProvincia(baseStores, provinciaSeleccionada) {
          if (!provinciaSeleccionada) return baseStores;
          const target = normalizeBasic(provinciaSeleccionada || "");
          return baseStores.filter((s) => {
            const prov = normalizeBasic(s.provincia || "");
            return prov === target;
          });
        }

        const provinciasConDelegado = (() => {
          const map = new Map();
          stores.forEach((s) => {
            const prov = (s.provincia || "").trim();
            const del = s.centroRegional || "";
            if (!prov) return;
            const key = prov;
            if (!map.has(key)) {
              map.set(key, {
                delegado: del,
                totalCentros: 1,
              });
            } else {
              const current = map.get(key);
              current.totalCentros += 1;
              if (!current.delegado && del) {
                current.delegado = del;
              }
            }
          });

          return Array.from(map.entries())
            .map(([provincia, info]) => ({
              provincia,
              delegado: info.delegado || "",
              totalCentros: info.totalCentros || 0,
            }))
            .sort((a, b) =>
              (a.provincia || "").localeCompare(b.provincia || "", "es", {
                sensitivity: "base",
              })
            );
        })();

        // M칄TRICAS GLOBALES

        const allVisits = stores.flatMap((s) => s.visitas || []);
        const visitasValidasGlobal = allVisits.filter(
          (v) => v.excelName && v.excelName !== ""
        );
        const totalTiendas = stores.length;
        const tiendasConVisita = stores.filter((s) =>
          (s.visitas || []).some((v) => v.excelName && v.excelName !== "")
        ).length;
        const porcentajeTiendasVisitadas =
          totalTiendas > 0 ? (tiendasConVisita / totalTiendas) * 100 : 0;

        const checklistMediaGlobal = media(
          visitasValidasGlobal.map((v) => v.checklist)
        );
        const hitMediaGlobal = porcentajeSi(
          visitasValidasGlobal.map((v) => v.hit)
        );
        const aplicaHitGlobal = aplicaHitTexto(visitasValidasGlobal);

        const algunFechaInvalida = allVisits.some(
          (v) => v.fecha && !isValidFecha(v.fecha)
        );

        const dashboardStore =
          stores.find((s) => s.id === dashboardStoreId) || stores[0] || null;

        let dashVisitasConExcel = [];
        let dashChecklistMedio = null;
        let dashAplicaHit = null;

        if (dashboardStore) {
          dashVisitasConExcel = (dashboardStore.visitas || []).filter(
            (v) => v.excelName && v.excelName !== ""
          );
          dashChecklistMedio = media(
            dashVisitasConExcel.map((v) => v.checklist)
          );
          dashAplicaHit = aplicaHitTexto(dashVisitasConExcel);
        }

        const centrosNoExcl = stores.filter((s) => !s.isExclusive);
        const exclusiveStores = stores.filter((s) => s.isExclusive);

        const visitasNoExcl = centrosNoExcl
          .flatMap((s) => s.visitas || [])
          .filter((v) => v.checklist !== null && !isNaN(v.checklist));

        const visitasExcl = exclusiveStores
          .flatMap((s) => s.visitas || [])
          .filter((v) => v.checklist !== null && !isNaN(v.checklist));

        const checklistMediaNoExcl = media(
          visitasNoExcl.map((v) => v.checklist)
        );
        const checklistMediaExcl = media(visitasExcl.map((v) => v.checklist));

        const totalCentrosNoExcl = centrosNoExcl.length;
        const centrosNoExclConChecklist = centrosNoExcl.filter((s) =>
          (s.visitas || []).some((v) => v.excelName && v.excelName !== "")
        ).length;
        const pctCentrosNoExclConChecklist =
          totalCentrosNoExcl > 0
            ? (centrosNoExclConChecklist / totalCentrosNoExcl) * 100
            : 0;

        const totalCentros = stores.length;
        const centrosConHitSi = stores.filter((s) =>
          (s.visitas || []).some((v) => v.hit === "S칤")
        ).length;
        const hitAplicacionCentros =
          totalCentros > 0 ? (centrosConHitSi / totalCentros) * 100 : null;

        const centrosPropAAO = stores.filter((s) =>
          (s.propietario || "").toUpperCase().includes("AAO")
        );
        const totalCentrosPropAAO = centrosPropAAO.length;
        const centrosPropAAO_AAR = centrosPropAAO.filter(
          (s) => deriveCentroAAR(s) === "S칤"
        ).length;
        const pctCentrosPropAAO_AAR =
          totalCentrosPropAAO > 0
            ? (centrosPropAAO_AAR / totalCentrosPropAAO) * 100
            : null;

        const statsAAO = computeProcessStats(stores, false);
        const statsExclusive = computeProcessStats(stores, true);
        const {
          chartDataAAO,
          chartDataExclusive,
          avgAAO,
          avgExclusive,
        } = buildProcessChartData(statsAAO, statsExclusive);

        function getExclusiveTotals(store) {
          const data = store.exclusiveData || defaultExclusiveData();
          let ventasTotal = 0;
          let objetivosTotal = 0;
          EXCLUSIVE_MONTHS.forEach((m) => {
            ventasTotal += Number(data.ventas[m.key] || 0);
            objetivosTotal += Number(data.objetivos[m.key] || 0);
          });
          const pct =
            objetivosTotal > 0 ? (ventasTotal / objetivosTotal) * 100 : null;
          return { ventasTotal, objetivosTotal, pct };
        }

        let ventasAcumuladas = 0;
        let objetivosAcumulados = 0;
        exclusiveStores.forEach((s) => {
          const t = getExclusiveTotals(s);
          ventasAcumuladas += t.ventasTotal;
          objetivosAcumulados += t.objetivosTotal;
        });
        const pctAcumulado =
          objetivosAcumulados > 0
            ? (ventasAcumuladas / objetivosAcumulados) * 100
            : null;

        function resultColorClass(pct) {
          if (pct === null) return "bg-gray-200 text-gray-700";
          if (pct >= 100) return "bg-green-100 text-green-800";
          return "bg-red-100 text-red-700";
        }

        function updateExclusiveMonthValue(storeId, field, monthKey, value) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const existing = s.exclusiveData || defaultExclusiveData();
              return {
                ...s,
                exclusiveData: {
                  ...existing,
                  [field]: {
                    ...existing[field],
                    [monthKey]: value,
                  },
                },
              };
            })
          );
        }

        const ACTION_TYPES = [
          "Stand",
          "Mailing",
          "Cashback",
          "Azafata calle",
          "Ruleta",
          "Acci칩n colectivo",
          "Call center",
          "Acci칩n derivaci칩n tienda",
          "Derivaci칩n colectivo",
        ];

        function addExclusiveAction(storeId) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const data = s.exclusiveData || defaultExclusiveData();
              const nextId =
                data.acciones && data.acciones.length
                  ? Math.max(...data.acciones.map((a) => a.id || 0)) + 1
                  : 1;
              const nueva = {
                id: nextId,
                tipo: "",
                fecha: "",
                derivaciones: "",
              };
              return {
                ...s,
                exclusiveData: {
                  ...data,
                  acciones: [...data.acciones, nueva],
                },
              };
            })
          );
        }

        function updateExclusiveAction(storeId, actionId, field, value) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const data = s.exclusiveData || defaultExclusiveData();
              return {
                ...s,
                exclusiveData: {
                  ...data,
                  acciones: data.acciones.map((a) =>
                    a.id === actionId ? { ...a, [field]: value } : a
                  ),
                },
              };
            })
          );
        }

        function removeExclusiveAction(storeId, actionId) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const data = s.exclusiveData || defaultExclusiveData();
              return {
                ...s,
                exclusiveData: {
                  ...data,
                  acciones: data.acciones.filter((a) => a.id !== actionId),
                },
              };
            })
          );
        }

        // RENDER

        return (
          <div className="min-h-screen bg-gray-100 font-sans">
            {!authorized ? (
              <div className="flex items-center justify-center h-screen">
                <div className="bg-white p-10 rounded-2xl shadow-xl w-80">
                  <h2 className="text-xl font-bold text-center mb-4">
                    Acceso Plataforma
                  </h2>
                  <input
                    type="password"
                    className="w-full p-2 border rounded mb-4"
                    placeholder="Introduce PIN"
                    value={pin}
                    onChange={(e) => setPin(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === "Enter") handlePin();
                    }}
                  />
                  <button
                    onClick={handlePin}
                    className="w-full bg-blue-600 text-white py-2 rounded-xl shadow"
                  >
                    Entrar
                  </button>
                </div>
              </div>
            ) : (
              <div className="p-6">
                {/* HEADER */}
                <header className="bg-red-600 text-white p-5 rounded-2xl shadow flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-3xl">游꿚</span>
                    <div>
                      <h1 className="text-2xl font-bold">
                        Seguimiento de procesos de Audio
                      </h1>
                      <p className="text-xs text-red-100">
                        Departamento de Audiolog칤a 췅 Director:{" "}
                        <strong>David L칩pez</strong> 췅 Responsable T칠cnica:{" "}
                        <strong>Ariannys Rojas</strong> 췅 Delegada de Procesos:{" "}
                        <strong>Sonia</strong>
                      </p>
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <div className="flex gap-2">
                      <button
                        onClick={saveToCloud}
                        className="bg-white text-red-600 px-3 py-1 rounded-xl shadow text-xs font-semibold flex items-center gap-1"
                        title="Guardar en nube (navegador)"
                      >
                        游
                        <span>Guardar</span>
                      </button>
                      <button
                        onClick={loadFromCloud}
                        className="bg-red-500 text-white px-3 py-1 rounded-xl shadow text-xs font-semibold border border-white/40 flex items-center gap-1"
                        title="Leer desde nube (navegador)"
                      >
                        游댃
                        <span>Actualizar</span>
                      </button>
                      <button
                        onClick={downloadLocalFile}
                        className="bg-white/90 text-red-700 px-2 py-1 rounded-xl shadow text-xs font-semibold flex items-center gap-1"
                        title="Descargar copia local (JSON)"
                      >
                        游늬
                      </button>
                      <label
                        className="bg-white/90 text-red-700 px-2 py-1 rounded-xl shadow text-xs font-semibold flex items-center gap-1 cursor-pointer"
                        title="Adjuntar hasta 2 Excel globales"
                      >
                        游늹
                        <span>Adjuntar Excel+</span>
                        <input
                          type="file"
                          accept=".xlsx,.xls"
                          multiple
                          className="hidden"
                          onChange={handleHeaderExcelChange}
                        />
                      </label>
                      <button
                        onClick={handleDownloadHtml}
                        className="bg-white/90 text-red-700 px-2 py-1 rounded-xl shadow text-xs font-semibold flex items-center gap-1"
                        title="Descargar HTML completo"
                      >
                        游눹
                        <span>HTML</span>
                      </button>
                      <button
                        onClick={handlePrintPage}
                        className="bg-white/90 text-red-700 px-2 py-1 rounded-xl shadow text-xs font-semibold flex items-center gap-1"
                        title="Imprimir / PDF"
                      >
                        游둳勇
                      </button>
                    </div>
                    <p className="text-[10px] text-white/80">
                      칔ltima actualizaci칩n:{" "}
                      <span className="font-semibold">
                        {formatFechaHora(lastSavedAt)}
                      </span>
                    </p>
                  </div>
                </header>

                {/* CUADRO DE MANDO */}
                <section className="mt-6 space-y-4">
                  <h2 className="font-bold text-lg mb-2">Cuadro de mando</h2>

                  <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                    <ProcessCard
                      title="1. % aplicaci칩n de procesos  Centros AAO (no exclusivos)"
                      data={chartDataAAO}
                      avg={avgAAO}
                      showTable={showAAOTable}
                      onToggleTable={() =>
                        setShowAAOTable((prev) => !prev)
                      }
                      onExport={() =>
                        exportProcessCsv(
                          chartDataAAO,
                          "procesos_centros_AAO_no_exclusivos.csv"
                        )
                      }
                    />
                    <ProcessCard
                      title="2. % aplicaci칩n de procesos  Centros exclusivos"
                      data={chartDataExclusive}
                      avg={avgExclusive}
                      showTable={showExclusiveTable}
                      onToggleTable={() =>
                        setShowExclusiveTable((prev) => !prev)
                      }
                      onExport={() =>
                        exportProcessCsv(
                          chartDataExclusive,
                          "procesos_centros_exclusivos.csv"
                        )
                      }
                    />
                  </div>

                  <div className="mt-4">
                    <h3 className="font-bold text-sm mb-3">
                      Dashboard general  KPIs
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                      <DonutCard
                        title="Checklist medio centros AAO (no exclusivos)"
                        percent={checklistMediaNoExcl}
                        footer={`Centros no exclusivos: ${totalCentrosNoExcl} 췅 con al menos 1 checklist: ${centrosNoExclConChecklist} (${pctCentrosNoExclConChecklist.toFixed(
                          0
                        )}%)`}
                      />
                      <DonutCard
                        title="Checklist medio centros exclusivos"
                        percent={checklistMediaExcl}
                        footer={`Centros exclusivos: ${exclusiveStores.length}`}
                      />
                      <DonutCard
                        title="Aplicaci칩n HIT (centros)"
                        percent={hitAplicacionCentros}
                        footer={`Centros que aplican HIT: ${centrosConHitSi}/${totalCentros}`}
                      />
                      <DonutCard
                        title="% centros AAR activos (AAO)"
                        percent={pctCentrosPropAAO_AAR}
                        neutral={true}
                        footer={`Centros AAO con AAR: ${centrosPropAAO_AAR}/${totalCentrosPropAAO}`}
                      />
                    </div>
                  </div>

                  {algunFechaInvalida && (
                    <p className="text-xs text-red-500 mt-2">
                      Hay fechas con formato incorrecto. Usa siempre el formato{" "}
                      <strong>dd/mm/aaaa</strong>.
                    </p>
                  )}
                </section>

                {/* REGIONES */}
                <section className="mt-10 bg-white p-6 rounded-2xl shadow">
                  <h2 className="font-bold text-lg mb-4">REGIONES</h2>
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Mapa por regiones */}
                    <div className="p-4 bg-gray-100 rounded-2xl shadow-inner">
                      <h3 className="font-semibold mb-2 text-sm">
                        Mapa por regiones (t치ctil)
                      </h3>

                      <MapaConBanderas
                        onClickMapa={() => setShowRegionSelector(true)}
                      />

                      <p className="text-[11px] text-gray-600 text-center">
                        Toca el mapa para abrir el selector de provincias y ver
                        sus delegados y centros a la derecha.
                      </p>
                      {selectedProvinciaMapa && (
                        <p className="mt-2 text-[11px] text-center">
                          Filtro activo:{" "}
                          <span className="font-semibold">
                            {selectedProvinciaMapa}
                          </span>
                          <button
                            type="button"
                            className="ml-2 text-sky-600 underline"
                            onClick={() => setSelectedProvinciaMapa("")}
                          >
                            Quitar filtro
                          </button>
                        </p>
                      )}
                    </div>

                    {/* Delegados y centros */}
                    <div>
                      <h3 className="font-semibold mb-2 text-sm">
                        Delegados y centros
                      </h3>
                      {delegadosUnicos.length === 0 ? (
                        <p className="text-[11px] text-gray-500">
                          A칰n no hay delegados con centros asignados.
                        </p>
                      ) : (
                        <>
                          <div className="mb-3">
                            <input
                              type="text"
                              className="w-full border px-3 py-2 rounded text-sm"
                              placeholder="Buscar delegado o centro..."
                              value={delegadoSearch}
                              onChange={(e) =>
                                setDelegadoSearch(e.target.value)
                              }
                            />
                          </div>

                          <div className="mt-3 space-y-2 max-h-80 overflow-auto">
                            {delegadosUnicos.map((del) => {
                              const centrosDelTodos = stores.filter(
                                (s) => s.centroRegional === del
                              );
                              const centrosDel = filterStoresByProvincia(
                                centrosDelTodos,
                                selectedProvinciaMapa
                              );
                              if (centrosDel.length === 0) return null;

                              const searchTerm =
                                delegadoSearch.toLowerCase();
                              if (searchTerm) {
                                const matchDelegado = del
                                  .toLowerCase()
                                  .includes(searchTerm);
                                const matchCentro = centrosDel.some((s) => {
                                  const c = (s.centro || "").toLowerCase();
                                  const p = (s.provincia || "").toLowerCase();
                                  return (
                                    c.includes(searchTerm) ||
                                    p.includes(searchTerm)
                                  );
                                });
                                if (!matchDelegado && !matchCentro) {
                                  return null;
                                }
                              }

                              const isOpen = selectedRegionDelegado === del;
                              const count = centrosDel.length;
                              const color = delegadoColor(del) || {};
                              return (
                                <div
                                  key={del}
                                  className="border rounded-xl bg-gray-50"
                                >
                                  <button
                                    type="button"
                                    className="w-full flex items-center justify-between px-3 py-2 text-sm font-semibold cursor-pointer"
                                    style={{
                                      backgroundColor:
                                        color.backgroundColor || "#e5e7eb",
                                      color: color.color || "#111827",
                                    }}
                                    onClick={() =>
                                      setSelectedRegionDelegado(
                                        isOpen ? "" : del
                                      )
                                    }
                                  >
                                    <span>{del}</span>
                                    <span className="text-[11px] text-gray-600">
                                      {count} centro
                                      {count !== 1 ? "s" : ""}{" "}
                                      {isOpen ? "郊" : "郊"}
                                    </span>
                                  </button>
                                  {isOpen && (
                                    <ul className="text-[11px] list-disc pl-6 pr-3 pb-2">
                                      {centrosDel.map((s) => (
                                        <li key={s.id}>
                                          {s.centro || s.codigo} 닽" "}
                                          {s.provincia || "-"}
                                        </li>
                                      ))}
                                    </ul>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </>
                      )}
                    </div>
                  </div>

                  {/* Modal selector de provincia */}
                  {showRegionSelector && (
                    <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
                      <div className="bg-white rounded-2xl shadow-xl max-h-[80vh] w-full max-w-lg flex flex-col">
                        <div className="flex items-center justify-between border-b px-4 py-3">
                          <h4 className="font-semibold text-sm">
                            Selecciona provincia / regi칩n
                          </h4>
                          <button
                            type="button"
                            className="text-xs px-3 py-1 rounded-full border border-gray-300 hover:bg-gray-50"
                            onClick={() => setShowRegionSelector(false)}
                          >
                            Cerrar
                          </button>
                        </div>
                        <div className="p-3 overflow-y-auto space-y-2 text-sm">
                          {provinciasConDelegado.length === 0 ? (
                            <p className="text-xs text-gray-500">
                              A칰n no hay provincias con delegados asignados.
                            </p>
                          ) : (
                            provinciasConDelegado.map((p) => {
                              const color = delegadoColor(p.delegado) || {};
                              const isActive =
                                selectedProvinciaMapa &&
                                normalizeBasic(selectedProvinciaMapa) ===
                                  normalizeBasic(p.provincia || "");
                              return (
                                <button
                                  key={p.provincia}
                                  type="button"
                                  onClick={() => {
                                    setSelectedProvinciaMapa(p.provincia);
                                    setShowRegionSelector(false);
                                  }}
                                  className="w-full text-left rounded-xl border px-3 py-2 text-sm cursor-pointer"
                                  style={{
                                    backgroundColor:
                                      color.backgroundColor || "#f3f4f6",
                                    color: color.color || "#111827",
                                    borderColor: isActive
                                      ? "#0ea5e9"
                                      : "#e5e7eb",
                                  }}
                                >
                                  <div className="font-semibold uppercase text-xs tracking-wide">
                                    {p.provincia}
                                  </div>
                                  <div className="text-[11px] opacity-80">
                                    {p.delegado || "Sin delegado asignado"}
                                  </div>
                                  <div className="text-[10px] opacity-70 mt-1">
                                    {p.totalCentros} centro
                                    {p.totalCentros !== 1 ? "s" : ""}
                                  </div>
                                </button>
                              );
                            })
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </section>

                {/* LISTADO DE CENTROS */}
                <section className="mt-10 bg-white p-6 rounded-2xl shadow">
                  <div className="flex flex-col gap-4">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                      <h3 className="font-bold text-lg bg-red-600 text-white inline-flex items-center px-4 py-2 rounded-2xl">
                        LISTADO DE CENTROS
                      </h3>
                      <button
                        className="text-xs px-3 py-1 rounded-full border border-red-300 text-red-700 bg-white/80 hover:bg-white"
                        onClick={() => setShowCarga((p) => !p)}
                      >
                        {showCarga
                          ? "Ocultar edici칩n de listado"
                          : "Cargar / editar listado desde Excel"}
                      </button>
                    </div>

                    {showCarga && (
                      <div className="bg-gray-50 border rounded-2xl p-3">
                        <p className="text-xs text-gray-600 mb-2">
                          Pega aqu칤 el listado de centros desde Excel (una fila
                          por l칤nea, campos separados por tabulador):
                          <br />
                          <span className="font-semibold">
                            CODIGO 췅 PROPIETARIO 췅 CENTRO 췅 PROVINCIA 췅 CORREO 췅
                            REGIONAL
                          </span>
                        </p>
                        <textarea
                          className="w-full p-2 border rounded mb-2 text-xs h-20"
                          placeholder="Ejemplo:&#10;4ABB&#9;MAZA Oriol&#9;PAMPLONA C. Exclusivo&#9;NAVARRA&#9;navarra.pamplona.carrefour@afflelou.es&#9;Sonia Godino"
                          value={storesInput}
                          onChange={(e) => setStoresInput(e.target.value)}
                        ></textarea>
                        <button
                          onClick={handleApplyStores}
                          className="text-xs px-3 py-1 rounded-full bg-red-600 text-white font-semibold shadow"
                        >
                          Aplicar/actualizar listado
                        </button>
                      </div>
                    )}

                    {/* Fald칩n rojo buscador + filtros */}
                    <div className="bg-red-600 text-white rounded-2xl p-3">
                      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                        <div className="flex items-center gap-2 flex-1">
                          <span className="text-xl">游댌</span>
                          <input
                            type="text"
                            placeholder="Buscar en todos los campos."
                            className="flex-1 px-3 py-1 rounded text-xs text-gray-800"
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                          />
                        </div>
                        <div className="text-[10px] opacity-90 lg:text-right">
                          Filtros por columna: selecciona un valor en cualquier
                          desplegable para filtrar el listado (como en Excel).
                        </div>
                      </div>

                      <div className="mt-3 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-2 text-[11px]">
                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[110px]"
                          value={filterCodigo}
                          onChange={(e) => setFilterCodigo(e.target.value)}
                        >
                          <option value="">C칩digo (todos)</option>
                          {opcionesCodigo.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[130px]"
                          value={filterPropietario}
                          onChange={(e) =>
                            setFilterPropietario(e.target.value)
                          }
                        >
                          <option value="">Propietario (todos)</option>
                          {opcionesPropietario.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[160px]"
                          value={filterCentro}
                          onChange={(e) => setFilterCentro(e.target.value)}
                        >
                          <option value="">Centro (todos)</option>
                          {opcionesCentro.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[140px]"
                          value={filterProvincia}
                          onChange={(e) => setFilterProvincia(e.target.value)}
                        >
                          <option value="">Provincia (todas)</option>
                          {opcionesProvincia.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[140px]"
                          value={filterCorreo}
                          onChange={(e) => setFilterCorreo(e.target.value)}
                        >
                          <option value="">Correo (todos)</option>
                          {opcionesCorreo.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[150px]"
                          value={filterDelegado}
                          onChange={(e) => setFilterDelegado(e.target.value)}
                        >
                          <option value="">Delegado (todos)</option>
                          {opcionesDelegado.map((op) => (
                            <option key={op} value={op}>
                              {op || "Sin delegado"}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[150px]"
                          value={filterResponsableAudio}
                          onChange={(e) =>
                            setFilterResponsableAudio(e.target.value)
                          }
                        >
                          <option value="">Resp. audio (todos)</option>
                          {opcionesRespAudio.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[120px]"
                          value={filterCentroAAR}
                          onChange={(e) => setFilterCentroAAR(e.target.value)}
                        >
                          <option value="">Centro AAR (todos)</option>
                          <option value="S칤">S칤</option>
                          <option value="No">No</option>
                        </select>
                      </div>
                    </div>

                    {/* Tabla de centros */}
                    {stores.length === 0 ? (
                      <p className="text-xs text-gray-500">
                        A칰n no hay centros cargados. Pega el listado arriba y
                        pulsa "Aplicar/actualizar listado".
                      </p>
                    ) : (
                      <div className="overflow-y-auto">
                        <table className="w-full text-[11px] border-collapse">
                          <thead>
                            <tr className="bg-gray-50 border-b">
                              <th className="text-left px-2 py-2">N췈</th>
                              <th className="text-left px-2 py-2">C칩digo</th>
                              <th className="text-left px-2 py-2">
                                Propietario
                              </th>
                              <th className="text-left px-2 py-2">Centro</th>
                              <th className="text-left px-2 py-2">Provincia</th>
                              <th className="text-left px-2 py-2">Delegado</th>
                              <th className="text-left px-2 py-2">
                                Resp. audio
                              </th>
                              <th className="text-left px-2 py-2">
                                Centro AAR
                              </th>
                              <th className="text-left px-2 py-2">
                                Visitas / checklist
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {sortedFilteredStores.map((store, index) => {
                              const respAudio = deriveRespAudio(store);
                              const centroAARValor = deriveCentroAAR(store);
                              const isExpanded =
                                expandedStoreId === store.id;
                              return (
                                <React.Fragment key={store.id}>
                                  <tr className="border-b hover:bg-gray-50">
                                    <td className="px-2 py-2">
                                      {index + 1}
                                    </td>
                                    <td className="px-2 py-2">
                                      {store.codigo}
                                    </td>
                                    <td className="px-2 py-2">
                                      {store.propietario}
                                    </td>
                                    <td className="px-2 py-2">
                                      {store.centro}
                                    </td>
                                    <td className="px-2 py-2">
                                      {store.provincia}
                                    </td>
                                    <td className="px-2 py-2">
                                      {store.centroRegional || "-"}
                                    </td>
                                    <td className="px-2 py-2">
                                      {respAudio || "-"}
                                    </td>
                                    <td className="px-2 py-2">
                                      <select
                                        className="border rounded px-1 py-[2px]"
                                        value={centroAARValor}
                                        onChange={(e) =>
                                          updateStoreField(
                                            store.id,
                                            "centroAAR",
                                            e.target.value
                                          )
                                        }
                                      >
                                        <option value="">-</option>
                                        <option value="S칤">S칤</option>
                                        <option value="No">No</option>
                                      </select>
                                    </td>
                                    <td className="px-2 py-2">
                                      <button
                                        className="text-xs px-2 py-1 rounded-full border border-gray-300 hover:bg-gray-100"
                                        onClick={() =>
                                          setExpandedStoreId(
                                            isExpanded ? null : store.id
                                          )
                                        }
                                      >
                                        {isExpanded
                                          ? "Ocultar visitas"
                                          : "Ver visitas"}
                                      </button>
                                    </td>
                                  </tr>
                                  {isExpanded && (
                                    <tr className="bg-gray-50 border-b">
                                      <td
                                        className="px-2 py-2"
                                        colSpan={9}
                                      >
                                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-2">
                                          {store.visitas.map((v) => (
                                            <div
                                              key={v.id}
                                              className="border rounded-xl bg-white p-2 shadow-sm"
                                            >
                                              <p className="text-[10px] font-semibold mb-1">
                                                Visita {v.id}
                                              </p>
                                              <div className="space-y-1">
                                                <input
                                                  type="text"
                                                  className="w-full border rounded px-1 py-[2px] text-[10px]"
                                                  placeholder="Fecha (dd/mm/aaaa)"
                                                  value={v.fecha}
                                                  onChange={(e) =>
                                                    updateVisitField(
                                                      store.id,
                                                      v.id,
                                                      "fecha",
                                                      e.target.value
                                                    )
                                                  }
                                                />
                                                <input
                                                  type="text"
                                                  className="w-full border rounded px-1 py-[2px] text-[10px]"
                                                  placeholder="Responsable"
                                                  value={v.responsable}
                                                  onChange={(e) =>
                                                    updateVisitField(
                                                      store.id,
                                                      v.id,
                                                      "responsable",
                                                      e.target.value
                                                    )
                                                  }
                                                />
                                                <label className="block text-[10px] mt-1">
                                                  Checklist Excel:
                                                  <input
                                                    type="file"
                                                    accept=".xlsx,.xls"
                                                    className="mt-1 block w-full text-[9px]"
                                                    onChange={(e) =>
                                                      handleChecklistFileChange(
                                                        store.id,
                                                        v.id,
                                                        e
                                                      )
                                                    }
                                                  />
                                                </label>
                                                {v.excelName && (
                                                  <p className="text-[9px] text-gray-600">
                                                    {v.excelName}
                                                  </p>
                                                )}
                                                <div className="flex items-center justify-between mt-1">
                                                  <select
                                                    className="border rounded px-1 py-[2px] text-[10px]"
                                                    value={v.hit || ""}
                                                    onChange={(e) =>
                                                      updateVisitField(
                                                        store.id,
                                                        v.id,
                                                        "hit",
                                                        e.target.value
                                                      )
                                                    }
                                                  >
                                                    <option value="">
                                                      HIT
                                                    </option>
                                                    <option value="S칤">
                                                      S칤
                                                    </option>
                                                    <option value="No">
                                                      No
                                                    </option>
                                                  </select>
                                                  <input
                                                    type="number"
                                                    className="w-16 border rounded px-1 py-[2px] text-[10px] text-right"
                                                    placeholder="%"
                                                    value={
                                                      v.checklist ?? ""
                                                    }
                                                    onChange={(e) =>
                                                      updateVisitField(
                                                        store.id,
                                                        v.id,
                                                        "checklist",
                                                        e.target.value
                                                          ? Number(
                                                              e.target.value
                                                            )
                                                          : null
                                                      )
                                                    }
                                                  />
                                                </div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </td>
                                    </tr>
                                  )}
                                </React.Fragment>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                </section>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
