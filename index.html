<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Seguimiento de procesos de Audio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // =========================================================
      // CHECKLIST: etapas y criterios numerados
      // =========================================================

      const CHECKLIST = [
        {
          etapa: "HOLA",
          items: [
            "Espacio audio limpio, ordenado",
            "Esp칠culos, olivas y cascos desinfectados",
            "Acogida al cliente con una sonrisa, amable y cercana",
            "Llamar al paciente por su nombre",
            "Acompa침ar al paciente al gabinete para la revisi칩n auditiva",
            "Confirmar motivo de visita",
          ],
        },
        {
          etapa: "SOY 칔NICO",
          items: [
            "Abrir ficha y rellenar RGPD completa (incluidos checks comerciales)",
            "Realizar anamnesis HACE (H치bitos, Antecedentes, Cl칤nica, Expectativas)",
            "Anotar al menos 2 expectativas/necesidades concretas",
            "Recoger entorno sonoro y situaciones clave para el paciente",
          ],
        },
        {
          etapa: "MI AUDICI칍N",
          items: [
            "Explicar brevemente cada prueba y confirmar comprensi칩n",
            "Evaluar ambos o칤dos con videotoscopia y explicar procedimiento",
            "Realizar timpanometr칤a y explicar procedimiento",
            "Realizar v칤a a칠rea y v칤a 칩sea explicando cada paso",
            "Mantener TV encendida para comunicar audio y mostrar resultados",
          ],
        },
        {
          etapa: "MI SOLUCI칍N",
          items: [
            "Resumir claramente los resultados y su impacto",
            "Usar gr치ficas para apoyar la explicaci칩n (severidad, 치rea audible, fonemas)",
            "Vincular resultados con s칤ntomas y quejas de la anamnesis",
            "Hacer visible la p칠rdida auditiva con preguntas de implicaci칩n",
            "Simular sonidos para mostrar la diferencia con/ sin ayuda",
          ],
        },
        {
          etapa: "PRUEBO",
          items: [
            "Explicar la prueba de capacidad de adaptaci칩n como prueba de salud",
            "Escoger aud칤fono seg칰n perfil en gama adecuada (Diamante)",
            "Realizar programaci칩n inicial y ajustes seg칰n perfil",
            "Explicar funcionamiento y mantenimiento para llevarse aud칤fonos a casa",
            "Entregar documentaci칩n (contrato, presupuesto, pasaporte)",
          ],
        },
        {
          etapa: "ME COMPROMETO",
          items: [
            "Trabajar resoluci칩n de objeciones con lenguaje positivo",
            "Explicar facilidades de pago (Infinity / NextYear)",
            "Detallar pack Serenidad y Serenidad + (compromisos)",
            "Explicar en detalle pruebas HIT y su utilidad",
            "Recomendar accesorios de conectividad y productos de higiene",
          ],
        },
        {
          etapa: "ME CONVIERTO EN FAN",
          items: [
            "Explicar llamadas de seguimiento y agenda futura",
            "Reforzar logros y mejoras conseguidas en cada visita",
            "Aplicar t칠cnicas de Neuroventas en el seguimiento",
          ],
        },
        {
          etapa: "SEGUIMIENTO Y AGENDA",
          items: [
            "Registrar prueba en el sistema (Gio)",
            "Llamar al d칤a siguiente de la prueba para seguimiento",
            "Agendar visita en 4 d칤as para revisi칩n",
          ],
        },
        {
          etapa: "COMUNICACI칍N DEL CENTRO",
          items: [
            "Comunicaci칩n del centro adecuada a su perfil",
            "Revisi칩n de comunicaci칩n en RRSS",
            "Uniformidad adecuada",
            "Contacto con locales vecinos y colaboraciones",
            "Escaparate atractivo con novedad de producto",
          ],
        },
        {
          etapa: "AYUDAS Y ACUERDOS",
          items: [
            "Conocer y activar acuerdos con FIAPAS y ONCE",
            "Revisar convenios locales (anotar detalle en observaciones)",
            "Conocer ayudas de comunidad aut칩noma",
            "Conocer ayudas generales +65 a침os y hasta 26 a침os",
          ],
        },
        {
          etapa: "INCENTIVOS",
          items: ["Incentivos por derivaci칩n", "Incentivos por AAR"],
        },
        {
          etapa: "FORMACI칍N",
          items: [
            "Onboarding Academy realizado",
            "Formaciones obligatorias de centros exclusivos cumplimentadas",
            "Formaciones obligatorias de centros audio realizadas",
          ],
        },
      ];

      // aplanado 1..N
      const CHECKLIST_POINTS = [];
      const STAGE_OFFSETS = [];
      let globalCounter = 0;
      CHECKLIST.forEach((stage) => {
        STAGE_OFFSETS.push(globalCounter);
        stage.items.forEach((text) => {
          globalCounter += 1;
          CHECKLIST_POINTS.push({
            index: globalCounter,
            etapa: stage.etapa,
            text,
          });
        });
      });
      const TOTAL_POINTS = CHECKLIST_POINTS.length;

      // =========================================================
      // CONSTANTES CENTROS EXCLUSIVOS
      // =========================================================

      function normalizeName(str) {
        return (str || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toUpperCase()
          .trim();
      }

      const EXCLUSIVE_CENTER_NAMES = [
        "PAMPLONA C. EXCLUSIVO",
        "CC LOS VALLES",
        "SANTIAGO DE COMPOSTELA RUA DA ROSA",
        "CC PLAZA DE LA ESTACION",
        "REINA DE MERCEDES",
        "SANTANDER CC PE칌ACASTILLO",
        "TORRELAVEGA CARREFOUR CC",
        "ZARAGOZA CALLE DELICIAS",
      ].map(normalizeName);

      function isExclusiveCenter(centro) {
        return EXCLUSIVE_CENTER_NAMES.includes(normalizeName(centro));
      }

      const EXCLUSIVE_MONTHS = [
        { key: "2025-08", label: "Ago 2025" },
        { key: "2025-09", label: "Sep 2025" },
        { key: "2025-10", label: "Oct 2025" },
        { key: "2025-11", label: "Nov 2025" },
        { key: "2025-12", label: "Dic 2025" },
        { key: "2026-01", label: "Ene 2026" },
        { key: "2026-02", label: "Feb 2026" },
        { key: "2026-03", label: "Mar 2026" },
        { key: "2026-04", label: "Abr 2026" },
        { key: "2026-05", label: "May 2026" },
        { key: "2026-06", label: "Jun 2026" },
        { key: "2026-07", label: "Jul 2026" },
      ];

      const EXCLUSIVE_ACTION_OPTIONS = [
        "STAND",
        "MAILING",
        "CASHBACK",
        "AZAFATA CALLE",
        "RULETA",
        "ACCION COLECTIVO",
        "CALL CENTER",
        "ACCION DERIVACION TIENDA",
        "DERIVACI칍N COLECTIVO",
      ];

      // =========================================================
      // UTILIDADES
      // =========================================================

      function createEmptyVisits() {
        return [1, 2, 3, 4].map((id) => ({
          id,
          fecha: "",
          responsable: "",
          excelName: "",
          hit: "",
          checklist: null, // % global F90
          centroAAR: "",
          pointValues: new Array(TOTAL_POINTS).fill(null), // 0/1 por criterio
        }));
      }

      function normalizarDelegado(nombre) {
        const trimmed = (nombre || "").trim();
        if (!trimmed) return "";
        return trimmed
          .toLowerCase()
          .split(/\s+/)
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");
      }

      function parseFecha(fecha) {
        const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        const m = fecha.match(regex);
        if (!m) return null;
        const d = new Date(+m[3], +m[2] - 1, +m[1]);
        if (
          d.getFullYear() !== +m[3] ||
          d.getMonth() !== +m[2] - 1 ||
          d.getDate() !== +m[1]
        )
          return null;
        return d;
      }

      function isValidFecha(f) {
        if (!f) return true;
        return parseFecha(f) !== null;
      }

      function media(arr) {
        const nums = arr.filter((v) => typeof v === "number" && !isNaN(v));
        if (!nums.length) return null;
        return nums.reduce((a, b) => a + b, 0) / nums.length;
      }

      function porcentajeSi(arr) {
        const valid = arr.filter((v) => v === "S칤" || v === "No");
        if (!valid.length) return null;
        const si = valid.filter((v) => v === "S칤").length;
        return (si / valid.length) * 100;
      }

      function donutStyle(percent) {
        const value = percent && percent > 0 ? Math.min(percent, 100) : 0;
        const color =
          percent !== null && percent >= 85 ? "#16a34a" : "#dc2626";
        return {
          background: `conic-gradient(${color} ${value * 3.6}deg, #e5e7eb 0deg)`,
        };
      }

      function delegadoColor(texto) {
        if (!texto) return {};
        let hash = 0;
        const t = texto.trim().toUpperCase();
        for (let i = 0; i < t.length; i++) {
          hash = (hash * 31 + t.charCodeAt(i)) | 0;
        }
        const hue = (Math.abs(hash) % 360 + 180) % 360;
        return {
          backgroundColor: `hsl(${hue}, 75%, 90%)`,
          color: `hsl(${hue}, 35%, 28%)`,
        };
      }

      function getUniqueSorted(values) {
        const set = new Set(
          values.map((v) => (v || "").trim()).filter((v) => v.length)
        );
        return Array.from(set).sort((a, b) =>
          a.localeCompare(b, "es", { sensitivity: "base" })
        );
      }

      function aplicaHitTexto(visitas) {
        const hits = visitas.filter((v) => v.hit === "S칤" || v.hit === "No");
        if (!hits.length) return null;
        return hits.some((v) => v.hit === "S칤") ? "S칤" : "No";
      }

      function formatFechaHora(iso) {
        if (!iso) return "Sin guardado";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "Sin guardado";
        return d.toLocaleString("es-ES");
      }

      function deriveRespAudio(store) {
        if (store.responsableAudio && store.responsableAudio.trim())
          return store.responsableAudio;
        const visitas = store.visitas || [];
        const rev = [...visitas].reverse();
        const v = rev.find((x) => x.responsable);
        return v ? v.responsable : "";
      }

      function deriveCentroAAR(store) {
        const valores = (store.visitas || [])
          .map((v) => v.centroAAR)
          .filter((v) => v === "S칤" || v === "No");
        if (!valores.length) return "";
        return valores.includes("S칤") ? "S칤" : "No";
      }

      function computePointPercents(stores) {
        const sums = new Array(TOTAL_POINTS).fill(0);
        const counts = new Array(TOTAL_POINTS).fill(0);

        stores.forEach((s) => {
          (s.visitas || []).forEach((v) => {
            if (!Array.isArray(v.pointValues)) return;
            v.pointValues.forEach((val, idx) => {
              if (val === 0 || val === 1) {
                sums[idx] += val;
                counts[idx] += 1;
              }
            });
          });
        });

        return sums.map((sum, i) =>
          counts[i] ? (sum / counts[i]) * 100 : null
        );
      }

      // =========================================================
      // APP PRINCIPAL
      // =========================================================

      function App() {
        const [pin, setPin] = useState("");
        const [authorized, setAuthorized] = useState(false);

        const [storesInput, setStoresInput] = useState("");
        const [stores, setStores] = useState([]);
        const [expandedStoreId, setExpandedStoreId] = useState(null);
        const [dashboardStoreId, setDashboardStoreId] = useState(null);
        const [expandedExclusiveId, setExpandedExclusiveId] = useState(null);

        const [search, setSearch] = useState("");
        const [filterCodigo, setFilterCodigo] = useState("");
        const [filterPropietario, setFilterPropietario] = useState("");
        const [filterCentro, setFilterCentro] = useState("");
        const [filterProvincia, setFilterProvincia] = useState("");
        const [filterDelegado, setFilterDelegado] = useState("");
        const [filterResponsableAudio, setFilterResponsableAudio] =
          useState("");
        const [filterCentroAAR, setFilterCentroAAR] = useState("");
        const [filterCorreo, setFilterCorreo] = useState("");

        const [showCarga, setShowCarga] = useState(false);
        const [lastSavedAt, setLastSavedAt] = useState(null);

        const [hoverPointIdx, setHoverPointIdx] = useState(null);

        // ----------- CARGA INICIAL DESDE NUBE (localStorage)
        useEffect(() => {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const norm = parsed.stores.map((s, idx) => ({
                ...s,
                id: idx + 1,
                centroRegional: normalizarDelegado(s.centroRegional || ""),
                visitas: (s.visitas || []).map((v) => ({
                  ...v,
                  pointValues: Array.isArray(v.pointValues)
                    ? v.pointValues
                    : new Array(TOTAL_POINTS).fill(null),
                })),
                exclusive:
                  s.exclusive !== undefined
                    ? s.exclusive
                    : isExclusiveCenter(s.centro),
                exclusiveMonths: s.exclusiveMonths || {},
                exclusiveActions: s.exclusiveActions || [],
              }));
              setStores(norm);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
          } catch (e) {
            console.error("Error cargando localStorage", e);
          }
        }, []);

        function handlePin() {
          if (pin.trim().toUpperCase() === "AR4321") setAuthorized(true);
        }

        // --------- LISTADO DE CENTROS DESDE TEXTO PEGADO
        function handleApplyStores() {
          if (!storesInput.trim()) return;
          let lines = storesInput
            .split("\n")
            .map((l) => l.trim())
            .filter(Boolean);

          if (
            lines[0] &&
            lines[0].toUpperCase().includes("CODIGO") &&
            lines[0].toUpperCase().includes("PROPIETARIO")
          ) {
            lines = lines.slice(1);
          }

          const newStores = lines.map((raw, index) => {
            const parts = raw.split("\t");
            const [
              codigo = "",
              propietario = "",
              centro = "",
              provincia = "",
              correo = "",
              centroRegional = "",
            ] = parts;
            return {
              id: index + 1,
              raw,
              codigo,
              propietario,
              centro,
              provincia: (provincia || "").trim().toUpperCase(),
              correo,
              centroRegional: normalizarDelegado(centroRegional),
              region: "",
              responsableAudio: "",
              centroAAR: "",
              visitas: createEmptyVisits(),
              exclusive: isExclusiveCenter(centro),
              exclusiveMonths: {},
              exclusiveActions: [],
            };
          });

          setStores(newStores);
          setExpandedStoreId(null);
          setDashboardStoreId(null);
          setExpandedExclusiveId(null);
        }

        function updateVisitField(storeId, visitId, field, value) {
          setStores((prev) =>
            prev.map((s) =>
              s.id !== storeId
                ? s
                : {
                    ...s,
                    visitas: s.visitas.map((v) =>
                      v.id === visitId ? { ...v, [field]: value } : v
                    ),
                  }
            )
          );
        }

        // ---------- EXCLUSIVOS: VENTAS / OBJETIVO / ACCIONES ----------
        function updateExclusiveMonth(storeId, monthKey, field, value) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const months = s.exclusiveMonths || {};
              const prevMonth = months[monthKey] || {};
              return {
                ...s,
                exclusiveMonths: {
                  ...months,
                  [monthKey]: {
                    ...prevMonth,
                    [field]: value,
                  },
                },
              };
            })
          );
        }

        function addExclusiveAction(storeId) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const actions = s.exclusiveActions || [];
              const newAction = {
                id:
                  Date.now().toString() +
                  Math.random().toString(36).slice(2),
                tipo: "",
                fecha: "",
                derivaciones: "",
                notas: "",
              };
              return { ...s, exclusiveActions: [...actions, newAction] };
            })
          );
        }

        function updateExclusiveAction(storeId, actionId, field, value) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const actions = s.exclusiveActions || [];
              return {
                ...s,
                exclusiveActions: actions.map((a) =>
                  a.id === actionId ? { ...a, [field]: value } : a
                ),
              };
            })
          );
        }

        function removeExclusiveAction(storeId, actionId) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const actions = s.exclusiveActions || [];
              return {
                ...s,
                exclusiveActions: actions.filter((a) => a.id !== actionId),
              };
            })
          );
        }

        // ---------- LECTURA DEL EXCEL DE CHECKLIST ----------
        function handleChecklistFileChange(storeId, visitId, event) {
          const file = event.target.files?.[0];
          if (!file) return;

          updateVisitField(storeId, visitId, "excelName", file.name);

          const reader = new FileReader();
          const isExcel =
            file.name.toLowerCase().endsWith(".xlsx") ||
            file.name.toLowerCase().endsWith(".xls");

          reader.onload = (ev) => {
            try {
              const data = ev.target.result;
              if (isExcel && window.XLSX) {
                const wb = XLSX.read(data, { type: "array" });

                const candidates = [
                  "PROCESOS BASICOS",
                  "PROCESOS B츼SICOS",
                  "PROCESOS Y BASICOS",
                  "PROCESOS Y B츼SICOS",
                ];
                let sheetName = wb.SheetNames[0];
                for (const name of candidates) {
                  if (wb.Sheets[name]) {
                    sheetName = name;
                    break;
                  }
                }
                const sheet = wb.Sheets[sheetName];

                // F90 -> % checklist global
                let checklistF90 = null;
                const cell = sheet["F90"];
                if (cell && cell.v != null) {
                  let rawVal = cell.v;
                  if (typeof rawVal === "number") {
                    let v = rawVal;
                    if (v <= 1) v = v * 100;
                    checklistF90 = v;
                  } else if (typeof rawVal === "string") {
                    const m = rawVal
                      .replace(",", ".")
                      .match(/(\d{1,3}(?:\.\d+)?)/);
                    if (m) {
                      let v = parseFloat(m[1]);
                      if (v <= 1) v = v * 100;
                      checklistF90 = v;
                    }
                  }
                }
                if (checklistF90 !== null && !isNaN(checklistF90)) {
                  updateVisitField(storeId, visitId, "checklist", checklistF90);
                }

                // Punto a punto: columna B texto, F = 0/1
                const pointValues = new Array(TOTAL_POINTS).fill(null);
                let idx = 0;
                for (let row = 1; row < 1000 && idx < TOTAL_POINTS; row++) {
                  const cB = sheet["B" + row];
                  const cF = sheet["F" + row];
                  if (!cB || String(cB.v).trim() === "") continue;
                  const rawF = cF ? cF.v : null;
                  if (
                    rawF === 0 ||
                    rawF === 1 ||
                    rawF === "0" ||
                    rawF === "1"
                  ) {
                    pointValues[idx] = Number(rawF);
                    idx++;
                  }
                }
                updateVisitField(storeId, visitId, "pointValues", pointValues);

                // Texto para HIT
                const csv = XLSX.utils.sheet_to_csv(sheet);
                parseFromText(csv);
              } else {
                const text =
                  typeof data === "string"
                    ? data
                    : new TextDecoder("utf-8").decode(data);
                parseFromText(text);
              }
            } catch (e) {
              console.error("Error leyendo Excel", e);
            }
          };

          if (isExcel) reader.readAsArrayBuffer(file);
          else reader.readAsText(file);

          function parseFromText(text) {
            if (!text) return;
            const reHit = /hit[^a-zA-Z0-9]{0,15}(s[i칤]|no)/i;
            const mHit = text.match(reHit);
            if (mHit) {
              const val = mHit[1].toLowerCase().startsWith("s")
                ? "S칤"
                : "No";
              updateVisitField(storeId, visitId, "hit", val);
            }
          }
        }

        // ---------- GUARDAR / CARGAR EN NUBE (localStorage) ----------
        function saveToCloud() {
          try {
            const payload = {
              stores,
              lastSavedAt: new Date().toISOString(),
            };
            localStorage.setItem(
              "seguimientoAudioV1",
              JSON.stringify(payload)
            );
            setLastSavedAt(payload.lastSavedAt);
          } catch (e) {
            console.error("Error guardando", e);
          }
        }

        function loadFromCloud() {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const norm = parsed.stores.map((s, idx) => ({
                ...s,
                id: idx + 1,
                centroRegional: normalizarDelegado(s.centroRegional || ""),
                visitas: (s.visitas || []).map((v) => ({
                  ...v,
                  pointValues: Array.isArray(v.pointValues)
                    ? v.pointValues
                    : new Array(TOTAL_POINTS).fill(null),
                })),
                exclusive:
                  s.exclusive !== undefined
                    ? s.exclusive
                    : isExclusiveCenter(s.centro),
                exclusiveMonths: s.exclusiveMonths || {},
                exclusiveActions: s.exclusiveActions || [],
              }));
              setStores(norm);
              setExpandedStoreId(null);
              setDashboardStoreId(null);
              setExpandedExclusiveId(null);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
          } catch (e) {
            console.error("Error cargando", e);
          }
        }

        // ---------- FILTROS Y M칄TRICAS GENERALES ----------
        const filteredStores = stores.filter((s) => {
          const respAudio = deriveRespAudio(s);
          const centroAARValor = deriveCentroAAR(s);
          const texto = `${s.codigo} ${s.propietario} ${s.centro} ${
            s.provincia
          } ${s.centroRegional} ${s.correo} ${respAudio} ${centroAARValor}`.toLowerCase();

          if (search && !texto.includes(search.toLowerCase())) return false;
          if (filterCodigo && s.codigo.toLowerCase() !== filterCodigo.toLowerCase())
            return false;
          if (
            filterPropietario &&
            s.propietario.toLowerCase() !== filterPropietario.toLowerCase()
          )
            return false;
          if (filterCentro && s.centro.toLowerCase() !== filterCentro.toLowerCase())
            return false;
          if (
            filterProvincia &&
            s.provincia.toLowerCase() !== filterProvincia.toLowerCase()
          )
            return false;
          if (
            filterDelegado &&
            s.centroRegional.toLowerCase() !== filterDelegado.toLowerCase()
          )
            return false;
          if (
            filterResponsableAudio &&
            deriveRespAudio(s).toLowerCase() !==
              filterResponsableAudio.toLowerCase()
          )
            return false;
          if (
            filterCentroAAR &&
            centroAARValor.toLowerCase() !== filterCentroAAR.toLowerCase()
          )
            return false;
          if (
            filterCorreo &&
            (s.correo || "").toLowerCase() !== filterCorreo.toLowerCase()
          )
            return false;
          return true;
        });

        const sortedFilteredStores = [...filteredStores].sort((a, b) => {
          const da = (a.centroRegional || "").toLowerCase();
          const db = (b.centroRegional || "").toLowerCase();
          const cmp = da.localeCompare(db, "es", { sensitivity: "base" });
          if (cmp !== 0) return cmp;
          const ca = (a.centro || "").toLowerCase();
          const cb = (b.centro || "").toLowerCase();
          return ca.localeCompare(cb, "es", { sensitivity: "base" });
        });

        const opcionesCodigo = getUniqueSorted(stores.map((s) => s.codigo));
        const opcionesPropietario = getUniqueSorted(
          stores.map((s) => s.propietario)
        );
        const opcionesCentro = getUniqueSorted(stores.map((s) => s.centro));
        const opcionesProvincia = getUniqueSorted(
          stores.map((s) => s.provincia)
        );
        const opcionesCorreo = getUniqueSorted(stores.map((s) => s.correo));
        const opcionesDelegado = getUniqueSorted(
          stores.map((s) => s.centroRegional)
        );
        const opcionesRespAudio = getUniqueSorted(
          stores.map((s) => deriveRespAudio(s))
        );

        const allVisits = stores.flatMap((s) => s.visitas);
        const visitasValidas = allVisits.filter(
          (v) => v.excelName && v.excelName !== ""
        );
        const totalVisitas = visitasValidas.length;
        const totalTiendas = stores.length;
        const tiendasConVisita = stores.filter((s) =>
          s.visitas.some((v) => v.excelName && v.excelName !== "")
        ).length;
        const porcentajeTiendasVisitadas =
          totalTiendas > 0
            ? (tiendasConVisita / totalTiendas) * 100
            : 0;

        const checklistMediaGlobal = media(
          visitasValidas.map((v) => v.checklist)
        );
        const hitMediaGlobal = porcentajeSi(visitasValidas.map((v) => v.hit));
        const aplicaHitGlobal = aplicaHitTexto(visitasValidas);

        const algunFechaInvalida = allVisits.some(
          (v) => v.fecha && !isValidFecha(v.fecha)
        );

        const dashboardStore =
          stores.find((s) => s.id === dashboardStoreId) || stores[0] || null;

        let dashVisitas = [];
        let dashChecklist = null;
        let dashAplicaHit = null;
        if (dashboardStore) {
          dashVisitas = dashboardStore.visitas.filter(
            (v) => v.excelName && v.excelName !== ""
          );
          dashChecklist = media(dashVisitas.map((v) => v.checklist));
          dashAplicaHit = aplicaHitTexto(dashVisitas);
        }

        // ---------- DASHBOARD PUNTO A PUNTO ----------
        const pointPercents = computePointPercents(stores);
        const hasPointData = pointPercents.some(
          (p) => p !== null && !isNaN(p)
        );
        const chartPoints = pointPercents
          .map((pct, idx) =>
            pct === null
              ? null
              : {
                  idx,
                  num: CHECKLIST_POINTS[idx].index,
                  etapa: CHECKLIST_POINTS[idx].etapa,
                  text: CHECKLIST_POINTS[idx].text,
                  pct,
                }
          )
          .filter(Boolean);

        // ---------- CENTROS EXCLUSIVOS ----------
        const exclusiveStores = stores.filter((s) => s.exclusive);
        const exclusiveRows = [];
        let exclusiveVentasTotal = 0;
        let exclusiveObjetivoTotal = 0;

        for (const s of exclusiveStores) {
          const months = s.exclusiveMonths || {};
          let ventas = 0;
          let objetivo = 0;
          EXCLUSIVE_MONTHS.forEach(({ key }) => {
            const rec = months[key] || {};
            ventas += Number(rec.sales) || 0;
            objetivo += Number(rec.objetivo) || 0;
          });
          exclusiveVentasTotal += ventas;
          exclusiveObjetivoTotal += objetivo;
          const pct = objetivo > 0 ? (ventas / objetivo) * 100 : null;
          exclusiveRows.push({ store: s, ventas, objetivo, pct });
        }

        const exclusivePctTotal =
          exclusiveObjetivoTotal > 0
            ? (exclusiveVentasTotal / exclusiveObjetivoTotal) * 100
            : null;

        // ========== RENDER ==========
        if (!authorized) {
          return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
              <div className="bg-white p-10 rounded-2xl shadow-xl w-80">
                <h2 className="text-xl font-bold text-center mb-4">
                  Acceso Plataforma
                </h2>
                <p className="text-xs text-gray-500 mb-3">
                  Introduce el PIN para acceder a la plataforma de seguimiento
                  de audio.
                </p>
                <input
                  type="password"
                  className="w-full p-2 border rounded mb-4"
                  placeholder="Introduce PIN"
                  value={pin}
                  onChange={(e) => setPin(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === "Enter") handlePin();
                  }}
                />
                <button
                  onClick={handlePin}
                  className="w-full bg-red-600 text-white py-2 rounded-xl shadow font-semibold"
                >
                  Entrar
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gray-100">
            {/* HEADER */}
            <header className="bg-red-600 text-white p-5 rounded-b-3xl shadow flex items-center justify-between">
              <div className="flex items-center gap-4">
                <span className="text-4xl">游꿚</span>
                <div>
                  <h1 className="text-2xl font-bold">
                    Seguimiento de procesos de Audio
                  </h1>
                  <p className="text-xs text-red-100">
                    Checklist de visita, visitas por centro y KPIs.
                  </p>
                </div>
              </div>
              <div className="flex flex-col items-end gap-1">
                <div className="flex gap-2">
                  <button
                    onClick={saveToCloud}
                    className="bg-white text-red-600 px-3 py-1 rounded-xl shadow text-xs font-semibold"
                  >
                    Guardar en nube
                  </button>
                  <button
                    onClick={loadFromCloud}
                    className="bg-red-500 text-white px-3 py-1 rounded-xl shadow text-xs font-semibold border border-white/40"
                  >
                    Actualizar desde nube
                  </button>
                </div>
                <p className="text-[10px] text-red-100">
                  칔ltima actualizaci칩n:{" "}
                  <span className="font-semibold">
                    {formatFechaHora(lastSavedAt)}
                  </span>
                </p>
              </div>
            </header>

            <main className="p-6 space-y-10">
              {/* MAPA CHECKLIST */}
              <section className="bg-white p-6 rounded-2xl shadow">
                <h2 className="font-bold text-lg mb-2">
                  Mapa horizontal de checklist de visita
                </h2>
                <p className="text-gray-500 mb-4 text-sm">
                  Etapas del proceso de audio seg칰n el checklist oficial. Cada
                  criterio est치 numerado y se usa para el mapa de aplicaci칩n por
                  punto.
                </p>
                <div className="flex gap-4 overflow-x-auto pb-2">
                  {CHECKLIST.map((stage, stageIdx) => (
                    <div
                      key={stage.etapa}
                      className="min-w-[260px] max-w-xs bg-gray-50 border rounded-2xl px-4 py-3 flex-shrink-0"
                    >
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-[11px] font-bold uppercase tracking-wide text-red-700">
                          {stage.etapa}
                        </span>
                        <span className="text-[10px] text-gray-500">
                          {stage.items.length} pts
                        </span>
                      </div>
                      <ul className="space-y-1">
                        {stage.items.map((item, itemIdx) => {
                          const num = STAGE_OFFSETS[stageIdx] + itemIdx + 1;
                          return (
                            <li
                              key={itemIdx}
                              className="text-[11px] text-gray-700 flex gap-1"
                            >
                              <span className="mt-1 h-1.5 w-1.5 rounded-full bg-red-500 flex-shrink-0" />
                              <span className="leading-tight">
                                <span className="font-semibold mr-1">
                                  {num}.
                                </span>
                                {item}
                              </span>
                            </li>
                          );
                        })}
                      </ul>
                    </div>
                  ))}
                </div>
              </section>

              {/* DASHBOARD GENERAL Y POR CENTRO */}
              <section className="bg-white p-4 rounded-2xl shadow space-y-4">
                <h3 className="font-bold text-sm mb-1">
                  Dashboard horizontal (general y por centro)
                </h3>
                {stores.length === 0 ? (
                  <p className="text-xs text-gray-500">
                    A칰n no hay centros cargados. Pega el listado en la secci칩n
                    de LISTADO DE CENTROS.
                  </p>
                ) : (
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {/* GENERAL */}
                    <div className="bg-gray-50 rounded-2xl px-4 py-3 border flex flex-col gap-2">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <p className="text-xs font-semibold">
                            General red Afflelou Audio
                          </p>
                          <p className="text-[10px] text-gray-500">
                            Visitas con Excel adjunto (checklist).
                          </p>
                        </div>
                        <div
                          className="w-12 h-12 rounded-full flex items-center justify-center text-[10px] font-bold text-red-700"
                          style={donutStyle(checklistMediaGlobal)}
                        >
                          <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                            <span>
                              {checklistMediaGlobal !== null
                                ? `${checklistMediaGlobal.toFixed(0)}%`
                                : "--"}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="text-[10px] space-y-1">
                        <p>
                          Total centros: <strong>{totalTiendas}</strong> 췅 con
                          al menos 1 visita:{" "}
                          <strong>
                            {tiendasConVisita} (
                            {porcentajeTiendasVisitadas.toFixed(0)}%)
                          </strong>
                        </p>
                        <p>
                          Total visitas con checklist:{" "}
                          <strong>{totalVisitas}</strong>
                        </p>
                        <p>
                          Checklist medio global:{" "}
                          {checklistMediaGlobal !== null
                            ? `${checklistMediaGlobal.toFixed(0)}%`
                            : "-"}
                        </p>
                        <p>
                          % aplicaci칩n HIT global:{" "}
                          {hitMediaGlobal !== null
                            ? `${hitMediaGlobal.toFixed(0)}%`
                            : "-"}
                          {aplicaHitGlobal && (
                            <span>
                              {" "}
                              췅 Aplica HIT:{" "}
                              <strong>{aplicaHitGlobal}</strong>
                            </span>
                          )}
                        </p>
                      </div>
                    </div>

                    {/* POR CENTRO */}
                    <div className="bg-gray-50 rounded-2xl px-4 py-3 border flex flex-col gap-2">
                      <div className="flex items-center justify-between mb-2 gap-2">
                        <div className="flex-1">
                          <p className="text-xs font-semibold mb-1">
                            Detalle por centro
                          </p>
                          <select
                            className="w-full border rounded px-2 py-1 text-[11px]"
                            value={dashboardStoreId || ""}
                            onChange={(e) =>
                              setDashboardStoreId(
                                e.target.value ? Number(e.target.value) : null
                              )
                            }
                          >
                            {stores.length === 0 && (
                              <option>No hay centros</option>
                            )}
                            {stores.length > 0 && (
                              <>
                                <option value="">
                                  (Selecciona un centro)
                                </option>
                                {stores.map((s) => (
                                  <option key={s.id} value={s.id}>
                                    {s.centro || s.codigo}
                                  </option>
                                ))}
                              </>
                            )}
                          </select>
                        </div>
                        <div
                          className="w-12 h-12 rounded-full flex items-center justify-center text-[10px] font-bold text-red-700"
                          style={donutStyle(dashChecklist)}
                        >
                          <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                            <span>
                              {dashChecklist !== null
                                ? `${dashChecklist.toFixed(0)}%`
                                : "--"}
                            </span>
                          </div>
                        </div>
                      </div>
                      {dashboardStore ? (
                        <div className="text-[10px] space-y-1">
                          <p className="font-semibold">
                            {dashboardStore.centro || dashboardStore.codigo}
                          </p>
                          <p>
                            Provincia:{" "}
                            <span
                              className="inline-block px-2 py-0.5 rounded-full"
                              style={delegadoColor(
                                dashboardStore.centroRegional
                              )}
                            >
                              {dashboardStore.provincia || "Sin definir"}
                            </span>
                          </p>
                          <p>
                            N췈 visitas con checklist:{" "}
                            <strong>{dashVisitas.length}</strong>
                          </p>
                          <p>
                            Checklist medio:{" "}
                            {dashChecklist !== null
                              ? `${dashChecklist.toFixed(0)}%`
                              : "-"}
                          </p>
                          <p>
                            Aplica HIT:{" "}
                            <strong>{dashAplicaHit || "-"}</strong>
                          </p>
                        </div>
                      ) : (
                        <p className="text-[10px] text-gray-500">
                          Selecciona un centro en el desplegable superior.
                        </p>
                      )}
                    </div>
                  </div>
                )}

                {algunFechaInvalida && (
                  <p className="text-xs text-red-500 mt-2">
                    Hay fechas con formato incorrecto. Usa siempre el formato{" "}
                    <strong>dd/mm/aaaa</strong>.
                  </p>
                )}
              </section>

              {/* DASHBOARD PUNTO A PUNTO */}
              <section className="bg-white p-6 rounded-2xl shadow">
                <h3 className="font-bold text-sm mb-1">
                  Dashboard punto a punto del checklist
                </h3>
                <p className="text-[11px] text-gray-600 mb-3">
                  Basado en los Excels adjuntos (hoja{" "}
                  <strong>PROCESOS BASICOS / PROCESOS Y BASICOS</strong>,
                  columna F: 0 = no aplica, 1 = aplica). Cada punto corresponde
                  a un criterio numerado.
                </p>
                {!hasPointData ? (
                  <p className="text-xs text-gray-500">
                    A칰n no hay datos punto a punto. Adjunta al menos un Excel
                    checklist en alguna visita.
                  </p>
                ) : (
                  <div className="space-y-4">
                    <div className="bg-gray-50 border rounded-2xl px-4 py-3">
                      <svg
                        viewBox="0 0 100 100"
                        preserveAspectRatio="none"
                        className="w-full h-40"
                      >
                        <line
                          x1="0"
                          y1="90"
                          x2="100"
                          y2="90"
                          stroke="#9ca3af"
                          strokeWidth="0.4"
                        />
                        {[25, 50, 75].map((p) => (
                          <line
                            key={p}
                            x1="0"
                            y1={90 - p * 0.8}
                            x2="100"
                            y2={90 - p * 0.8}
                            stroke="#e5e7eb"
                            strokeWidth="0.3"
                            strokeDasharray="1 2"
                          />
                        ))}
                        {chartPoints.length > 1 && (
                          <path
                            d={
                              "M " +
                              chartPoints
                                .map((p, i) => {
                                  const x =
                                    (i /
                                      (chartPoints.length - 1 || 1)) *
                                    100;
                                  const y = 90 - p.pct * 0.8;
                                  return `${x} ${y}`;
                                })
                                .join(" L ")
                            }
                            fill="none"
                            stroke="#ef4444"
                            strokeWidth="0.7"
                            strokeLinejoin="round"
                            strokeLinecap="round"
                          />
                        )}
                        {chartPoints.map((p, i) => {
                          const x =
                            (i / (chartPoints.length - 1 || 1)) * 100;
                          const y = 90 - p.pct * 0.8;
                          const good = p.pct >= 85;
                          const color = good ? "#16a34a" : "#dc2626";
                          return (
                            <g key={p.idx}>
                              <circle
                                cx={x}
                                cy={y}
                                r={1.3}
                                fill={color}
                                stroke="#ffffff"
                                strokeWidth="0.4"
                                onMouseEnter={() =>
                                  setHoverPointIdx(p.idx)
                                }
                                onMouseLeave={() =>
                                  setHoverPointIdx(null)
                                }
                                style={{ cursor: "pointer" }}
                              />
                            </g>
                          );
                        })}
                      </svg>
                      <div className="flex justify-between text-[10px] text-gray-400 mt-1">
                        <span>1</span>
                        <span>{TOTAL_POINTS}</span>
                      </div>
                    </div>

                    <div className="bg-gray-50 border rounded-2xl px-4 py-3 text-[11px]">
                      {hoverPointIdx === null ? (
                        <p className="text-gray-500">
                          Pasa el rat칩n por encima de cualquier punto para ver
                          el criterio y su % medio de aplicaci칩n.
                        </p>
                      ) : (
                        (() => {
                          const pct = pointPercents[hoverPointIdx];
                          const info = CHECKLIST_POINTS[hoverPointIdx];
                          const good = pct >= 85;
                          return (
                            <div className="space-y-1">
                              <p className="font-semibold">
                                Punto {info.index} 췅 {info.etapa}
                              </p>
                              <p>{info.text}</p>
                              <p>
                                % medio de aplicaci칩n:{" "}
                                <span
                                  className={
                                    good
                                      ? "font-bold text-green-600"
                                      : "font-bold text-red-600"
                                  }
                                >
                                  {pct.toFixed(1)}%
                                </span>
                              </p>
                            </div>
                          );
                        })()
                      )}
                    </div>
                  </div>
                )}
              </section>

              {/* LISTADO DE CENTROS */}
              <section className="bg-white p-6 rounded-2xl shadow">
                <div className="flex flex-col gap-4">
                  <div className="flex flex-wrap items-center justify-between gap-3">
                    <h3 className="font-bold text-lg bg-red-600 text-white inline-flex items-center px-4 py-2 rounded-2xl">
                      LISTADO DE CENTROS
                    </h3>
                    <button
                      className="text-xs px-3 py-1 rounded-full border border-red-300 text-red-700 bg-white/80 hover:bg-white"
                      onClick={() => setShowCarga((p) => !p)}
                    >
                      {showCarga
                        ? "Ocultar edici칩n de listado"
                        : "Cargar / editar listado desde Excel"}
                    </button>
                  </div>

                  {showCarga && (
                    <div className="bg-gray-50 border rounded-2xl p-3">
                      <p className="text-xs text-gray-600 mb-2">
                        Pega aqu칤 el listado de centros desde Excel (una fila
                        por l칤nea, campos separados por tabulador):
                        <br />
                        <span className="font-semibold">
                          CODIGO 췅 PROPIETARIO 췅 CENTRO 췅 PROVINCIA 췅 CORREO 췅
                          REGIONAL
                        </span>
                      </p>
                      <textarea
                        className="w-full p-2 border rounded mb-2 text-xs h-20"
                        placeholder="Ejemplo:&#10;4ABB&#9;MAZA Oriol&#9;PAMPLONA C. Exclusivo&#9;NAVARRA&#9;navarra.pamplona.carrefour@afflelou.es&#9;Sonia Godino"
                        value={storesInput}
                        onChange={(e) => setStoresInput(e.target.value)}
                      ></textarea>
                      <button
                        onClick={handleApplyStores}
                        className="text-xs px-3 py-1 rounded-full bg-red-600 text-white font-semibold shadow"
                      >
                        Aplicar/actualizar listado
                      </button>
                    </div>
                  )}

                  {/* Fald칩n rojo buscador + filtros */}
                  <div className="bg-red-600 text-white rounded-2xl p-3">
                    <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                      <div className="flex items-center gap-2 flex-1">
                        <span className="text-xl">游댌</span>
                        <input
                          type="text"
                          placeholder="Buscar en todos los campos..."
                          className="flex-1 px-3 py-1 rounded text-xs text-gray-800"
                          value={search}
                          onChange={(e) => setSearch(e.target.value)}
                        />
                      </div>
                      <div className="text-[10px] opacity-90 lg:text-right">
                        Filtros por columna: selecciona un valor para filtrar el
                        listado (como en Excel).
                      </div>
                    </div>

                    <div className="mt-3 flex flex-nowrap gap-2 text-[11px] overflow-x-auto">
                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[110px]"
                        value={filterCodigo}
                        onChange={(e) => setFilterCodigo(e.target.value)}
                      >
                        <option value="">C칩digo (todos)</option>
                        {opcionesCodigo.map((op) => (
                          <option key={op} value={op}>
                            {op}
                          </option>
                        ))}
                      </select>

                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[130px]"
                        value={filterPropietario}
                        onChange={(e) =>
                          setFilterPropietario(e.target.value)
                        }
                      >
                        <option value="">Propietario (todos)</option>
                        {opcionesPropietario.map((op) => (
                          <option key={op} value={op}>
                            {op}
                          </option>
                        ))}
                      </select>

                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[160px]"
                        value={filterCentro}
                        onChange={(e) => setFilterCentro(e.target.value)}
                      >
                        <option value="">Centro (todos)</option>
                        {opcionesCentro.map((op) => (
                          <option key={op} value={op}>
                            {op}
                          </option>
                        ))}
                      </select>

                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[140px]"
                        value={filterProvincia}
                        onChange={(e) =>
                          setFilterProvincia(e.target.value)
                        }
                      >
                        <option value="">Provincia (todas)</option>
                        {opcionesProvincia.map((op) => (
                          <option key={op} value={op}>
                            {op}
                          </option>
                        ))}
                      </select>

                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[140px]"
                        value={filterCorreo}
                        onChange={(e) => setFilterCorreo(e.target.value)}
                      >
                        <option value="">Correo (todos)</option>
                        {opcionesCorreo.map((op) => (
                          <option key={op} value={op}>
                            {op}
                          </option>
                        ))}
                      </select>

                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[150px]"
                        value={filterDelegado}
                        onChange={(e) => setFilterDelegado(e.target.value)}
                      >
                        <option value="">Delegado (todos)</option>
                        {opcionesDelegado.map((op) => (
                          <option key={op} value={op}>
                            {op || "Sin delegado"}
                          </option>
                        ))}
                      </select>

                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[150px]"
                        value={filterResponsableAudio}
                        onChange={(e) =>
                          setFilterResponsableAudio(e.target.value)
                        }
                      >
                        <option value="">Resp. audio (todos)</option>
                        {opcionesRespAudio.map((op) => (
                          <option key={op} value={op}>
                            {op}
                          </option>
                        ))}
                      </select>

                      <select
                        className="bg-white text-red-700 rounded px-2 py-1 min-w-[120px]"
                        value={filterCentroAAR}
                        onChange={(e) => setFilterCentroAAR(e.target.value)}
                      >
                        <option value="">Centro AAR (todos)</option>
                        <option value="S칤">S칤</option>
                        <option value="No">No</option>
                      </select>
                    </div>
                  </div>

                  {/* Tabla centros */}
                  {stores.length === 0 ? (
                    <p className="text-xs text-gray-500">
                      A칰n no hay centros cargados. Pega el listado arriba y
                      pulsa "Aplicar/actualizar listado".
                    </p>
                  ) : (
                    <div className="overflow-y-auto">
                      <table className="w-full text-[11px] border-collapse">
                        <thead>
                          <tr className="bg-gray-50 border-b">
                            <th className="text-left px-2 py-2">N췈</th>
                            <th className="text-left px-2 py-2">C칩digo</th>
                            <th className="text-left px-2 py-2">
                              Propietario
                            </th>
                            <th className="text-left px-2 py-2">Centro</th>
                            <th className="text-left px-2 py-2">
                              Provincia
                            </th>
                            <th className="text-left px-2 py-2">Correo</th>
                            <th className="text-left px-2 py-2">
                              Delegado regional
                            </th>
                            <th className="text-left px-2 py-2">
                              Resp. audio
                            </th>
                            <th className="text-left px-2 py-2">
                              Centro AAR
                            </th>
                            <th className="text-right px-2 py-2">
                              N췈 visitas
                            </th>
                            <th className="text-right px-2 py-2">
                              Checklist medio %
                            </th>
                            <th className="text-right px-2 py-2">
                              Aplica HIT
                            </th>
                            <th className="text-center px-2 py-2">
                              Visitas / checklist (4)
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          {sortedFilteredStores.map((s, index) => {
                            const visitasConExcel = s.visitas.filter(
                              (v) => v.excelName && v.excelName !== ""
                            );
                            const checklistMedio = media(
                              visitasConExcel.map((v) => v.checklist)
                            );
                            const aplicaHitTienda =
                              aplicaHitTexto(visitasConExcel);
                            const respAudioCentro = deriveRespAudio(s);
                            const centroAARValor = deriveCentroAAR(s);
                            const isExpanded = expandedStoreId === s.id;

                            const checklistBadge =
                              checklistMedio !== null ? (
                                <span
                                  className={`inline-block min-w-[40px] px-2 py-0.5 rounded-full ${
                                    checklistMedio >= 85
                                      ? "bg-green-100 text-green-800"
                                      : "bg-red-100 text-red-700"
                                  }`}
                                >
                                  {checklistMedio.toFixed(0)}%
                                </span>
                              ) : (
                                "-"
                              );

                            return (
                              <React.Fragment key={s.id}>
                                <tr className="border-b hover:bg-gray-50 align-top">
                                  <td className="px-2 py-1">{index + 1}</td>
                                  <td className="px-2 py-1">
                                    <span className="font-semibold">
                                      {s.codigo || "-"}
                                    </span>
                                  </td>
                                  <td className="px-2 py-1">
                                    {s.propietario || "-"}
                                  </td>
                                  <td className="px-2 py-1">
                                    {s.centro || "-"}
                                  </td>
                                  <td className="px-2 py-1">
                                    <span
                                      className="inline-block px-2 py-0.5 rounded-full"
                                      style={delegadoColor(s.centroRegional)}
                                    >
                                      {s.provincia || "-"}
                                    </span>
                                  </td>
                                  <td className="px-2 py-1 break-all">
                                    {s.correo || "-"}
                                  </td>
                                  <td className="px-2 py-1">
                                    <span
                                      className="inline-block px-2 py-0.5 rounded-full"
                                      style={delegadoColor(s.centroRegional)}
                                    >
                                      {s.centroRegional || "Sin delegado"}
                                    </span>
                                  </td>
                                  <td className="px-2 py-1">
                                    {respAudioCentro || "-"}
                                  </td>
                                  <td className="px-2 py-1">
                                    {centroAARValor || "-"}
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    {visitasConExcel.length}
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    {checklistBadge}
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    {aplicaHitTienda || "-"}
                                  </td>
                                  <td className="px-2 py-1 text-center">
                                    <button
                                      className={`text-[10px] px-2 py-1 rounded-full border  ${
                                        isExpanded
                                          ? "border-red-600 bg-red-600 text-white"
                                          : "border-red-400 text-red-600 hover:bg-red-50"
                                      }`}
                                      style={{ cursor: "pointer" }}
                                      onClick={() =>
                                        setExpandedStoreId(
                                          isExpanded ? null : s.id
                                        )
                                      }
                                    >
                                      {isExpanded
                                        ? "Ocultar"
                                        : "Ver / a침adir visitas"}
                                    </button>
                                  </td>
                                </tr>

                                {isExpanded && (
                                  <tr className="bg-gray-50 border-b">
                                    <td colSpan={13} className="px-3 py-3">
                                      <div className="text-[11px]">
                                        <p className="font-semibold mb-2">
                                          Visitas y checklist adjunto (hasta 4)
                                           {s.centro || s.codigo}
                                        </p>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                                          {s.visitas.map((visit) => (
                                            <div
                                              key={visit.id}
                                              className="border rounded-xl p-2 bg-white"
                                            >
                                              <p className="font-semibold mb-1">
                                                Visita {visit.id}
                                              </p>
                                              <input
                                                type="text"
                                                placeholder="dd/mm/aaaa"
                                                className={`w-full border rounded px-2 py-1 mb-1 ${
                                                  visit.fecha &&
                                                  !isValidFecha(visit.fecha)
                                                    ? "border-red-500 bg-red-50"
                                                    : ""
                                                }`}
                                                value={visit.fecha}
                                                onChange={(e) =>
                                                  updateVisitField(
                                                    s.id,
                                                    visit.id,
                                                    "fecha",
                                                    e.target.value
                                                  )
                                                }
                                              />
                                              <select
                                                className="w-full border rounded px-2 py-1 mb-1"
                                                value={visit.responsable || ""}
                                                onChange={(e) =>
                                                  updateVisitField(
                                                    s.id,
                                                    visit.id,
                                                    "responsable",
                                                    e.target.value
                                                  )
                                                }
                                              >
                                                <option value="">
                                                  Resp. audio
                                                </option>
                                                <option value="Sonia">
                                                  Sonia
                                                </option>
                                                <option value="Ary Rojas">
                                                  Ary Rojas
                                                </option>
                                              </select>

                                              <label className="inline-flex items-center px-3 py-1 rounded-xl border cursor-pointer hover:bg-gray-50 mb-1">
                                                <span className="text-[11px] font-semibold">
                                                  Adjuntar Excel checklist
                                                </span>
                                                <input
                                                  type="file"
                                                  accept=".xlsx,.xls,.csv"
                                                  className="hidden"
                                                  onChange={(e) =>
                                                    handleChecklistFileChange(
                                                      s.id,
                                                      visit.id,
                                                      e
                                                    )
                                                  }
                                                />
                                              </label>
                                              <p className="text-[10px] text-gray-500 mb-1 truncate">
                                                {visit.excelName ||
                                                  "Sin archivo"}
                                              </p>

                                              <div className="grid grid-cols-3 gap-1 mt-1">
                                                <div>
                                                  <p className="text-[10px] mb-0.5">
                                                    Checklist % (F90)
                                                  </p>
                                                  <input
                                                    type="number"
                                                    min={0}
                                                    max={100}
                                                    className="w-full border rounded px-1 py-0.5"
                                                    value={
                                                      visit.checklist ?? ""
                                                    }
                                                    onChange={(e) => {
                                                      const val =
                                                        e.target.value;
                                                      const num =
                                                        val === ""
                                                          ? null
                                                          : Number(val);
                                                      updateVisitField(
                                                        s.id,
                                                        visit.id,
                                                        "checklist",
                                                        isNaN(num)
                                                          ? null
                                                          : num
                                                      );
                                                    }}
                                                  />
                                                </div>
                                                <div>
                                                  <p className="text-[10px] mb-0.5">
                                                    HIT
                                                  </p>
                                                  <select
                                                    className="w-full border rounded px-1 py-0.5"
                                                    value={visit.hit || ""}
                                                    onChange={(e) =>
                                                      updateVisitField(
                                                        s.id,
                                                        visit.id,
                                                        "hit",
                                                        e.target.value
                                                      )
                                                    }
                                                  >
                                                    <option value="">
                                                      -
                                                    </option>
                                                    <option value="S칤">
                                                      S칤
                                                    </option>
                                                    <option value="No">
                                                      No
                                                    </option>
                                                  </select>
                                                </div>
                                                <div>
                                                  <p className="text-[10px] mb-0.5">
                                                    Centro AAR
                                                  </p>
                                                  <select
                                                    className="w-full border rounded px-1 py-0.5"
                                                    value={
                                                      visit.centroAAR || ""
                                                    }
                                                    onChange={(e) =>
                                                      updateVisitField(
                                                        s.id,
                                                        visit.id,
                                                        "centroAAR",
                                                        e.target.value
                                                      )
                                                    }
                                                  >
                                                    <option value="">
                                                      -
                                                    </option>
                                                    <option value="S칤">
                                                      S칤
                                                    </option>
                                                    <option value="No">
                                                      No
                                                    </option>
                                                  </select>
                                                </div>
                                              </div>

                                              <p className="text-[10px] text-gray-500 mt-1">
                                                El Excel se lee de la hoja
                                                PROCESOS BASICOS / PROCESOS Y
                                                BASICOS: F90 = % checklist
                                                global, F = 0/1 para cada
                                                criterio.
                                              </p>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    </td>
                                  </tr>
                                )}
                              </React.Fragment>
                            );
                          })}
                        </tbody>
                      </table>

                      {/* KPIs globales */}
                      <div className="mt-4 text-[11px] text-gray-600 flex flex-wrap gap-3">
                        <span>
                          Total centros: <strong>{totalTiendas}</strong>
                        </span>
                        <span>
                          Centros con al menos 1 visita (Excel):{" "}
                          <strong>
                            {tiendasConVisita} (
                            {porcentajeTiendasVisitadas.toFixed(0)}%)
                          </strong>
                        </span>
                        <span>
                          Total visitas (Excels adjuntos):{" "}
                          <strong>{totalVisitas}</strong>
                        </span>
                        <span
                          className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${
                            checklistMediaGlobal !== null &&
                            checklistMediaGlobal >= 85
                              ? "bg-green-100 text-green-800"
                              : "bg-red-100 text-red-700"
                          }`}
                        >
                          <span className="w-2 h-2 rounded-full bg-current/70" />
                          <span>
                            Checklist medio global:{" "}
                            {checklistMediaGlobal !== null
                              ? `${checklistMediaGlobal.toFixed(0)}%`
                              : "-"}
                          </span>
                        </span>
                        <span
                          className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${
                            hitMediaGlobal !== null && hitMediaGlobal >= 85
                              ? "bg-green-100 text-green-800"
                              : "bg-red-100 text-red-700"
                          }`}
                        >
                          <span className="w-2 h-2 rounded-full bg-current/70" />
                          <span>
                            % aplicaci칩n HIT global:{" "}
                            {hitMediaGlobal !== null
                              ? `${hitMediaGlobal.toFixed(0)}%`
                              : "-"}
                          </span>
                        </span>
                      </div>
                    </div>
                  )}
                </div>
              </section>

              {/* CENTROS EXCLUSIVOS */}
              <section className="bg-white p-6 rounded-2xl shadow space-y-4">
                <div className="bg-yellow-50 border border-yellow-100 rounded-2xl px-4 py-3 flex flex-wrap gap-4 items-center justify-between">
                  <span className="text-sm">
                    N췈 centros exclusivos:{" "}
                    <strong>{exclusiveStores.length}</strong>
                  </span>
                  <span className="text-sm">
                    Ventas acumuladas:{" "}
                    <strong>
                      {exclusiveVentasTotal.toLocaleString("es-ES")}
                    </strong>
                  </span>
                  <span className="text-sm">
                    Objetivo acumulado:{" "}
                    <strong>
                      {exclusiveObjetivoTotal.toLocaleString("es-ES")}
                    </strong>
                  </span>
                  <span
                    className={`text-xs px-3 py-1 rounded-full font-semibold ${
                      exclusivePctTotal !== null && exclusivePctTotal >= 100
                        ? "bg-green-100 text-green-800"
                        : "bg-red-100 text-red-700"
                    }`}
                  >
                    % resultado acumulado a침o:{" "}
                    {exclusivePctTotal !== null
                      ? `${exclusivePctTotal.toFixed(0)}%`
                      : "-"}
                  </span>
                </div>

                {exclusiveStores.length === 0 ? (
                  <p className="text-xs text-gray-500">
                    A칰n no hay centros exclusivos identificados en el listado.
                    Se marcan como exclusivos los centros:
                    PAMPLONA C. Exclusivo, CC LOS VALLES, SANTIAGO DE
                    COMPOSTELA RUA DA ROSA, CC PLAZA DE LA ESTACION, REINA DE
                    MERCEDES, SANTANDER CC PE칌ACASTILLO, TORRELAVEGA CARREFOUR
                    CC, ZARAGOZA CALLE DELICIAS.
                  </p>
                ) : (
                  <div className="overflow-y-auto">
                    <table className="w-full text-[11px] border-collapse">
                      <thead>
                        <tr className="bg-yellow-50 border-b">
                          <th className="text-left px-2 py-2">Centro</th>
                          <th className="text-left px-2 py-2">Provincia</th>
                          <th className="text-left px-2 py-2">Delegado</th>
                          <th className="text-right px-2 py-2">
                            Ventas mensuales 
                          </th>
                          <th className="text-right px-2 py-2">
                            Objetivo mensual 
                          </th>
                          <th className="text-right px-2 py-2">% resultado</th>
                          <th className="text-center px-2 py-2">
                            Acciones, meses y derivaciones (+)
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {exclusiveRows.map(
                          ({ store: s, ventas, objetivo, pct }) => {
                            const isExpandedExclusive =
                              expandedExclusiveId === s.id;
                            const badgePct =
                              pct !== null ? (
                                <span
                                  className={`inline-block px-2 py-0.5 rounded-full ${
                                    pct >= 100
                                      ? "bg-green-100 text-green-800"
                                      : "bg-red-100 text-red-700"
                                  }`}
                                >
                                  {pct.toFixed(0)}%
                                </span>
                              ) : (
                                "-"
                              );
                            return (
                              <React.Fragment key={s.id}>
                                <tr className="border-b hover:bg-yellow-50/60 align-top">
                                  <td className="px-2 py-1 font-semibold">
                                    {s.centro || s.codigo}
                                  </td>
                                  <td className="px-2 py-1">
                                    <span
                                      className="inline-block px-2 py-0.5 rounded-full"
                                      style={delegadoColor(s.centroRegional)}
                                    >
                                      {s.provincia || "-"}
                                    </span>
                                  </td>
                                  <td className="px-2 py-1">
                                    <span
                                      className="inline-block px-2 py-0.5 rounded-full"
                                      style={delegadoColor(s.centroRegional)}
                                    >
                                      {s.centroRegional || "Sin delegado"}
                                    </span>
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    {ventas.toLocaleString("es-ES")}
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    {objetivo.toLocaleString("es-ES")}
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    {badgePct}
                                  </td>
                                  <td className="px-2 py-1 text-center">
                                    <button
                                      className={`text-[10px] px-3 py-1 rounded-full border ${
                                        isExpandedExclusive
                                          ? "border-red-600 bg-red-600 text-white"
                                          : "border-amber-500 text-amber-700 bg-white hover:bg-amber-50"
                                      }`}
                                      style={{ cursor: "pointer" }}
                                      onClick={() =>
                                        setExpandedExclusiveId(
                                          isExpandedExclusive ? null : s.id
                                        )
                                      }
                                    >
                                      {isExpandedExclusive
                                        ? "Ocultar"
                                        : "Ver / a침adir (+)"}
                                    </button>
                                  </td>
                                </tr>

                                {isExpandedExclusive && (
                                  <tr className="bg-yellow-50/60 border-b">
                                    <td colSpan={7} className="px-3 py-3">
                                      <div className="text-[11px] space-y-3">
                                        <p className="font-semibold">
                                          Detalle mensual y acciones 늩" "}
                                          {s.centro || s.codigo}
                                        </p>

                                        {/* MESES */}
                                        <div className="border rounded-xl bg-white px-3 py-2">
                                          <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                            {EXCLUSIVE_MONTHS.map(
                                              ({ key, label }) => {
                                                const rec =
                                                  (s.exclusiveMonths || {})[
                                                    key
                                                  ] || {};
                                                const v =
                                                  rec.sales !== undefined &&
                                                  rec.sales !== null
                                                    ? rec.sales
                                                    : "";
                                                const o =
                                                  rec.objetivo !==
                                                    undefined &&
                                                  rec.objetivo !== null
                                                    ? rec.objetivo
                                                    : "";
                                                const numV = Number(v) || 0;
                                                const numO = Number(o) || 0;
                                                const pctMes =
                                                  numO > 0
                                                    ? (numV / numO) * 100
                                                    : null;
                                                return (
                                                  <div
                                                    key={key}
                                                    className="flex items-center gap-2 mb-1"
                                                  >
                                                    <span className="w-24 text-[10px] text-gray-600">
                                                      {label}
                                                    </span>
                                                    <input
                                                      type="number"
                                                      className="w-24 border rounded px-1 py-0.5 text-right"
                                                      placeholder="Ventas"
                                                      value={v}
                                                      onChange={(e) =>
                                                        updateExclusiveMonth(
                                                          s.id,
                                                          key,
                                                          "sales",
                                                          e.target.value === ""
                                                            ? null
                                                            : Number(
                                                                e.target.value
                                                              )
                                                        )
                                                      }
                                                    />
                                                    <input
                                                      type="number"
                                                      className="w-24 border rounded px-1 py-0.5 text-right"
                                                      placeholder="Objetivo"
                                                      value={o}
                                                      onChange={(e) =>
                                                        updateExclusiveMonth(
                                                          s.id,
                                                          key,
                                                          "objetivo",
                                                          e.target.value === ""
                                                            ? null
                                                            : Number(
                                                                e.target.value
                                                              )
                                                        )
                                                      }
                                                    />
                                                    <span
                                                      className={`text-[10px] font-semibold ${
                                                        pctMes !== null &&
                                                        pctMes >= 100
                                                          ? "text-green-600"
                                                          : "text-red-600"
                                                      }`}
                                                    >
                                                      {pctMes !== null
                                                        ? `${pctMes.toFixed(
                                                            0
                                                          )}%`
                                                        : "-"}
                                                    </span>
                                                  </div>
                                                );
                                              }
                                            )}
                                          </div>
                                        </div>

                                        {/* ACCIONES */}
                                        <div className="border rounded-xl bg-white px-3 py-2">
                                          <div className="flex items-center justify-between mb-2">
                                            <p className="font-semibold">
                                              Acciones, fechas y derivaciones
                                            </p>
                                            <button
                                              className="text-[10px] px-2 py-1 rounded-full border border-amber-500 text-amber-700 hover:bg-amber-50"
                                              onClick={() =>
                                                addExclusiveAction(s.id)
                                              }
                                            >
                                              + A침adir acci칩n
                                            </button>
                                          </div>
                                          {(s.exclusiveActions || []).length ===
                                          0 ? (
                                            <p className="text-[10px] text-gray-500">
                                              A칰n no hay acciones registradas
                                              para este centro.
                                            </p>
                                          ) : (
                                            <table className="w-full text-[10px]">
                                              <thead>
                                                <tr className="border-b text-left">
                                                  <th className="px-1 py-1">
                                                    Acci칩n
                                                  </th>
                                                  <th className="px-1 py-1">
                                                    Fecha acci칩n
                                                  </th>
                                                  <th className="px-1 py-1">
                                                    Derivaciones
                                                  </th>
                                                  <th className="px-1 py-1">
                                                    Notas
                                                  </th>
                                                  <th className="px-1 py-1 text-center">
                                                    -
                                                  </th>
                                                </tr>
                                              </thead>
                                              <tbody>
                                                {(s.exclusiveActions || []).map(
                                                  (act) => (
                                                    <tr
                                                      key={act.id}
                                                      className="border-b align-top"
                                                    >
                                                      <td className="px-1 py-1">
                                                        <select
                                                          className="w-full border rounded px-1 py-0.5"
                                                          value={act.tipo || ""}
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              act.id,
                                                              "tipo",
                                                              e.target.value
                                                            )
                                                          }
                                                        >
                                                          <option value="">
                                                            Selecciona
                                                          </option>
                                                          {EXCLUSIVE_ACTION_OPTIONS.map(
                                                            (opt) => (
                                                              <option
                                                                key={opt}
                                                                value={opt}
                                                              >
                                                                {opt}
                                                              </option>
                                                            )
                                                          )}
                                                        </select>
                                                      </td>
                                                      <td className="px-1 py-1">
                                                        <input
                                                          type="date"
                                                          className="w-full border rounded px-1 py-0.5"
                                                          value={
                                                            act.fecha || ""
                                                          }
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              act.id,
                                                              "fecha",
                                                              e.target.value
                                                            )
                                                          }
                                                        />
                                                      </td>
                                                      <td className="px-1 py-1">
                                                        <input
                                                          type="number"
                                                          className="w-full border rounded px-1 py-0.5 text-right"
                                                          value={
                                                            act.derivaciones ||
                                                            ""
                                                          }
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              act.id,
                                                              "derivaciones",
                                                              e.target.value
                                                            )
                                                          }
                                                        />
                                                      </td>
                                                      <td className="px-1 py-1">
                                                        <input
                                                          type="text"
                                                          className="w-full border rounded px-1 py-0.5"
                                                          value={act.notas || ""}
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              act.id,
                                                              "notas",
                                                              e.target.value
                                                            )
                                                          }
                                                        />
                                                      </td>
                                                      <td className="px-1 py-1 text-center">
                                                        <button
                                                          className="text-red-500"
                                                          onClick={() =>
                                                            removeExclusiveAction(
                                                              s.id,
                                                              act.id
                                                            )
                                                          }
                                                        >
                                                          九
                                                        </button>
                                                      </td>
                                                    </tr>
                                                  )
                                                )}
                                              </tbody>
                                            </table>
                                          )}
                                        </div>
                                      </div>
                                    </td>
                                  </tr>
                                )}
                              </React.Fragment>
                            );
                          }
                        )}
                      </tbody>
                    </table>
                  </div>
                )}
              </section>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
